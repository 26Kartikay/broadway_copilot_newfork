services:
  app:
    image: node:22
    working_dir: /usr/src/app
    command:
      - /bin/bash
      - -lc
      - |
        set -Eeo pipefail  # Removed 'u' to allow undefined variables (npm might set some)

        log() { printf '%s\n' "$${*}"; }

        log "Installing dependencies..."
        log "This may take 2-5 minutes, especially for native dependencies like canvas..."
        log "Please be patient - npm install is running..."
        # Show npm output in real-time so user knows it's working
        if ! npm install --legacy-peer-deps --loglevel=info; then
          log "ERROR: npm install failed!"
          log "Check the output above for details."
          exit 1
        fi
        log "Dependencies installed successfully."

        log "Checking Postgres availability..."
        until node <<'NODE' >/dev/null 2>&1; do
        const net = require('net');
        const host = process.env.POSTGRES_HOST || 'db';
        const port = Number(process.env.POSTGRES_PORT || 5432);
        const socket = net.createConnection({ host, port }, () => {
          socket.end();
          process.exit(0);
        });
        const fail = () => process.exit(1);
        socket.on('error', fail);
        setTimeout(fail, 2000);
        NODE
          sleep 1
        done
        log "Postgres is ready."

        log "Generating Prisma client..."
        if ! npx prisma generate >/tmp/prisma-generate.log 2>&1; then
          log "Prisma generate failed:"
          cat /tmp/prisma-generate.log >&2
          exit 1
        fi
        rm -f /tmp/prisma-generate.log
        log "Prisma client ready."

        log "Ensuring vector extension exists..."
        # Create the vector extension using Prisma client
        npx ts-node scripts/createVectorExtension.ts >/dev/null 2>&1 || log "Note: Extension creation attempted (may already exist)"

        log "Pushing database schema..."
        # Use --skip-generate since we already generated above
        # Use --accept-data-loss to avoid prompts about data loss
        # Specify schema for db push
        if npx prisma db push --schema=functions/prisma/schema.prisma --skip-generate --accept-data-loss; then
          log "Database schema is in sync."
        else
          log "ERROR: Prisma db push failed!"
          log ""
          log "This usually means the database has an old/incompatible schema."
          log "The database volume needs to be reset."
          log ""
          log "To fix this, run:"
          log "  docker compose down -v"
          log "  docker compose up --build"
          log ""
          log "The -v flag removes the database volume, giving you a fresh start."
          exit 1
        fi

        log "Starting development server..."
        npm run dev
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-8080}
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      DATABASE_URL: postgresql://postgres:postgres@db:5432/broadway?schema=public
      REDIS_URL: redis://redis:6379
      SERVER_URL: ${SERVER_URL:-http://localhost:8080}
      ALLOW_LOCAL_EMBEDDING_GENERATION: "true"
      # Enable polling for file watching in Docker (works better on Windows/Mac)
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: 1000
    ports:
      - "${PORT:-8080}:8080"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - .:/usr/src/app
      - node_modules:/usr/src/app/node_modules
      - ./dist:/usr/src/app/dist
      - ./functions:/usr/src/app/functions

    # Enable better file watching in Docker
    stdin_open: true
    tty: true

  db:
    image: pgvector/pgvector:pg16-bookworm
    command:
      - postgres
      - -c
      - log_min_messages=fatal
      - -c
      - client_min_messages=warning
      - -c
      - log_connections=off
      - -c
      - log_disconnections=off
      - -c
      - log_statement=none
      - -c
      - log_error_verbosity=terse
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: broadway
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_v0_8_0:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8
    command:
      - redis-server
      - --loglevel
      - warning
    volumes:
      - redis_data:/data

  # Optional: ngrok for exposing local server (useful for mobile app testing)
  ngrok:
    image: ngrok/ngrok:latest
    profiles:
      - tunnel
    command:
      - http
      - --domain=${NGROK_DOMAIN}
      - app:8080
      - --log=stdout
      - --log-level=warn
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
      NGROK_DOMAIN: ${NGROK_DOMAIN:-}
    ports:
      - "4040:4040"

volumes:
  node_modules:
  dist:
  postgres_data_v0_8_0:
  redis_data:
