"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
require("dotenv/config");
require("./scheduler/dailyPromptScheduler");
const cors_1 = __importDefault(require("cors"));
const express_1 = __importDefault(require("express"));
const agent_1 = require("./agent");
const prisma_1 = require("./lib/prisma");
const redis_1 = require("./lib/redis");
const twilio_1 = require("./lib/twilio");
const auth_1 = require("./middleware/auth");
const errors_1 = require("./middleware/errors");
const rateLimiter_1 = require("./middleware/rateLimiter");
const whitelist_1 = require("./middleware/whitelist");
const constants_1 = require("./utils/constants");
const logger_1 = require("./utils/logger");
const paths_1 = require("./utils/paths");
const app = (0, express_1.default)();
app.set('trust proxy', true);
app.use((0, cors_1.default)({
    origin: [/http:\/\/localhost:\d+/, /http:\/\/127\.0\.0\.1:\d+/],
    credentials: true,
}));
app.use(express_1.default.urlencoded({ extended: false }));
app.use(express_1.default.json());
app.use('/uploads', express_1.default.static((0, paths_1.staticUploadsMount)()));
const getMessageKey = (id) => `message:${id}`;
const getUserActiveKey = (id) => `user_active:${id}`;
const getUserQueueKey = (id) => `user_queue:${id}`;
const getUserAbortChannel = (id) => `user_abort:${id}`;
app.post('/twilio/', auth_1.authenticateRequest, whitelist_1.whitelist, rateLimiter_1.rateLimiter, async (req, res, next) => {
    try {
        const webhookPayload = req.body;
        const { WaId: userId, MessageSid: messageId } = webhookPayload;
        if (!userId) {
            logger_1.logger.error({ payload: webhookPayload }, 'WaId is missing from Twilio webhook payload');
            return res.status(400).send('Error: WaId not found');
        }
        logger_1.logger.info({ userId, messageId }, 'Received incoming message');
        const mk = getMessageKey(messageId);
        if ((await redis_1.redis.exists(mk)) === 1) {
            logger_1.logger.debug({ messageId }, 'Message already processed, skipping');
            return res.status(200).end();
        }
        await redis_1.redis.hSet(mk, {
            userId,
            status: 'queued',
            createdAt: Date.now(),
        });
        await redis_1.redis.expire(mk, constants_1.MESSAGE_TTL_SECONDS);
        const uak = getUserActiveKey(userId);
        const currentActive = await redis_1.redis.get(uak);
        const currentStatus = currentActive
            ? await redis_1.redis.hGet(getMessageKey(currentActive), 'status')
            : null;
        if (currentActive && currentStatus === 'running') {
            await redis_1.redis.publish(getUserAbortChannel(userId), currentActive);
            logger_1.logger.info({ userId, abortedMessageId: currentActive }, 'Published abort signal for previous message processing');
        }
        if (currentStatus === 'sending') {
            const uqk = getUserQueueKey(userId);
            await redis_1.redis.rPush(uqk, JSON.stringify({ messageId, input: webhookPayload }));
            await redis_1.redis.expire(uqk, constants_1.USER_STATE_TTL_SECONDS);
            logger_1.logger.debug({ messageId, userId }, 'Queued message due to active sending');
            return res.status(200).end();
        }
        else {
            await redis_1.redis.set(uak, messageId, { EX: constants_1.USER_STATE_TTL_SECONDS });
            processMessage(userId, messageId, webhookPayload);
            return res.status(200).end();
        }
    }
    catch (err) {
        const messageId = req.body?.MessageSid;
        try {
            if (messageId) {
                const mk = getMessageKey(messageId);
                await redis_1.redis.hSet(mk, { status: 'failed' });
            }
        }
        catch (redisErr) {
            logger_1.logger.warn({
                messageId,
                err: redisErr instanceof Error ? redisErr.message : String(redisErr),
            }, 'Failed to set failed status for message');
        }
        return next(err);
    }
});
app.post('/twilio/callback/', auth_1.authenticateRequest, async (req, res, next) => {
    try {
        (0, twilio_1.processStatusCallback)(req.body || {});
        return res.status(200).end();
    }
    catch (err) {
        return next(err);
    }
});
app.use(errors_1.errorHandler);
async function processMessage(userId, messageId, input) {
    const mk = getMessageKey(messageId);
    try {
        await redis_1.redis.hSet(mk, { status: 'running' });
        await (0, agent_1.runAgent)(userId, messageId, input);
    }
    catch (err) {
        if (err instanceof Error && err.name === 'AbortError') {
            logger_1.logger.info({ userId, messageId }, 'Message processing aborted');
        }
        try {
            await redis_1.redis.hSet(mk, { status: 'failed' });
        }
        catch (redisErr) {
            logger_1.logger.error({
                redisErr: redisErr instanceof Error ? redisErr.message : String(redisErr),
                userId,
                messageId,
            }, 'Failed to update message status in Redis');
        }
    }
    finally {
        const uak = getUserActiveKey(userId);
        const activeMessageId = await redis_1.redis.get(uak);
        if (activeMessageId === messageId) {
            try {
                const uqk = getUserQueueKey(userId);
                const nextStr = await redis_1.redis.lPop(uqk);
                if (nextStr) {
                    const next = JSON.parse(nextStr);
                    await redis_1.redis.set(uak, next.messageId, {
                        EX: constants_1.USER_STATE_TTL_SECONDS,
                    });
                    processMessage(userId, next.messageId, next.input);
                }
                else {
                    await redis_1.redis.del(uak);
                }
            }
            catch (queueErr) {
                logger_1.logger.error({
                    userId,
                    messageId,
                    err: queueErr instanceof Error ? queueErr.message : String(queueErr),
                }, 'Failed to process message queue');
            }
        }
    }
}
void (async function bootstrap() {
    try {
        await (0, redis_1.connectRedis)();
        await (0, prisma_1.connectPrisma)();
        (0, agent_1.initializeAgent)();
        const PORT = Number(process.env.PORT || 8080);
        app.listen(PORT, '0.0.0.0', () => {
            logger_1.logger.info({ port: PORT }, 'Broadway WhatsApp Bot server started');
        });
    }
    catch (err) {
        logger_1.logger.error({
            err: err instanceof Error ? err.message : String(err),
            stack: err instanceof Error ? err.stack : undefined,
        }, 'Server bootstrap failed');
        process.exit(1);
    }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9pbmRleC50cyIsInNvdXJjZXMiOlsiL3Vzci9zcmMvYXBwL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHlCQUF1QjtBQUN2Qiw0Q0FBMEM7QUFDMUMsZ0RBQXdCO0FBQ3hCLHNEQUFtRTtBQUVuRSxtQ0FBb0Q7QUFDcEQseUNBQTZDO0FBQzdDLHVDQUFrRDtBQUNsRCx5Q0FBcUQ7QUFFckQsNENBQXdEO0FBQ3hELGdEQUFtRDtBQUNuRCwwREFBdUQ7QUFDdkQsc0RBQW1EO0FBQ25ELGlEQUFnRjtBQUNoRiwyQ0FBd0M7QUFDeEMseUNBQW1EO0FBRW5ELE1BQU0sR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO0FBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBRTdCLEdBQUcsQ0FBQyxHQUFHLENBQ0wsSUFBQSxjQUFJLEVBQUM7SUFDSCxNQUFNLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSwyQkFBMkIsQ0FBQztJQUMvRCxXQUFXLEVBQUUsSUFBSTtDQUNsQixDQUFDLENBQ0gsQ0FBQztBQUNGLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ2pELEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBRXhCLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGlCQUFPLENBQUMsTUFBTSxDQUFDLElBQUEsMEJBQWtCLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFFMUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7QUFDdEQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQztBQUM3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aW1wb3J0ICdkb3RlbnYvY29uZmlnJztcclxuaW1wb3J0ICcuL3NjaGVkdWxlci9kYWlseVByb21wdFNjaGVkdWxlcic7XHJcbmltcG9ydCBjb3JzIGZyb20gJ2NvcnMnO1xyXG5pbXBvcnQgZXhwcmVzcywgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcyc7XHJcblxyXG5pbXBvcnQgeyBpbml0aWFsaXplQWdlbnQsIHJ1bkFnZW50IH0gZnJvbSAnLi9hZ2VudCc7XHJcbmltcG9ydCB7IGNvbm5lY3RQcmlzbWEgfSBmcm9tICcuL2xpYi9wcmlzbWEnO1xyXG5pbXBvcnQgeyBjb25uZWN0UmVkaXMsIHJlZGlzIH0gZnJvbSAnLi9saWIvcmVkaXMnO1xyXG5pbXBvcnQgeyBwcm9jZXNzU3RhdHVzQ2FsbGJhY2sgfSBmcm9tICcuL2xpYi90d2lsaW8nO1xyXG5pbXBvcnQgeyBUd2lsaW9XZWJob29rUmVxdWVzdCB9IGZyb20gJy4vbGliL3R3aWxpby90eXBlcyc7XHJcbmltcG9ydCB7IGF1dGhlbnRpY2F0ZVJlcXVlc3QgfSBmcm9tICcuL21pZGRsZXdhcmUvYXV0aCc7XHJcbmltcG9ydCB7IGVycm9ySGFuZGxlciB9IGZyb20gJy4vbWlkZGxld2FyZS9lcnJvcnMnO1xyXG5pbXBvcnQgeyByYXRlTGltaXRlciB9IGZyb20gJy4vbWlkZGxld2FyZS9yYXRlTGltaXRlcic7XHJcbmltcG9ydCB7IHdoaXRlbGlzdCB9IGZyb20gJy4vbWlkZGxld2FyZS93aGl0ZWxpc3QnO1xyXG5pbXBvcnQgeyBNRVNTQUdFX1RUTF9TRUNPTkRTLCBVU0VSX1NUQVRFX1RUTF9TRUNPTkRTIH0gZnJvbSAnLi91dGlscy9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL3V0aWxzL2xvZ2dlcic7XHJcbmltcG9ydCB7IHN0YXRpY1VwbG9hZHNNb3VudCB9IGZyb20gJy4vdXRpbHMvcGF0aHMnO1xyXG5cclxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xyXG5hcHAuc2V0KCd0cnVzdCBwcm94eScsIHRydWUpO1xyXG5cclxuYXBwLnVzZShcclxuICBjb3JzKHtcclxuICAgIG9yaWdpbjogWy9odHRwOlxcL1xcL2xvY2FsaG9zdDpcXGQrLywgL2h0dHA6XFwvXFwvMTI3XFwuMFxcLjBcXC4xOlxcZCsvXSxcclxuICAgIGNyZWRlbnRpYWxzOiB0cnVlLFxyXG4gIH0pLFxyXG4pO1xyXG5hcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiBmYWxzZSB9KSk7XHJcbmFwcC51c2UoZXhwcmVzcy5qc29uKCkpO1xyXG5cclxuYXBwLnVzZSgnL3VwbG9hZHMnLCBleHByZXNzLnN0YXRpYyhzdGF0aWNVcGxvYWRzTW91bnQoKSkpO1xyXG5cclxuY29uc3QgZ2V0TWVzc2FnZUtleSA9IChpZDogc3RyaW5nKSA9PiBgbWVzc2FnZToke2lkfWA7XHJcbmNvbnN0IGdldFVzZXJBY3RpdmVLZXkgPSAoaWQ6IHN0cmluZykgPT4gYHVzZXJfYWN0aXZlOiR7aWR9YDtcclxuY29uc3QgZ2V0VXNlclF1ZXVlS2V5ID0gKGlkOiBzdHJpbmcpID0+IGB1c2VyX3F1ZXVlOiR7aWR9YDtcclxuY29uc3QgZ2V0VXNlckFib3J0Q2hhbm5lbCA9IChpZDogc3RyaW5nKSA9PiBgdXNlcl9hYm9ydDoke2lkfWA7XHJcblxyXG4vKipcclxuICogTWFpbiBUd2lsaW8gd2ViaG9vayBoYW5kbGVyIGZvciBpbmNvbWluZyBXaGF0c0FwcCBtZXNzYWdlcy5cclxuICogSGFuZGxlcyBtZXNzYWdlIHF1ZXVpbmcsIGR1cGxpY2F0ZSBkZXRlY3Rpb24sIGFuZCBjb25jdXJyZW5jeSBjb250cm9sLlxyXG4gKi9cclxuYXBwLnBvc3QoXHJcbiAgJy90d2lsaW8vJyxcclxuICBhdXRoZW50aWNhdGVSZXF1ZXN0LFxyXG4gIHdoaXRlbGlzdCxcclxuICByYXRlTGltaXRlcixcclxuICBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHdlYmhvb2tQYXlsb2FkID0gcmVxLmJvZHkgYXMgVHdpbGlvV2ViaG9va1JlcXVlc3Q7XHJcbiAgICAgIGNvbnN0IHsgV2FJZDogdXNlcklkLCBNZXNzYWdlU2lkOiBtZXNzYWdlSWQgfSA9IHdlYmhvb2tQYXlsb2FkO1xyXG5cclxuICAgICAgaWYgKCF1c2VySWQpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoeyBwYXlsb2FkOiB3ZWJob29rUGF5bG9hZCB9LCAnV2FJZCBpcyBtaXNzaW5nIGZyb20gVHdpbGlvIHdlYmhvb2sgcGF5bG9hZCcpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnRXJyb3I6IFdhSWQgbm90IGZvdW5kJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxvZ2dlci5pbmZvKHsgdXNlcklkLCBtZXNzYWdlSWQgfSwgJ1JlY2VpdmVkIGluY29taW5nIG1lc3NhZ2UnKTtcclxuXHJcbiAgICAgIGNvbnN0IG1rID0gZ2V0TWVzc2FnZUtleShtZXNzYWdlSWQpO1xyXG5cclxuICAgICAgaWYgKChhd2FpdCByZWRpcy5leGlzdHMobWspKSA9PT0gMSkge1xyXG4gICAgICAgIGxvZ2dlci5kZWJ1Zyh7IG1lc3NhZ2VJZCB9LCAnTWVzc2FnZSBhbHJlYWR5IHByb2Nlc3NlZCwgc2tpcHBpbmcnKTtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmVuZCgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBhd2FpdCByZWRpcy5oU2V0KG1rLCB7XHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHN0YXR1czogJ3F1ZXVlZCcsXHJcbiAgICAgICAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLFxyXG4gICAgICB9KTtcclxuICAgICAgYXdhaXQgcmVkaXMuZXhwaXJlKG1rLCBNRVNTQUdFX1RUTF9TRUNPTkRTKTtcclxuXHJcbiAgICAgIGNvbnN0IHVhayA9IGdldFVzZXJBY3RpdmVLZXkodXNlcklkKTtcclxuICAgICAgY29uc3QgY3VycmVudEFjdGl2ZSA9IGF3YWl0IHJlZGlzLmdldCh1YWspO1xyXG4gICAgICBjb25zdCBjdXJyZW50U3RhdHVzID0gY3VycmVudEFjdGl2ZVxyXG4gICAgICAgID8gYXdhaXQgcmVkaXMuaEdldChnZXRNZXNzYWdlS2V5KGN1cnJlbnRBY3RpdmUpLCAnc3RhdHVzJylcclxuICAgICAgICA6IG51bGw7XHJcblxyXG4gICAgICBpZiAoY3VycmVudEFjdGl2ZSAmJiBjdXJyZW50U3RhdHVzID09PSAncnVubmluZycpIHtcclxuICAgICAgICBhd2FpdCByZWRpcy5wdWJsaXNoKGdldFVzZXJBYm9ydENoYW5uZWwodXNlcklkKSwgY3VycmVudEFjdGl2ZSk7XHJcbiAgICAgICAgbG9nZ2VyLmluZm8oXHJcbiAgICAgICAgICB7IHVzZXJJZCwgYWJvcnRlZE1lc3NhZ2VJZDogY3VycmVudEFjdGl2ZSB9LFxyXG4gICAgICAgICAgJ1B1Ymxpc2hlZCBhYm9ydCBzaWduYWwgZm9yIHByZXZpb3VzIG1lc3NhZ2UgcHJvY2Vzc2luZycsXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGN1cnJlbnRTdGF0dXMgPT09ICdzZW5kaW5nJykge1xyXG4gICAgICAgIGNvbnN0IHVxayA9IGdldFVzZXJRdWV1ZUtleSh1c2VySWQpO1xyXG4gICAgICAgIGF3YWl0IHJlZGlzLnJQdXNoKHVxaywgSlNPTi5zdHJpbmdpZnkoeyBtZXNzYWdlSWQsIGlucHV0OiB3ZWJob29rUGF5bG9hZCB9KSk7XHJcbiAgICAgICAgYXdhaXQgcmVkaXMuZXhwaXJlKHVxaywgVVNFUl9TVEFURV9UVExfU0VDT05EUyk7XHJcbiAgICAgICAgbG9nZ2VyLmRlYnVnKHsgbWVzc2FnZUlkLCB1c2VySWQgfSwgJ1F1ZXVlZCBtZXNzYWdlIGR1ZSB0byBhY3RpdmUgc2VuZGluZycpO1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuZW5kKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXdhaXQgcmVkaXMuc2V0KHVhaywgbWVzc2FnZUlkLCB7IEVYOiBVU0VSX1NUQVRFX1RUTF9TRUNPTkRTIH0pO1xyXG4gICAgICAgIHByb2Nlc3NNZXNzYWdlKHVzZXJJZCwgbWVzc2FnZUlkLCB3ZWJob29rUGF5bG9hZCk7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5lbmQoKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2VJZCA9IChyZXEuYm9keSBhcyBUd2lsaW9XZWJob29rUmVxdWVzdCk/Lk1lc3NhZ2VTaWQ7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKG1lc3NhZ2VJZCkge1xyXG4gICAgICAgICAgY29uc3QgbWsgPSBnZXRNZXNzYWdlS2V5KG1lc3NhZ2VJZCk7XHJcbiAgICAgICAgICBhd2FpdCByZWRpcy5oU2V0KG1rLCB7IHN0YXR1czogJ2ZhaWxlZCcgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChyZWRpc0VycjogdW5rbm93bikge1xyXG4gICAgICAgIGxvZ2dlci53YXJuKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBtZXNzYWdlSWQsXHJcbiAgICAgICAgICAgIGVycjogcmVkaXNFcnIgaW5zdGFuY2VvZiBFcnJvciA/IHJlZGlzRXJyLm1lc3NhZ2UgOiBTdHJpbmcocmVkaXNFcnIpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICdGYWlsZWQgdG8gc2V0IGZhaWxlZCBzdGF0dXMgZm9yIG1lc3NhZ2UnLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG5leHQoZXJyKTtcclxuICAgIH1cclxuICB9LFxyXG4pO1xyXG5cclxuLyoqXHJcbiAqIFR3aWxpbyBjYWxsYmFjayBoYW5kbGVyIGZvciBtZXNzYWdlIGRlbGl2ZXJ5IHN0YXR1cyB1cGRhdGVzLlxyXG4gKi9cclxuYXBwLnBvc3QoXHJcbiAgJy90d2lsaW8vY2FsbGJhY2svJyxcclxuICBhdXRoZW50aWNhdGVSZXF1ZXN0LFxyXG4gIGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcHJvY2Vzc1N0YXR1c0NhbGxiYWNrKHJlcS5ib2R5IHx8IHt9KTtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5lbmQoKTtcclxuICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xyXG4gICAgICByZXR1cm4gbmV4dChlcnIpO1xyXG4gICAgfVxyXG4gIH0sXHJcbik7XHJcblxyXG5hcHAudXNlKGVycm9ySGFuZGxlcik7XHJcblxyXG4vKipcclxuICogUHJvY2Vzc2VzIGEgc2luZ2xlIG1lc3NhZ2UgdGhyb3VnaCB0aGUgYWdlbnQgZ3JhcGggd2l0aCBjb25jdXJyZW5jeSBjb250cm9sLlxyXG4gKiBNYW5hZ2VzIG1lc3NhZ2Ugc3RhdHVzLCBoYW5kbGVzIGFib3J0cywgYW5kIHByb2Nlc3NlcyBxdWV1ZWQgbWVzc2FnZXMuXHJcbiAqXHJcbiAqIEBwYXJhbSB1c2VySWQgLSBUaGUgV2hhdHNBcHAgdXNlciBJRFxyXG4gKiBAcGFyYW0gbWVzc2FnZUlkIC0gVGhlIFR3aWxpbyBtZXNzYWdlIFNJRFxyXG4gKiBAcGFyYW0gaW5wdXQgLSBUaGUgcmF3IFR3aWxpbyB3ZWJob29rIHBheWxvYWRcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NNZXNzYWdlKFxyXG4gIHVzZXJJZDogc3RyaW5nLFxyXG4gIG1lc3NhZ2VJZDogc3RyaW5nLFxyXG4gIGlucHV0OiBUd2lsaW9XZWJob29rUmVxdWVzdCxcclxuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgbWsgPSBnZXRNZXNzYWdlS2V5KG1lc3NhZ2VJZCk7XHJcblxyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCByZWRpcy5oU2V0KG1rLCB7IHN0YXR1czogJ3J1bm5pbmcnIH0pO1xyXG5cclxuICAgIGF3YWl0IHJ1bkFnZW50KHVzZXJJZCwgbWVzc2FnZUlkLCBpbnB1dCk7XHJcbiAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XHJcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyLm5hbWUgPT09ICdBYm9ydEVycm9yJykge1xyXG4gICAgICBsb2dnZXIuaW5mbyh7IHVzZXJJZCwgbWVzc2FnZUlkIH0sICdNZXNzYWdlIHByb2Nlc3NpbmcgYWJvcnRlZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHJlZGlzLmhTZXQobWssIHsgc3RhdHVzOiAnZmFpbGVkJyB9KTtcclxuICAgIH0gY2F0Y2ggKHJlZGlzRXJyOiB1bmtub3duKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICB7XHJcbiAgICAgICAgICByZWRpc0VycjogcmVkaXNFcnIgaW5zdGFuY2VvZiBFcnJvciA/IHJlZGlzRXJyLm1lc3NhZ2UgOiBTdHJpbmcocmVkaXNFcnIpLFxyXG4gICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgbWVzc2FnZUlkLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJ0ZhaWxlZCB0byB1cGRhdGUgbWVzc2FnZSBzdGF0dXMgaW4gUmVkaXMnLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH0gZmluYWxseSB7XHJcbiAgICBjb25zdCB1YWsgPSBnZXRVc2VyQWN0aXZlS2V5KHVzZXJJZCk7XHJcbiAgICBjb25zdCBhY3RpdmVNZXNzYWdlSWQgPSBhd2FpdCByZWRpcy5nZXQodWFrKTtcclxuXHJcbiAgICBpZiAoYWN0aXZlTWVzc2FnZUlkID09PSBtZXNzYWdlSWQpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB1cWsgPSBnZXRVc2VyUXVldWVLZXkodXNlcklkKTtcclxuICAgICAgICBjb25zdCBuZXh0U3RyID0gYXdhaXQgcmVkaXMubFBvcCh1cWspO1xyXG4gICAgICAgIGlmIChuZXh0U3RyKSB7XHJcbiAgICAgICAgICBjb25zdCBuZXh0ID0gSlNPTi5wYXJzZShuZXh0U3RyKTtcclxuICAgICAgICAgIGF3YWl0IHJlZGlzLnNldCh1YWssIG5leHQubWVzc2FnZUlkLCB7XHJcbiAgICAgICAgICAgIEVYOiBVU0VSX1NUQVRFX1RUTF9TRUNPTkRTLFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBwcm9jZXNzTWVzc2FnZSh1c2VySWQsIG5leHQubWVzc2FnZUlkLCBuZXh0LmlucHV0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXdhaXQgcmVkaXMuZGVsKHVhayk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChxdWV1ZUVycjogdW5rbm93bikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgICBtZXNzYWdlSWQsXHJcbiAgICAgICAgICAgIGVycjogcXVldWVFcnIgaW5zdGFuY2VvZiBFcnJvciA/IHF1ZXVlRXJyLm1lc3NhZ2UgOiBTdHJpbmcocXVldWVFcnIpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICdGYWlsZWQgdG8gcHJvY2VzcyBtZXNzYWdlIHF1ZXVlJyxcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQm9vdHN0cmFwIGZ1bmN0aW9uIHRvIGluaXRpYWxpemUgdGhlIHNlcnZlciBhbmQgY29ubmVjdCB0byBzZXJ2aWNlcy5cclxuICogU2V0cyB1cCBSZWRpcyBjb25uZWN0aW9uIGFuZCBzdGFydHMgdGhlIEV4cHJlc3Mgc2VydmVyLlxyXG4gKi9cclxudm9pZCAoYXN5bmMgZnVuY3Rpb24gYm9vdHN0cmFwKCkge1xyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCBjb25uZWN0UmVkaXMoKTtcclxuICAgIGF3YWl0IGNvbm5lY3RQcmlzbWEoKTtcclxuICAgIGluaXRpYWxpemVBZ2VudCgpO1xyXG4gICAgY29uc3QgUE9SVCA9IE51bWJlcihwcm9jZXNzLmVudi5QT1JUIHx8IDgwODApO1xyXG4gICAgYXBwLmxpc3RlbihQT1JULCAnMC4wLjAuMCcsICgpID0+IHtcclxuICAgICAgbG9nZ2VyLmluZm8oeyBwb3J0OiBQT1JUIH0sICdCcm9hZHdheSBXaGF0c0FwcCBCb3Qgc2VydmVyIHN0YXJ0ZWQnKTtcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICB7XHJcbiAgICAgICAgZXJyOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogU3RyaW5nKGVyciksXHJcbiAgICAgICAgc3RhY2s6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLnN0YWNrIDogdW5kZWZpbmVkLFxyXG4gICAgICB9LFxyXG4gICAgICAnU2VydmVyIGJvb3RzdHJhcCBmYWlsZWQnLFxyXG4gICAgKTtcclxuICAgIHByb2Nlc3MuZXhpdCgxKTtcclxuICB9XHJcbn0pKCk7XHJcbiJdfQ==