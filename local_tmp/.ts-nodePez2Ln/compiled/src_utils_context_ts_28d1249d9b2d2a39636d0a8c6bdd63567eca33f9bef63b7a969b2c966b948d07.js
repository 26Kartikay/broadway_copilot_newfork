"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getOrCreateUserAndConversation = getOrCreateUserAndConversation;
exports.numImagesInMessage = numImagesInMessage;
const client_1 = require("@prisma/client");
const prisma_1 = require("../lib/prisma");
const tasks_1 = require("../lib/tasks");
const logger_1 = require("./logger");
const CONVERSATION_TIMEOUT_MS = 30 * 60 * 1000;
async function handleStaleConversation(user, conversation) {
    logger_1.logger.debug({ userId: user.id, conversationId: conversation.id }, 'Stale conversation detected, closing and creating a new one.');
    const [, newConversation] = await prisma_1.prisma.$transaction([
        prisma_1.prisma.conversation.update({
            where: { id: conversation.id },
            data: { status: client_1.ConversationStatus.CLOSED },
        }),
        prisma_1.prisma.conversation.create({
            data: { userId: user.id },
        }),
    ]);
    (0, tasks_1.queueMemoryExtraction)(user.id, conversation.id);
    logger_1.logger.debug({ userId: user.id, conversationId: conversation.id }, 'Queued memory extraction for closed conversation.');
    return newConversation;
}
async function getOrCreateUserAndConversation(whatsappId, profileName) {
    const updateData = {};
    const user = await prisma_1.prisma.user.upsert({
        where: { whatsappId },
        update: updateData,
        create: {
            whatsappId,
            profileName,
        },
    });
    const lastOpenConversation = await prisma_1.prisma.conversation.findFirst({
        where: {
            userId: user.id,
            status: client_1.ConversationStatus.OPEN,
        },
        orderBy: { updatedAt: 'desc' },
    });
    if (lastOpenConversation) {
        const timeSinceLastUpdate = Date.now() - new Date(lastOpenConversation.updatedAt).getTime();
        if (timeSinceLastUpdate > CONVERSATION_TIMEOUT_MS) {
            return {
                user,
                conversation: await handleStaleConversation(user, lastOpenConversation),
            };
        }
        return { user, conversation: lastOpenConversation };
    }
    logger_1.logger.debug({ userId: user.id }, 'No open conversation found, creating a new one.');
    const newConversation = await prisma_1.prisma.conversation.create({
        data: { userId: user.id },
    });
    return { user, conversation: newConversation };
}
function numImagesInMessage(conversationHistoryWithImages) {
    if (!conversationHistoryWithImages || conversationHistoryWithImages.length === 0) {
        return 0;
    }
    const latestMessage = conversationHistoryWithImages.at(-1);
    if (!latestMessage || !latestMessage.content) {
        return 0;
    }
    if (!Array.isArray(latestMessage.content)) {
        return 0;
    }
    return latestMessage.content.filter((item) => item.type === 'image_url').length;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy91dGlscy9jb250ZXh0LnRzIiwic291cmNlcyI6WyIvdXNyL3NyYy9hcHAvc3JjL3V0aWxzL2NvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFxREEsd0VBc0NDO0FBU0QsZ0RBZUM7QUFuSEQsMkNBQWdGO0FBR2hGLDBDQUF1QztBQUN2Qyx3Q0FBcUQ7QUFDckQscUNBQWtDO0FBRWxDLE1BQU0sdUJBQXVCLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFTL0MsS0FBSyxVQUFVLHVCQUF1QixDQUNwQyxJQUFVLEVBQ1YsWUFBMEI7SUFFMUIsZUFBTSxDQUFDLEtBQUssQ0FDVixFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLGNBQWMsRUFBRSxZQUFZLENBQUMsRUFBRSxFQUFFLEVBQ3BELDhEQUE4RCxDQUMvRCxDQUFDO0lBRUYsTUFBTSxDQUFDLEVBQUUsZUFBZSxDQUFDLEdBQUcsTUFBTSxlQUFNLENBQUMsWUFBWSxDQUFDO1FBQ3BELGVBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1lBQ3pCLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxZQUFZLENBQUMsRUFBRSxFQUFFO1lBQzlCLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSwyQkFBa0IsQ0FBQyxNQUFNLEVBQUU7U0FDNUMsQ0FBQztRQUNGLGVBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1lBQ3pCLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQzFCLENBQUM7S0FDSCxDQUFDLENBQUM7SUFFSCxJQUFBLDZCQUFxQixFQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELGVBQU0sQ0FBQyxLQUFLLENBQ1YsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxjQUFjLEVBQUUsWUFBWSxDQUFDLEVBQUUsRUFBRSxFQUNwRCxtREFBbUQsQ0FDcEQsQ0FBQztJQUVGLE9BQU8sZUFBZSxDQUFDO0FBQ3pCLENBQUM7QUFXTSxLQUFLLFVBQVUsOEJBQThCLENBQ2xELFVBQWtCLEVBQ2xCLFdBQW1CO0lBRW5CLE1BQU0sVUFBVSxHQUEyQixFQUFFLENBQUM7SUFDOUMsTUFBTSxJQUFJLEdBQUcsTUFBTSxlQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNwQyxLQUFLLEVBQUUsRUFBRSxVQUFVLEVBQUU7UUFDckIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsTUFBTSxFQUFFO1lBQ04sVUFBVTtZQUNWLFdBQVc7U0FDWjtLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxlQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUMvRCxLQUFLLEVBQUU7WUFDTCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDZixNQUFNLEVBQUUsMkJBQWtCLENBQUMsSUFBSTtTQUNoQztRQUNELE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUU7S0FDL0IsQ0FBQyxDQUFDO0lBRUgsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1FBQ3pCLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzVGLElBQUksbUJBQW1CLEdBQUcsdUJBQXVCLEVBQUUsQ0FBQztZQUNsRCxPQUFPO2dCQUNMLElBQUk7Z0JBQ0osWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUMsSUFBSSxFQUFFLG9CQUFvQixDQUFDO2FBQ3hFLENBQUM7UUFDSixDQUFDO1FBQ0QsT0FBTyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBRUQsZUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsaURBQWlELENBQUMsQ0FBQztJQUNyRixNQUFNLGVBQWUsR0FBRyxNQUFNLGVBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQ3ZELElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQzFCLENBQUMsQ0FBQztJQUNILE9BQU8sRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxDQUFDO0FBQ2pELENBQUM7QUFTRCxTQUFnQixrQkFBa0IsQ0FBQyw2QkFBNEM7SUFDN0UsSUFBSSxDQUFDLDZCQUE2QixJQUFJLDZCQUE2QixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNqRixPQUFPLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFRCxNQUFNLGFBQWEsR0FBRyw2QkFBNkIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMzRCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzdDLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELE9BQU8sYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQ2xGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb252ZXJzYXRpb24sIENvbnZlcnNhdGlvblN0YXR1cywgUHJpc21hLCBVc2VyIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuXG5pbXBvcnQgeyBCYXNlTWVzc2FnZSB9IGZyb20gJy4uL2xpYi9haS9jb3JlL21lc3NhZ2VzJztcbmltcG9ydCB7IHByaXNtYSB9IGZyb20gJy4uL2xpYi9wcmlzbWEnO1xuaW1wb3J0IHsgcXVldWVNZW1vcnlFeHRyYWN0aW9uIH0gZnJvbSAnLi4vbGliL3Rhc2tzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgQ09OVkVSU0FUSU9OX1RJTUVPVVRfTVMgPSAzMCAqIDYwICogMTAwMDsgLy8gMzAgbWludXRlc1xuXG4vKipcbiAqIEhhbmRsZXMgYSBzdGFsZSBjb252ZXJzYXRpb24gYnkgY2xvc2luZyBpdCBhbmQgY3JlYXRpbmcgYSBuZXcgb25lLlxuICpcbiAqIEBwYXJhbSB1c2VyIC0gVGhlIHVzZXIgZm9yIHdob20gdG8gaGFuZGxlIHRoZSBzdGFsZSBjb252ZXJzYXRpb24uXG4gKiBAcGFyYW0gY29udmVyc2F0aW9uIC0gVGhlIHN0YWxlIGNvbnZlcnNhdGlvbiB0byBjbG9zZS5cbiAqIEByZXR1cm5zIFRoZSBuZXcgY29udmVyc2F0aW9uLlxuICovXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVTdGFsZUNvbnZlcnNhdGlvbihcbiAgdXNlcjogVXNlcixcbiAgY29udmVyc2F0aW9uOiBDb252ZXJzYXRpb24sXG4pOiBQcm9taXNlPENvbnZlcnNhdGlvbj4ge1xuICBsb2dnZXIuZGVidWcoXG4gICAgeyB1c2VySWQ6IHVzZXIuaWQsIGNvbnZlcnNhdGlvbklkOiBjb252ZXJzYXRpb24uaWQgfSxcbiAgICAnU3RhbGUgY29udmVyc2F0aW9uIGRldGVjdGVkLCBjbG9zaW5nIGFuZCBjcmVhdGluZyBhIG5ldyBvbmUuJyxcbiAgKTtcblxuICBjb25zdCBbLCBuZXdDb252ZXJzYXRpb25dID0gYXdhaXQgcHJpc21hLiR0cmFuc2FjdGlvbihbXG4gICAgcHJpc21hLmNvbnZlcnNhdGlvbi51cGRhdGUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IGNvbnZlcnNhdGlvbi5pZCB9LFxuICAgICAgZGF0YTogeyBzdGF0dXM6IENvbnZlcnNhdGlvblN0YXR1cy5DTE9TRUQgfSxcbiAgICB9KSxcbiAgICBwcmlzbWEuY29udmVyc2F0aW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7IHVzZXJJZDogdXNlci5pZCB9LFxuICAgIH0pLFxuICBdKTtcblxuICBxdWV1ZU1lbW9yeUV4dHJhY3Rpb24odXNlci5pZCwgY29udmVyc2F0aW9uLmlkKTtcbiAgbG9nZ2VyLmRlYnVnKFxuICAgIHsgdXNlcklkOiB1c2VyLmlkLCBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkIH0sXG4gICAgJ1F1ZXVlZCBtZW1vcnkgZXh0cmFjdGlvbiBmb3IgY2xvc2VkIGNvbnZlcnNhdGlvbi4nLFxuICApO1xuXG4gIHJldHVybiBuZXdDb252ZXJzYXRpb247XG59XG5cbi8qKlxuICogUmV0cmlldmVzIG9yIGNyZWF0ZXMgYSB1c2VyIGFuZCB0aGVpciBhY3RpdmUgY29udmVyc2F0aW9uLlxuICogVGhpcyBmdW5jdGlvbiBoYW5kbGVzIHVzZXIgbG9va3VwL2NyZWF0aW9uLCBmaW5kcyB0aGUgbGFzdCBvcGVuIGNvbnZlcnNhdGlvbixcbiAqIGNsb3NlcyBzdGFsZSBjb252ZXJzYXRpb25zLCBhbmQgY3JlYXRlcyBuZXcgb25lcyBpZiBuZWVkZWQuXG4gKlxuICogQHBhcmFtIHdoYXRzYXBwSWQgLSBUaGUgdXNlcidzIFdoYXRzQXBwIElELlxuICogQHBhcmFtIHByb2ZpbGVOYW1lIC0gVGhlIHVzZXIncyBwcm9maWxlIG5hbWUuXG4gKiBAcmV0dXJucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgdXNlciBhbmQgdGhlaXIgYWN0aXZlIGNvbnZlcnNhdGlvbi5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE9yQ3JlYXRlVXNlckFuZENvbnZlcnNhdGlvbihcbiAgd2hhdHNhcHBJZDogc3RyaW5nLFxuICBwcm9maWxlTmFtZTogc3RyaW5nLFxuKTogUHJvbWlzZTx7IHVzZXI6IFVzZXI7IGNvbnZlcnNhdGlvbjogQ29udmVyc2F0aW9uIH0+IHtcbiAgY29uc3QgdXBkYXRlRGF0YTogUHJpc21hLlVzZXJVcGRhdGVJbnB1dCA9IHt9O1xuICBjb25zdCB1c2VyID0gYXdhaXQgcHJpc21hLnVzZXIudXBzZXJ0KHtcbiAgICB3aGVyZTogeyB3aGF0c2FwcElkIH0sXG4gICAgdXBkYXRlOiB1cGRhdGVEYXRhLFxuICAgIGNyZWF0ZToge1xuICAgICAgd2hhdHNhcHBJZCxcbiAgICAgIHByb2ZpbGVOYW1lLFxuICAgIH0sXG4gIH0pO1xuXG4gIGNvbnN0IGxhc3RPcGVuQ29udmVyc2F0aW9uID0gYXdhaXQgcHJpc21hLmNvbnZlcnNhdGlvbi5maW5kRmlyc3Qoe1xuICAgIHdoZXJlOiB7XG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICBzdGF0dXM6IENvbnZlcnNhdGlvblN0YXR1cy5PUEVOLFxuICAgIH0sXG4gICAgb3JkZXJCeTogeyB1cGRhdGVkQXQ6ICdkZXNjJyB9LFxuICB9KTtcblxuICBpZiAobGFzdE9wZW5Db252ZXJzYXRpb24pIHtcbiAgICBjb25zdCB0aW1lU2luY2VMYXN0VXBkYXRlID0gRGF0ZS5ub3coKSAtIG5ldyBEYXRlKGxhc3RPcGVuQ29udmVyc2F0aW9uLnVwZGF0ZWRBdCkuZ2V0VGltZSgpO1xuICAgIGlmICh0aW1lU2luY2VMYXN0VXBkYXRlID4gQ09OVkVSU0FUSU9OX1RJTUVPVVRfTVMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVzZXIsXG4gICAgICAgIGNvbnZlcnNhdGlvbjogYXdhaXQgaGFuZGxlU3RhbGVDb252ZXJzYXRpb24odXNlciwgbGFzdE9wZW5Db252ZXJzYXRpb24pLFxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHsgdXNlciwgY29udmVyc2F0aW9uOiBsYXN0T3BlbkNvbnZlcnNhdGlvbiB9O1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKHsgdXNlcklkOiB1c2VyLmlkIH0sICdObyBvcGVuIGNvbnZlcnNhdGlvbiBmb3VuZCwgY3JlYXRpbmcgYSBuZXcgb25lLicpO1xuICBjb25zdCBuZXdDb252ZXJzYXRpb24gPSBhd2FpdCBwcmlzbWEuY29udmVyc2F0aW9uLmNyZWF0ZSh7XG4gICAgZGF0YTogeyB1c2VySWQ6IHVzZXIuaWQgfSxcbiAgfSk7XG4gIHJldHVybiB7IHVzZXIsIGNvbnZlcnNhdGlvbjogbmV3Q29udmVyc2F0aW9uIH07XG59XG5cbi8qKlxuICogQ291bnRzIHRoZSBudW1iZXIgb2YgaW1hZ2UgYXR0YWNobWVudHMgaW4gdGhlIG1vc3QgcmVjZW50IG1lc3NhZ2UuXG4gKiBVc2VkIHRvIGRldGVybWluZSBpZiBpbWFnZSBwcm9jZXNzaW5nIGZlYXR1cmVzIHNob3VsZCBiZSB0cmlnZ2VyZWQuXG4gKlxuICogQHBhcmFtIGNvbnZlcnNhdGlvbkhpc3RvcnlXaXRoSW1hZ2VzIC0gQXJyYXkgb2YgY29udmVyc2F0aW9uIG1lc3NhZ2VzIHdpdGggaW1hZ2UgZGF0YVxuICogQHJldHVybnMgTnVtYmVyIG9mIGltYWdlIFVSTHMgaW4gdGhlIGxhdGVzdCBtZXNzYWdlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBudW1JbWFnZXNJbk1lc3NhZ2UoY29udmVyc2F0aW9uSGlzdG9yeVdpdGhJbWFnZXM6IEJhc2VNZXNzYWdlW10pOiBudW1iZXIge1xuICBpZiAoIWNvbnZlcnNhdGlvbkhpc3RvcnlXaXRoSW1hZ2VzIHx8IGNvbnZlcnNhdGlvbkhpc3RvcnlXaXRoSW1hZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiAwO1xuICB9XG5cbiAgY29uc3QgbGF0ZXN0TWVzc2FnZSA9IGNvbnZlcnNhdGlvbkhpc3RvcnlXaXRoSW1hZ2VzLmF0KC0xKTtcbiAgaWYgKCFsYXRlc3RNZXNzYWdlIHx8ICFsYXRlc3RNZXNzYWdlLmNvbnRlbnQpIHtcbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGlmICghQXJyYXkuaXNBcnJheShsYXRlc3RNZXNzYWdlLmNvbnRlbnQpKSB7XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICByZXR1cm4gbGF0ZXN0TWVzc2FnZS5jb250ZW50LmZpbHRlcigoaXRlbSkgPT4gaXRlbS50eXBlID09PSAnaW1hZ2VfdXJsJykubGVuZ3RoO1xufVxuIl19