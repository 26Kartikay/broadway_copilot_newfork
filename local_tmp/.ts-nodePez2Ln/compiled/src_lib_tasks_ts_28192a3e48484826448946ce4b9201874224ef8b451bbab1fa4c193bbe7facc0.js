"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.queueWardrobeIndex = queueWardrobeIndex;
exports.queueMemoryExtraction = queueMemoryExtraction;
exports.queueImageUpload = queueImageUpload;
exports.queueFeedbackRequest = queueFeedbackRequest;
require("dotenv/config");
const tasks_1 = require("@google-cloud/tasks");
const cuid2_1 = require("@paralleldrive/cuid2");
const client_1 = require("@prisma/client");
const errors_1 = require("../utils/errors");
const logger_1 = require("../utils/logger");
const prisma_1 = require("./prisma");
const client = new tasks_1.CloudTasksClient();
const PROJECT_ID = process.env.PROJECT_ID || 'broadway-chatbot';
const CLOUD_FUNCTION_REGION = process.env.CLOUD_FUNCTION_REGION || 'asia-south2';
const CLOUD_TASKS_REGION = process.env.CLOUD_TASKS_REGION || 'asia-south1';
const WARDROBE_FUNCTION_URL = `https://${CLOUD_FUNCTION_REGION}-${PROJECT_ID}.cloudfunctions.net/indexWardrobe`;
const MEMORY_FUNCTION_URL = `https://${CLOUD_FUNCTION_REGION}-${PROJECT_ID}.cloudfunctions.net/storeMemories`;
const IMAGE_UPLOAD_FUNCTION_URL = `https://${CLOUD_FUNCTION_REGION}-${PROJECT_ID}.cloudfunctions.net/imageUpload`;
const FEEDBACK_FUNCTION_URL = `https://${CLOUD_FUNCTION_REGION}-${PROJECT_ID}.cloudfunctions.net/sendFeedbackRequest`;
const SERVICE_ACCOUNT_EMAIL = process.env.CLOUD_TASKS_SERVICE_ACCOUNT;
async function queueTask(queueName, functionUrl, payload, taskType, options = {}) {
    if (!PROJECT_ID || !functionUrl) {
        throw new errors_1.InternalServerError('Missing required environment variables for Cloud Tasks');
    }
    const parent = client.queuePath(PROJECT_ID, CLOUD_TASKS_REGION, queueName);
    const taskId = (0, cuid2_1.createId)();
    const taskName = `${parent}/tasks/${taskId}`;
    const task = {
        httpRequest: {
            httpMethod: 'POST',
            url: functionUrl,
            body: Buffer.from(JSON.stringify(payload)),
            headers: { 'Content-Type': 'application/json' },
            ...(SERVICE_ACCOUNT_EMAIL && {
                oidcToken: {
                    serviceAccountEmail: SERVICE_ACCOUNT_EMAIL,
                    audience: functionUrl,
                },
            }),
        },
        name: taskName,
    };
    if (options.scheduleTime) {
        const milliseconds = options.scheduleTime.getTime();
        task.scheduleTime = {
            seconds: Math.floor(milliseconds / 1000),
            nanos: (milliseconds % 1000) * 1_000_000,
        };
    }
    const [response] = await client.createTask({ parent, task });
    logger_1.logger.info({ taskName: response.name, type: taskType }, `Queued ${taskType} task`);
    const runAt = options.scheduleTime ?? new Date();
    await prisma_1.prisma.task.create({
        data: {
            taskId: taskId,
            userId: payload.userId,
            type: taskType,
            payload,
            runAt,
        },
    });
}
function runTaskInBackground(taskType, runner) {
    setImmediate(() => {
        runner().catch((err) => {
            logger_1.logger.error({ err: err instanceof Error ? err.message : String(err), type: taskType }, `Failed to queue ${taskType} task`);
        });
    });
}
function queueWardrobeIndex(userId, messageId) {
    if (process.env.NODE_ENV === 'development') {
        logger_1.logger.debug({ userId, messageId }, 'Skipping wardrobe index queueing in development');
        return;
    }
    runTaskInBackground(client_1.TaskType.SCHEDULE_WARDROBE_INDEX, () => queueTask('wardrobe-index', WARDROBE_FUNCTION_URL, { userId, messageId }, client_1.TaskType.SCHEDULE_WARDROBE_INDEX));
}
function queueMemoryExtraction(userId, conversationId) {
    if (process.env.NODE_ENV === 'development') {
        logger_1.logger.debug({ userId, conversationId }, 'Skipping memory extraction queueing in development');
        return;
    }
    runTaskInBackground(client_1.TaskType.PROCESS_MEMORIES, () => queueTask('memory-extraction', MEMORY_FUNCTION_URL, { userId, conversationId }, client_1.TaskType.PROCESS_MEMORIES));
}
function queueImageUpload(userId, messageId) {
    if (process.env.NODE_ENV === 'development') {
        logger_1.logger.debug({ userId, messageId }, 'Skipping image upload queueing in development');
        return;
    }
    runTaskInBackground(client_1.TaskType.UPLOAD_IMAGES, () => queueTask('image-upload', IMAGE_UPLOAD_FUNCTION_URL, { userId, messageId }, client_1.TaskType.UPLOAD_IMAGES));
}
function queueFeedbackRequest(userId, conversationId) {
    if (process.env.NODE_ENV === 'development') {
        logger_1.logger.debug({ userId, conversationId }, 'Skipping feedback request queueing in development');
        return;
    }
    const delayMs = Number(process.env.FEEDBACK_REQUEST_DELAY_MS || 60_000);
    const scheduleTime = new Date(Date.now() + delayMs);
    runTaskInBackground(client_1.TaskType.SEND_FEEDBACK_REQUEST, () => queueTask('feedback-request', FEEDBACK_FUNCTION_URL, { userId, conversationId }, client_1.TaskType.SEND_FEEDBACK_REQUEST, { scheduleTime }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9saWIvdGFza3MudHMiLCJzb3VyY2VzIjpbIi91c3Ivc3JjL2FwcC9zcmMvbGliL3Rhc2tzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBeUdBLGdEQWNDO0FBTUQsc0RBY0M7QUFPRCw0Q0FjQztBQUVELG9EQWtCQztBQXBMRCx5QkFBdUI7QUFFdkIsK0NBQW9FO0FBQ3BFLGdEQUF3RDtBQUN4RCwyQ0FBMEM7QUFDMUMsNENBQXNEO0FBQ3RELDRDQUF5QztBQUN6QyxxQ0FBa0M7QUFPbEMsTUFBTSxNQUFNLEdBQUcsSUFBSSx3QkFBZ0IsRUFBRSxDQUFDO0FBRXRDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLGtCQUFrQixDQUFDO0FBQ2hFLE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxhQUFhLENBQUM7QUFDakYsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLGFBQWEsQ0FBQztBQUUzRSxNQUFNLHFCQUFxQixHQUFHLFdBQVcscUJBQXFCLElBQUksVUFBVSxtQ0FBbUMsQ0FBQztBQUNoSCxNQUFNLG1CQUFtQixHQUFHLFdBQVcscUJBQXFCLElBQUksVUFBVSxtQ0FBbUMsQ0FBQztBQUM5RyxNQUFNLHlCQUF5QixHQUFHLFdBQVcscUJBQXFCLElBQUksVUFBVSxpQ0FBaUMsQ0FBQztBQUNsSCxNQUFNLHFCQUFxQixHQUFHLFdBQVcscUJBQXFCLElBQUksVUFBVSx5Q0FBeUMsQ0FBQztBQUV0SCxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUM7QUFVdEUsS0FBSyxVQUFVLFNBQVMsQ0FDdEIsU0FBaUIsRUFDakIsV0FBbUIsRUFDbkIsT0FBb0IsRUFDcEIsUUFBa0IsRUFDbEIsVUFBbUMsRUFBRTtJQUVyQyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsV0FBVyxF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c0I7SUFDekUsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLEVBQUUsQ0FBQztRQUMzQyxlQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxFQUFFLG1EQUFtRCxDQUFDLENBQUM7UUFDOUYsT0FBTztJQUNULENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsSUFBSSxNQUFNLENBQUMsQ0FBQztJQUN4RSxNQUFNLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUM7SUFFcEQsbUJBQW1CLENBQUMsaUJBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUUsQ0FDdkQsU0FBUyxDQUNQLGtCQUFrQixFQUNsQixxQkFBcUIsRUFDckIsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLEVBQzFCLGlCQUFRLENBQUMscUJBQXFCLEVBQzlCLEVBQUUsWUFBWSxFQUFFLENBQ2pCLENBQ0YsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2RvdGVudi9jb25maWcnO1xuXG5pbXBvcnQgeyBDbG91ZFRhc2tzQ2xpZW50LCB0eXBlIHByb3RvcyB9IGZyb20gJ0Bnb29nbGUtY2xvdWQvdGFza3MnO1xuaW1wb3J0IHsgY3JlYXRlSWQgYXMgY3VpZCB9IGZyb20gJ0BwYXJhbGxlbGRyaXZlL2N1aWQyJztcbmltcG9ydCB7IFRhc2tUeXBlIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgSW50ZXJuYWxTZXJ2ZXJFcnJvciB9IGZyb20gJy4uL3V0aWxzL2Vycm9ycyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi9wcmlzbWEnO1xuXG50eXBlIFRhc2tQYXlsb2FkID0ge1xuICB1c2VySWQ6IHN0cmluZztcbiAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xufTtcblxuY29uc3QgY2xpZW50ID0gbmV3IENsb3VkVGFza3NDbGllbnQoKTtcblxuY29uc3QgUFJPSkVDVF9JRCA9IHByb2Nlc3MuZW52LlBST0pFQ1RfSUQgfHwgJ2Jyb2Fkd2F5LWNoYXRib3QnO1xuY29uc3QgQ0xPVURfRlVOQ1RJT05fUkVHSU9OID0gcHJvY2Vzcy5lbnYuQ0xPVURfRlVOQ1RJT05fUkVHSU9OIHx8ICdhc2lhLXNvdXRoMic7XG5jb25zdCBDTE9VRF9UQVNLU19SRUdJT04gPSBwcm9jZXNzLmVudi5DTE9VRF9UQVNLU19SRUdJT04gfHwgJ2FzaWEtc291dGgxJztcblxuY29uc3QgV0FSRFJPQkVfRlVOQ1RJT05fVVJMID0gYGh0dHBzOi8vJHtDTE9VRF9GVU5DVElPTl9SRUdJT059LSR7UFJPSkVDVF9JRH0uY2xvdWRmdW5jdGlvbnMubmV0L2luZGV4V2FyZHJvYmVgO1xuY29uc3QgTUVNT1JZX0ZVTkNUSU9OX1VSTCA9IGBodHRwczovLyR7Q0xPVURfRlVOQ1RJT05fUkVHSU9OfS0ke1BST0pFQ1RfSUR9LmNsb3VkZnVuY3Rpb25zLm5ldC9zdG9yZU1lbW9yaWVzYDtcbmNvbnN0IElNQUdFX1VQTE9BRF9GVU5DVElPTl9VUkwgPSBgaHR0cHM6Ly8ke0NMT1VEX0ZVTkNUSU9OX1JFR0lPTn0tJHtQUk9KRUNUX0lEfS5jbG91ZGZ1bmN0aW9ucy5uZXQvaW1hZ2VVcGxvYWRgO1xuY29uc3QgRkVFREJBQ0tfRlVOQ1RJT05fVVJMID0gYGh0dHBzOi8vJHtDTE9VRF9GVU5DVElPTl9SRUdJT059LSR7UFJPSkVDVF9JRH0uY2xvdWRmdW5jdGlvbnMubmV0L3NlbmRGZWVkYmFja1JlcXVlc3RgO1xuXG5jb25zdCBTRVJWSUNFX0FDQ09VTlRfRU1BSUwgPSBwcm9jZXNzLmVudi5DTE9VRF9UQVNLU19TRVJWSUNFX0FDQ09VTlQ7XG5cbi8qKlxuICogQSBnZW5lcmljIHRhc2sgcXVldWluZyBmdW5jdGlvbi5cbiAqIEBwYXJhbSBxdWV1ZU5hbWUgVGhlIG5hbWUgb2YgdGhlIENsb3VkIFRhc2tzIHF1ZXVlLlxuICogQHBhcmFtIGZ1bmN0aW9uVXJsIFRoZSBVUkwgb2YgdGhlIENsb3VkIEZ1bmN0aW9uIHRvIGludm9rZS5cbiAqIEBwYXJhbSBwYXlsb2FkIFRoZSBwYXlsb2FkIHRvIHNlbmQgdG8gdGhlIENsb3VkIEZ1bmN0aW9uLlxuICogQHBhcmFtIHRhc2tUeXBlIFRoZSB0eXBlIG9mIHRoZSB0YXNrIHRvIHJlY29yZCBpbiB0aGUgZGF0YWJhc2UuXG4gKi9cblxuYXN5bmMgZnVuY3Rpb24gcXVldWVUYXNrKFxuICBxdWV1ZU5hbWU6IHN0cmluZyxcbiAgZnVuY3Rpb25Vcmw6IHN0cmluZyxcbiAgcGF5bG9hZDogVGFza1BheWxvYWQsXG4gIHRhc2tUeXBlOiBUYXNrVHlwZSxcbiAgb3B0aW9uczogeyBzY2hlZHVsZVRpbWU/OiBEYXRlIH0gPSB7fSxcbik6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoIVBST0pFQ1RfSUQgfHwgIWZ1bmN0aW9uVXJsKSB7XG4gICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGZvciBDbG91ZCBUYXNrcycpO1xuICB9XG5cbiAgY29uc3QgcGFyZW50ID0gY2xpZW50LnF1ZXVlUGF0aChQUk9KRUNUX0lELCBDTE9VRF9UQVNLU19SRUdJT04sIHF1ZXVlTmFtZSk7XG4gIGNvbnN0IHRhc2tJZCA9IGN1aWQoKTtcbiAgY29uc3QgdGFza05hbWUgPSBgJHtwYXJlbnR9L3Rhc2tzLyR7dGFza0lkfWA7XG5cbiAgY29uc3QgdGFzazogcHJvdG9zLmdvb2dsZS5jbG91ZC50YXNrcy52Mi5JVGFzayA9IHtcbiAgICBodHRwUmVxdWVzdDoge1xuICAgICAgaHR0cE1ldGhvZDogJ1BPU1QnIGFzIGNvbnN0LFxuICAgICAgdXJsOiBmdW5jdGlvblVybCxcbiAgICAgIGJvZHk6IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKSxcbiAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgLi4uKFNFUlZJQ0VfQUNDT1VOVF9FTUFJTCAmJiB7XG4gICAgICAgIG9pZGNUb2tlbjoge1xuICAgICAgICAgIHNlcnZpY2VBY2NvdW50RW1haWw6IFNFUlZJQ0VfQUNDT1VOVF9FTUFJTCxcbiAgICAgICAgICBhdWRpZW5jZTogZnVuY3Rpb25VcmwsXG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICB9LFxuICAgIG5hbWU6IHRhc2tOYW1lLFxuICB9O1xuXG4gIGlmIChvcHRpb25zLnNjaGVkdWxlVGltZSkge1xuICAgIGNvbnN0IG1pbGxpc2Vjb25kcyA9IG9wdGlvbnMuc2NoZWR1bGVUaW1lLmdldFRpbWUoKTtcbiAgICB0YXNrLnNjaGVkdWxlVGltZSA9IHtcbiAgICAgIHNlY29uZHM6IE1hdGguZmxvb3IobWlsbGlzZWNvbmRzIC8gMTAwMCksXG4gICAgICBuYW5vczogKG1pbGxpc2Vjb25kcyAlIDEwMDApICogMV8wMDBfMDAwLFxuICAgIH07XG4gIH1cblxuICBjb25zdCBbcmVzcG9uc2VdID0gYXdhaXQgY2xpZW50LmNyZWF0ZVRhc2soeyBwYXJlbnQsIHRhc2sgfSk7XG4gIGxvZ2dlci5pbmZvKHsgdGFza05hbWU6IHJlc3BvbnNlLm5hbWUsIHR5cGU6IHRhc2tUeXBlIH0sIGBRdWV1ZWQgJHt0YXNrVHlwZX0gdGFza2ApO1xuXG4gIGNvbnN0IHJ1bkF0ID0gb3B0aW9ucy5zY2hlZHVsZVRpbWUgPz8gbmV3IERhdGUoKTtcblxuICBhd2FpdCBwcmlzbWEudGFzay5jcmVhdGUoe1xuICAgIGRhdGE6IHtcbiAgICAgIHRhc2tJZDogdGFza0lkLFxuICAgICAgdXNlcklkOiBwYXlsb2FkLnVzZXJJZCxcbiAgICAgIHR5cGU6IHRhc2tUeXBlLFxuICAgICAgcGF5bG9hZCxcbiAgICAgIHJ1bkF0LFxuICAgIH0sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBydW5UYXNrSW5CYWNrZ3JvdW5kKHRhc2tUeXBlOiBUYXNrVHlwZSwgcnVubmVyOiAoKSA9PiBQcm9taXNlPHZvaWQ+KTogdm9pZCB7XG4gIHNldEltbWVkaWF0ZSgoKSA9PiB7XG4gICAgcnVubmVyKCkuY2F0Y2goKGVycjogdW5rbm93bikgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICB7IGVycjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6IFN0cmluZyhlcnIpLCB0eXBlOiB0YXNrVHlwZSB9LFxuICAgICAgICBgRmFpbGVkIHRvIHF1ZXVlICR7dGFza1R5cGV9IHRhc2tgLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbi8qKlxuICogUXVldWVzIGEgdGFzayB0byBpbmRleCB3YXJkcm9iZSBmcm9tIGEgbWVzc2FnZSBieSBjYWxsaW5nIHRoZSBjbG91ZCBmdW5jdGlvbi5cbiAqIEBwYXJhbSBtZXNzYWdlSWQgVGhlIElEIG9mIHRoZSBtZXNzYWdlIHRvIHByb2Nlc3MuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBxdWV1ZVdhcmRyb2JlSW5kZXgodXNlcklkOiBzdHJpbmcsIG1lc3NhZ2VJZDogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgIGxvZ2dlci5kZWJ1Zyh7IHVzZXJJZCwgbWVzc2FnZUlkIH0sICdTa2lwcGluZyB3YXJkcm9iZSBpbmRleCBxdWV1ZWluZyBpbiBkZXZlbG9wbWVudCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJ1blRhc2tJbkJhY2tncm91bmQoVGFza1R5cGUuU0NIRURVTEVfV0FSRFJPQkVfSU5ERVgsICgpID0+XG4gICAgcXVldWVUYXNrKFxuICAgICAgJ3dhcmRyb2JlLWluZGV4JyxcbiAgICAgIFdBUkRST0JFX0ZVTkNUSU9OX1VSTCxcbiAgICAgIHsgdXNlcklkLCBtZXNzYWdlSWQgfSxcbiAgICAgIFRhc2tUeXBlLlNDSEVEVUxFX1dBUkRST0JFX0lOREVYLFxuICAgICksXG4gICk7XG59XG5cbi8qKlxuICogUXVldWVzIGEgdGFzayB0byBleHRyYWN0IGFuZCBzYXZlIG1lbW9yaWVzIGZvciBhIHVzZXIgYnkgY2FsbGluZyB0aGUgY2xvdWQgZnVuY3Rpb24uXG4gKiBAcGFyYW0gdXNlcklkIFRoZSBJRCBvZiB0aGUgdXNlciB0byBwcm9jZXNzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcXVldWVNZW1vcnlFeHRyYWN0aW9uKHVzZXJJZDogc3RyaW5nLCBjb252ZXJzYXRpb25JZDogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xuICAgIGxvZ2dlci5kZWJ1Zyh7IHVzZXJJZCwgY29udmVyc2F0aW9uSWQgfSwgJ1NraXBwaW5nIG1lbW9yeSBleHRyYWN0aW9uIHF1ZXVlaW5nIGluIGRldmVsb3BtZW50Jyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcnVuVGFza0luQmFja2dyb3VuZChUYXNrVHlwZS5QUk9DRVNTX01FTU9SSUVTLCAoKSA9PlxuICAgIHF1ZXVlVGFzayhcbiAgICAgICdtZW1vcnktZXh0cmFjdGlvbicsXG4gICAgICBNRU1PUllfRlVOQ1RJT05fVVJMLFxuICAgICAgeyB1c2VySWQsIGNvbnZlcnNhdGlvbklkIH0sXG4gICAgICBUYXNrVHlwZS5QUk9DRVNTX01FTU9SSUVTLFxuICAgICksXG4gICk7XG59XG5cbi8qKlxuICogUXVldWVzIGEgdGFzayB0byB1cGxvYWQgaW1hZ2VzIGZvciBhIHVzZXIgYnkgY2FsbGluZyB0aGUgY2xvdWQgZnVuY3Rpb24uXG4gKiBAcGFyYW0gdXNlcklkIFRoZSBJRCBvZiB0aGUgdXNlciB0byBwcm9jZXNzLlxuICogQHBhcmFtIG1lc3NhZ2VJZCBUaGUgSUQgb2YgdGhlIG1lc3NhZ2UgY29udGFpbmluZyB0aGUgaW1hZ2VzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcXVldWVJbWFnZVVwbG9hZCh1c2VySWQ6IHN0cmluZywgbWVzc2FnZUlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgbG9nZ2VyLmRlYnVnKHsgdXNlcklkLCBtZXNzYWdlSWQgfSwgJ1NraXBwaW5nIGltYWdlIHVwbG9hZCBxdWV1ZWluZyBpbiBkZXZlbG9wbWVudCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJ1blRhc2tJbkJhY2tncm91bmQoVGFza1R5cGUuVVBMT0FEX0lNQUdFUywgKCkgPT5cbiAgICBxdWV1ZVRhc2soXG4gICAgICAnaW1hZ2UtdXBsb2FkJyxcbiAgICAgIElNQUdFX1VQTE9BRF9GVU5DVElPTl9VUkwsXG4gICAgICB7IHVzZXJJZCwgbWVzc2FnZUlkIH0sXG4gICAgICBUYXNrVHlwZS5VUExPQURfSU1BR0VTLFxuICAgICksXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBxdWV1ZUZlZWRiYWNrUmVxdWVzdCh1c2VySWQ6IHN0cmluZywgY29udmVyc2F0aW9uSWQ6IHN0cmluZyk6IHZvaWQge1xuICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICBsb2dnZXIuZGVidWcoeyB1c2VySWQsIGNvbnZlcnNhdGlvbklkIH0sICdTa2lwcGluZyBmZWVkYmFjayByZXF1ZXN0IHF1ZXVlaW5nIGluIGRldmVsb3BtZW50Jyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgZGVsYXlNcyA9IE51bWJlcihwcm9jZXNzLmVudi5GRUVEQkFDS19SRVFVRVNUX0RFTEFZX01TIHx8IDYwXzAwMCk7XG4gIGNvbnN0IHNjaGVkdWxlVGltZSA9IG5ldyBEYXRlKERhdGUubm93KCkgKyBkZWxheU1zKTtcblxuICBydW5UYXNrSW5CYWNrZ3JvdW5kKFRhc2tUeXBlLlNFTkRfRkVFREJBQ0tfUkVRVUVTVCwgKCkgPT5cbiAgICBxdWV1ZVRhc2soXG4gICAgICAnZmVlZGJhY2stcmVxdWVzdCcsXG4gICAgICBGRUVEQkFDS19GVU5DVElPTl9VUkwsXG4gICAgICB7IHVzZXJJZCwgY29udmVyc2F0aW9uSWQgfSxcbiAgICAgIFRhc2tUeXBlLlNFTkRfRkVFREJBQ0tfUkVRVUVTVCxcbiAgICAgIHsgc2NoZWR1bGVUaW1lIH0sXG4gICAgKSxcbiAgKTtcbn1cbiJdfQ==