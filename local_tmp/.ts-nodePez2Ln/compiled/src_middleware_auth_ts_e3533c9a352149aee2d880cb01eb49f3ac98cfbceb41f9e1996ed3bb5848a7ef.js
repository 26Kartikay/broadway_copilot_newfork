"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.authenticateRequest = void 0;
const twilio_1 = require("../lib/twilio");
const errors_1 = require("../utils/errors");
const authenticateRequest = (req, _res, next) => {
    const twilioSignature = req.header('X-Twilio-Signature');
    if (!twilioSignature) {
        throw new errors_1.ForbiddenError('Authentication failed');
    }
    try {
        const isValid = (0, twilio_1.validateTwilioRequest)(req);
        if (!isValid) {
            throw new errors_1.ForbiddenError('Invalid webhook signature');
        }
        next();
    }
    catch (err) {
        throw new errors_1.ForbiddenError('Authentication failed', { cause: err });
    }
};
exports.authenticateRequest = authenticateRequest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9taWRkbGV3YXJlL2F1dGgudHMiLCJzb3VyY2VzIjpbIi91c3Ivc3JjL2FwcC9zcmMvbWlkZGxld2FyZS9hdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLDBDQUFzRDtBQUN0RCw0Q0FBaUQ7QUFXMUMsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLEdBQVksRUFBRSxJQUFjLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQ3RGLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUV6RCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDckIsTUFBTSxJQUFJLHVCQUFjLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsSUFBSSxDQUFDO1FBQ0gsTUFBTSxPQUFPLEdBQUcsSUFBQSw4QkFBcUIsRUFBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixNQUFNLElBQUksdUJBQWMsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3hELENBQUM7UUFDRCxJQUFJLEVBQUUsQ0FBQztJQUNULENBQUM7SUFBQyxPQUFPLEdBQVksRUFBRSxDQUFDO1FBQ3RCLE1BQU0sSUFBSSx1QkFBYyxDQUFDLHVCQUF1QixFQUFFLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDcEUsQ0FBQztBQUNILENBQUMsQ0FBQztBQWhCVyxRQUFBLG1CQUFtQix1QkFnQjlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyB2YWxpZGF0ZVR3aWxpb1JlcXVlc3QgfSBmcm9tICcuLi9saWIvdHdpbGlvJztcbmltcG9ydCB7IEZvcmJpZGRlbkVycm9yIH0gZnJvbSAnLi4vdXRpbHMvZXJyb3JzJztcblxuLyoqXG4gKiBFeHByZXNzIG1pZGRsZXdhcmUgdG8gYXV0aGVudGljYXRlIGluY29taW5nIFR3aWxpbyB3ZWJob29rIHJlcXVlc3RzLlxuICogVmFsaWRhdGVzIHRoZSByZXF1ZXN0IHNpZ25hdHVyZSB0byBlbnN1cmUgaXQgb3JpZ2luYXRlcyBmcm9tIFR3aWxpby5cbiAqXG4gKiBAcGFyYW0gcmVxIC0gRXhwcmVzcyByZXF1ZXN0IG9iamVjdCBjb250YWluaW5nIHdlYmhvb2sgZGF0YVxuICogQHBhcmFtIF9yZXMgLSBFeHByZXNzIHJlc3BvbnNlIG9iamVjdCAodW51c2VkKVxuICogQHBhcmFtIG5leHQgLSBFeHByZXNzIG5leHQgZnVuY3Rpb24gdG8gY29udGludWUgcmVxdWVzdCBwcm9jZXNzaW5nXG4gKiBAdGhyb3dzIHtIdHRwRXJyb3J9IFdoZW4gd2ViaG9vayBzaWduYXR1cmUgdmFsaWRhdGlvbiBmYWlsc1xuICovXG5leHBvcnQgY29uc3QgYXV0aGVudGljYXRlUmVxdWVzdCA9IChyZXE6IFJlcXVlc3QsIF9yZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgY29uc3QgdHdpbGlvU2lnbmF0dXJlID0gcmVxLmhlYWRlcignWC1Ud2lsaW8tU2lnbmF0dXJlJyk7XG5cbiAgaWYgKCF0d2lsaW9TaWduYXR1cmUpIHtcbiAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXJyb3IoJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVUd2lsaW9SZXF1ZXN0KHJlcSk7XG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXJyb3IoJ0ludmFsaWQgd2ViaG9vayBzaWduYXR1cmUnKTtcbiAgICB9XG4gICAgbmV4dCgpO1xuICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXJyb3IoJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcsIHsgY2F1c2U6IGVyciB9KTtcbiAgfVxufTtcbiJdfQ==