"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendReply = sendReply;
require("dotenv/config");
const client_1 = require("@prisma/client");
const prisma_1 = require("../../lib/prisma");
const redis_1 = require("../../lib/redis");
const tasks_1 = require("../../lib/tasks");
const twilio_1 = require("../../lib/twilio");
const errors_1 = require("../../utils/errors");
const logger_1 = require("../../utils/logger");
async function sendReply(state) {
    const { input, user, conversationId } = state;
    const messageId = input.MessageSid;
    const messageKey = `message:${messageId}`;
    const whatsappId = user.whatsappId;
    if (!conversationId) {
        throw new errors_1.InternalServerError('No open conversation found for user');
    }
    logger_1.logger.debug({ whatsappId }, 'Setting message status to sending in Redis');
    await redis_1.redis.hSet(messageKey, { status: 'sending' });
    const replies = state.assistantReply ?? [];
    const formattedContent = replies.flatMap((r) => {
        const parts = [];
        if (r.reply_text) {
            parts.push({ type: 'text', text: r.reply_text });
        }
        if (r.reply_type === 'image') {
            parts.push({ type: 'image_url', image_url: { url: r.media_url } });
        }
        return parts;
    });
    const pendingToPersist = state.pending ?? client_1.PendingType.NONE;
    const validTonalities = ['savage', 'friendly', 'hype_bff'];
    const selectedTonalityToPersist = state.selectedTonality && validTonalities.includes(state.selectedTonality)
        ? state.selectedTonality
        : null;
    let success = true;
    try {
        for (const [index, r] of replies.entries()) {
            if (r.reply_type === 'text') {
                await (0, twilio_1.sendText)(whatsappId, r.reply_text);
                logger_1.logger.debug({
                    whatsappId,
                    replyIndex: index + 1,
                    textLength: r.reply_text.length,
                }, 'Sent text message');
            }
            else if (r.reply_type === 'quick_reply') {
                if (r.buttons.length === 4) {
                    await (0, twilio_1.sendMenu)(whatsappId, r.reply_text, r.buttons);
                }
                else if (r.buttons.length === 3 || r.buttons.length === 2) {
                    await (0, twilio_1.sendMenu)(whatsappId, r.reply_text, r.buttons);
                }
                else {
                    logger_1.logger.warn({
                        whatsappId,
                        buttonCount: r.buttons.length,
                        replyIndex: index + 1,
                    }, 'Unexpected button count - falling back to text');
                    await (0, twilio_1.sendText)(whatsappId, r.reply_text);
                }
                logger_1.logger.debug({ whatsappId, replyIndex: index + 1, buttonCount: r.buttons.length }, 'Sent menu message');
            }
            else if (r.reply_type === 'image') {
                await (0, twilio_1.sendImage)(whatsappId, r.media_url, r.reply_text);
                logger_1.logger.debug({ whatsappId, replyIndex: index + 1, mediaUrl: r.media_url }, 'Sent image message');
            }
        }
        logger_1.logger.info({ whatsappId, replyCount: replies.length }, 'All replies sent successfully');
    }
    catch (err) {
        success = false;
        throw new errors_1.InternalServerError('Failed to send replies', { cause: err });
    }
    finally {
        logger_1.logger.debug({ status: success ? 'delivered' : 'failed' }, 'Updating message status in Redis');
        await redis_1.redis.hSet(messageKey, { status: success ? 'delivered' : 'failed' });
    }
    await prisma_1.prisma.message.create({
        data: {
            conversationId,
            role: client_1.MessageRole.AI,
            content: formattedContent,
            pending: pendingToPersist,
            selectedTonality: selectedTonalityToPersist,
        },
    });
    (0, tasks_1.queueFeedbackRequest)(user.id, conversationId);
    return { ...state };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9hZ2VudC9ub2Rlcy9zZW5kUmVwbHkudHMiLCJzb3VyY2VzIjpbIi91c3Ivc3JjL2FwcC9zcmMvYWdlbnQvbm9kZXMvc2VuZFJlcGx5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBcUJBLDhCQWdHQztBQXJIRCx5QkFBdUI7QUFFdkIsMkNBQTBEO0FBSTFELDZDQUEwQztBQUMxQywyQ0FBd0M7QUFDeEMsMkNBQXVEO0FBQ3ZELDZDQUFpRTtBQUNqRSwrQ0FBeUQ7QUFDekQsK0NBQTRDO0FBVXJDLEtBQUssVUFBVSxTQUFTLENBQUMsS0FBaUI7SUFDL0MsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEdBQUcsS0FBSyxDQUFDO0lBQzlDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUM7SUFDbkMsTUFBTSxVQUFVLEdBQUcsV0FBVyxTQUFTLEVBQUUsQ0FBQztJQUMxQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBRW5DLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNwQixNQUFNLElBQUksNEJBQW1CLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsZUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLFVBQVUsRUFBRSxFQUFFLDRDQUE0QyxDQUFDLENBQUM7SUFDM0UsTUFBTSxhQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBRXBELE1BQU0sT0FBTyxHQUFZLEtBQUssQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDO0lBQ3BELE1BQU0sZ0JBQWdCLEdBQW1CLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUM3RCxNQUFNLEtBQUssR0FBeUIsRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2pCLEtBQUssQ0FB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RSxjQUFjLENBQUMsQ0FBQztJQUU5QyxPQUFPLEVBQUUsR0FBRyxLQUFLLEVBQUUsQ0FBQztBQUN0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdkb3RlbnYvY29uZmlnJztcblxuaW1wb3J0IHsgTWVzc2FnZVJvbGUsIFBlbmRpbmdUeXBlIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgTWVzc2FnZUNvbnRlbnQsIE1lc3NhZ2VDb250ZW50UGFydCB9IGZyb20gJy4uLy4uL2xpYi9haSc7XG5cbmltcG9ydCB7IFRvbmFsaXR5IH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSAnLi4vLi4vbGliL3ByaXNtYSc7XG5pbXBvcnQgeyByZWRpcyB9IGZyb20gJy4uLy4uL2xpYi9yZWRpcyc7XG5pbXBvcnQgeyBxdWV1ZUZlZWRiYWNrUmVxdWVzdCB9IGZyb20gJy4uLy4uL2xpYi90YXNrcyc7XG5pbXBvcnQgeyBzZW5kSW1hZ2UsIHNlbmRNZW51LCBzZW5kVGV4dCB9IGZyb20gJy4uLy4uL2xpYi90d2lsaW8nO1xuaW1wb3J0IHsgSW50ZXJuYWxTZXJ2ZXJFcnJvciB9IGZyb20gJy4uLy4uL3V0aWxzL2Vycm9ycyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgR3JhcGhTdGF0ZSwgUmVwbGllcyB9IGZyb20gJy4uL3N0YXRlJztcblxuLyoqXG4gKiBTZW5kcyB0aGUgcmVwbHkgdmlhIFR3aWxpbyBiYXNlZCBvbiB0aGUgYXNzaXN0YW50J3MgZ2VuZXJhdGVkIHJlcGxpZXMuXG4gKiBSZWNvcmRzIHRoZSBhc3Npc3RhbnQncyBtZXNzYWdlIGluIHRoZSBkYXRhYmFzZSBhbmQgdXBkYXRlcyBwcm9jZXNzaW5nIHN0YXR1cy5cbiAqIFNjaGVkdWxlcyBtZW1vcnkgZXh0cmFjdGlvbiBhZnRlciBzZW5kaW5nLlxuICogQHBhcmFtIHN0YXRlIFRoZSBjdXJyZW50IGFnZW50IHN0YXRlIGNvbnRhaW5pbmcgcmVwbHkgYW5kIHVzZXIgaW5mby5cbiAqIEByZXR1cm5zIEFuIGVtcHR5IG9iamVjdCBhcyBubyBzdGF0ZSB1cGRhdGVzIGFyZSBuZWVkZWQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kUmVwbHkoc3RhdGU6IEdyYXBoU3RhdGUpOiBQcm9taXNlPEdyYXBoU3RhdGU+IHtcbiAgY29uc3QgeyBpbnB1dCwgdXNlciwgY29udmVyc2F0aW9uSWQgfSA9IHN0YXRlO1xuICBjb25zdCBtZXNzYWdlSWQgPSBpbnB1dC5NZXNzYWdlU2lkO1xuICBjb25zdCBtZXNzYWdlS2V5ID0gYG1lc3NhZ2U6JHttZXNzYWdlSWR9YDtcbiAgY29uc3Qgd2hhdHNhcHBJZCA9IHVzZXIud2hhdHNhcHBJZDtcblxuICBpZiAoIWNvbnZlcnNhdGlvbklkKSB7XG4gICAgdGhyb3cgbmV3IEludGVybmFsU2VydmVyRXJyb3IoJ05vIG9wZW4gY29udmVyc2F0aW9uIGZvdW5kIGZvciB1c2VyJyk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoeyB3aGF0c2FwcElkIH0sICdTZXR0aW5nIG1lc3NhZ2Ugc3RhdHVzIHRvIHNlbmRpbmcgaW4gUmVkaXMnKTtcbiAgYXdhaXQgcmVkaXMuaFNldChtZXNzYWdlS2V5LCB7IHN0YXR1czogJ3NlbmRpbmcnIH0pO1xuXG4gIGNvbnN0IHJlcGxpZXM6IFJlcGxpZXMgPSBzdGF0ZS5hc3Npc3RhbnRSZXBseSA/PyBbXTtcbiAgY29uc3QgZm9ybWF0dGVkQ29udGVudDogTWVzc2FnZUNvbnRlbnQgPSByZXBsaWVzLmZsYXRNYXAoKHIpID0+IHtcbiAgICBjb25zdCBwYXJ0czogTWVzc2FnZUNvbnRlbnRQYXJ0W10gPSBbXTtcbiAgICBpZiAoci5yZXBseV90ZXh0KSB7XG4gICAgICBwYXJ0cy5wdXNoKHsgdHlwZTogJ3RleHQnLCB0ZXh0OiByLnJlcGx5X3RleHQgfSk7XG4gICAgfVxuICAgIGlmIChyLnJlcGx5X3R5cGUgPT09ICdpbWFnZScpIHtcbiAgICAgIHBhcnRzLnB1c2goeyB0eXBlOiAnaW1hZ2VfdXJsJywgaW1hZ2VfdXJsOiB7IHVybDogci5tZWRpYV91cmwgfSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcnRzO1xuICB9KTtcblxuICBjb25zdCBwZW5kaW5nVG9QZXJzaXN0ID0gKHN0YXRlLnBlbmRpbmcgYXMgUGVuZGluZ1R5cGUgfCB1bmRlZmluZWQpID8/IFBlbmRpbmdUeXBlLk5PTkU7XG4gIGNvbnN0IHZhbGlkVG9uYWxpdGllczogVG9uYWxpdHlbXSA9IFsnc2F2YWdlJywgJ2ZyaWVuZGx5JywgJ2h5cGVfYmZmJ107XG4gIGNvbnN0IHNlbGVjdGVkVG9uYWxpdHlUb1BlcnNpc3Q6IFRvbmFsaXR5IHwgbnVsbCA9XG4gICAgc3RhdGUuc2VsZWN0ZWRUb25hbGl0eSAmJiB2YWxpZFRvbmFsaXRpZXMuaW5jbHVkZXMoc3RhdGUuc2VsZWN0ZWRUb25hbGl0eSBhcyBUb25hbGl0eSlcbiAgICAgID8gKHN0YXRlLnNlbGVjdGVkVG9uYWxpdHkgYXMgVG9uYWxpdHkpXG4gICAgICA6IG51bGw7XG5cbiAgbGV0IHN1Y2Nlc3MgPSB0cnVlO1xuICB0cnkge1xuICAgIGZvciAoY29uc3QgW2luZGV4LCByXSBvZiByZXBsaWVzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKHIucmVwbHlfdHlwZSA9PT0gJ3RleHQnKSB7XG4gICAgICAgIGF3YWl0IHNlbmRUZXh0KHdoYXRzYXBwSWQsIHIucmVwbHlfdGV4dCk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICB7XG4gICAgICAgICAgICB3aGF0c2FwcElkLFxuICAgICAgICAgICAgcmVwbHlJbmRleDogaW5kZXggKyAxLFxuICAgICAgICAgICAgdGV4dExlbmd0aDogci5yZXBseV90ZXh0Lmxlbmd0aCxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdTZW50IHRleHQgbWVzc2FnZScsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKHIucmVwbHlfdHlwZSA9PT0gJ3F1aWNrX3JlcGx5Jykge1xuICAgICAgICBpZiAoci5idXR0b25zLmxlbmd0aCA9PT0gNCkge1xuICAgICAgICAgIGF3YWl0IHNlbmRNZW51KHdoYXRzYXBwSWQsIHIucmVwbHlfdGV4dCwgci5idXR0b25zKTtcbiAgICAgICAgfSBlbHNlIGlmIChyLmJ1dHRvbnMubGVuZ3RoID09PSAzIHx8IHIuYnV0dG9ucy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBhd2FpdCBzZW5kTWVudSh3aGF0c2FwcElkLCByLnJlcGx5X3RleHQsIHIuYnV0dG9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHdoYXRzYXBwSWQsXG4gICAgICAgICAgICAgIGJ1dHRvbkNvdW50OiByLmJ1dHRvbnMubGVuZ3RoLFxuICAgICAgICAgICAgICByZXBseUluZGV4OiBpbmRleCArIDEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ1VuZXhwZWN0ZWQgYnV0dG9uIGNvdW50IC0gZmFsbGluZyBiYWNrIHRvIHRleHQnLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYXdhaXQgc2VuZFRleHQod2hhdHNhcHBJZCwgci5yZXBseV90ZXh0KTtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgeyB3aGF0c2FwcElkLCByZXBseUluZGV4OiBpbmRleCArIDEsIGJ1dHRvbkNvdW50OiByLmJ1dHRvbnMubGVuZ3RoIH0sXG4gICAgICAgICAgJ1NlbnQgbWVudSBtZXNzYWdlJyxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoci5yZXBseV90eXBlID09PSAnaW1hZ2UnKSB7XG4gICAgICAgIGF3YWl0IHNlbmRJbWFnZSh3aGF0c2FwcElkLCByLm1lZGlhX3VybCwgci5yZXBseV90ZXh0KTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIHsgd2hhdHNhcHBJZCwgcmVwbHlJbmRleDogaW5kZXggKyAxLCBtZWRpYVVybDogci5tZWRpYV91cmwgfSxcbiAgICAgICAgICAnU2VudCBpbWFnZSBtZXNzYWdlJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oeyB3aGF0c2FwcElkLCByZXBseUNvdW50OiByZXBsaWVzLmxlbmd0aCB9LCAnQWxsIHJlcGxpZXMgc2VudCBzdWNjZXNzZnVsbHknKTtcbiAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XG4gICAgc3VjY2VzcyA9IGZhbHNlO1xuICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yKCdGYWlsZWQgdG8gc2VuZCByZXBsaWVzJywgeyBjYXVzZTogZXJyIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGxvZ2dlci5kZWJ1Zyh7IHN0YXR1czogc3VjY2VzcyA/ICdkZWxpdmVyZWQnIDogJ2ZhaWxlZCcgfSwgJ1VwZGF0aW5nIG1lc3NhZ2Ugc3RhdHVzIGluIFJlZGlzJyk7XG4gICAgYXdhaXQgcmVkaXMuaFNldChtZXNzYWdlS2V5LCB7IHN0YXR1czogc3VjY2VzcyA/ICdkZWxpdmVyZWQnIDogJ2ZhaWxlZCcgfSk7XG4gIH1cblxuICAvLyBQZXJzaXN0IGJvdGggcGVuZGluZyBhbmQgc2VsZWN0ZWRUb25hbGl0eSFcbiAgYXdhaXQgcHJpc21hLm1lc3NhZ2UuY3JlYXRlKHtcbiAgICBkYXRhOiB7XG4gICAgICBjb252ZXJzYXRpb25JZCxcbiAgICAgIHJvbGU6IE1lc3NhZ2VSb2xlLkFJLFxuICAgICAgY29udGVudDogZm9ybWF0dGVkQ29udGVudCxcbiAgICAgIHBlbmRpbmc6IHBlbmRpbmdUb1BlcnNpc3QsXG4gICAgICBzZWxlY3RlZFRvbmFsaXR5OiBzZWxlY3RlZFRvbmFsaXR5VG9QZXJzaXN0LCAvLyA8LS0gcGVyc2lzdCBsYXRlc3QgdG9uYWxpdHlcbiAgICB9LFxuICB9KTtcblxuICBxdWV1ZUZlZWRiYWNrUmVxdWVzdCh1c2VyLmlkLCBjb252ZXJzYXRpb25JZCk7XG5cbiAgcmV0dXJuIHsgLi4uc3RhdGUgfTtcbn1cbiJdfQ==