"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChatGroq = void 0;
const cuid2_1 = require("@paralleldrive/cuid2");
const groq_sdk_1 = __importDefault(require("groq-sdk"));
const costs_1 = require("../config/costs");
const base_chat_completions_model_1 = require("../core/base_chat_completions_model");
class ChatGroq extends base_chat_completions_model_1.BaseChatCompletionsModel {
    client;
    params;
    constructor(params = {}) {
        const combinedParams = {
            model: 'llama3-70b-8192',
            ...params,
        };
        super(combinedParams);
        this.client = new groq_sdk_1.default({
            apiKey: process.env.GROQ_API_KEY,
        });
        this.structuredOutputToolName = 'json';
        this.params = combinedParams;
    }
    async run(systemPrompt, msgs, traceBuffer, nodeName) {
        const params = this._buildChatCompletionsParams(systemPrompt, msgs);
        const requestOptions = {};
        if (this.params.maxRetries !== undefined) {
            requestOptions.maxRetries = this.params.maxRetries;
        }
        if (this.params.timeout !== undefined) {
            requestOptions.timeout = this.params.timeout;
        }
        const nodeRun = traceBuffer.nodeRuns.find((ne) => ne.nodeName === nodeName && !ne.endTime);
        if (!nodeRun) {
            throw new Error(`Could not find an active node execution for nodeName: ${nodeName}`);
        }
        const startTime = new Date();
        const llmTrace = {
            id: (0, cuid2_1.createId)(),
            nodeRunId: nodeRun.id,
            model: this.params.model,
            inputMessages: params.messages,
            rawRequest: params,
            startTime,
        };
        let response;
        try {
            response = (await this.client.chat.completions.create(params, requestOptions));
        }
        catch (err) {
            const endTime = new Date();
            const message = err instanceof Error ? err.message : String(err);
            const stack = err instanceof Error ? err.stack : undefined;
            llmTrace.errorTrace = stack ?? message;
            llmTrace.endTime = endTime;
            llmTrace.durationMs = endTime.getTime() - startTime.getTime();
            traceBuffer.llmTraces.push(llmTrace);
            throw err;
        }
        const { assistant, toolCalls } = this._processChatCompletionsResponse(response);
        const endTime = new Date();
        let costUsd = null;
        const modelCosts = costs_1.MODEL_COSTS[this.params.model];
        if (modelCosts) {
            const promptTokens = response.usage?.prompt_tokens ?? 0;
            const completionTokens = response.usage?.completion_tokens ?? 0;
            const inputCost = (promptTokens / 1_000_000) * modelCosts.input;
            const outputCost = (completionTokens / 1_000_000) * modelCosts.output;
            costUsd = inputCost + outputCost;
        }
        llmTrace.rawResponse = response;
        llmTrace.outputMessage = assistant.toJSON();
        llmTrace.promptTokens = response.usage?.prompt_tokens ?? null;
        llmTrace.completionTokens = response.usage?.completion_tokens ?? null;
        llmTrace.totalTokens = response.usage?.total_tokens ?? null;
        llmTrace.costUsd = costUsd ?? null;
        llmTrace.endTime = endTime;
        llmTrace.durationMs = endTime.getTime() - startTime.getTime();
        traceBuffer.llmTraces.push(llmTrace);
        return {
            assistant,
            toolCalls,
            raw: response,
        };
    }
    _buildChatCompletionsParams(systemPrompt, msgs) {
        const params = super._buildChatCompletionsParams(systemPrompt, msgs);
        params.messages = params.messages.map((m) => {
            if (m.role === 'user' && Array.isArray(m.content)) {
                return {
                    ...m,
                    content: m.content
                        .filter((c) => c.type === 'text')
                        .map((c) => c.text)
                        .join(''),
                };
            }
            return m;
        });
        return params;
    }
}
exports.ChatGroq = ChatGroq;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9saWIvYWkvZ3JvcS9jaGF0X21vZGVscy50cyIsInNvdXJjZXMiOlsiL3Vzci9zcmMvYXBwL3NyYy9saWIvYWkvZ3JvcS9jaGF0X21vZGVscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBZ0Q7QUFFaEQsd0RBQTRCO0FBTTVCLDJDQUE4QztBQUM5QyxxRkFBK0U7QUFtQi9FLE1BQWEsUUFBUyxTQUFRLHNEQUF3QjtJQUMxQyxNQUFNLENBQU87SUFDaEIsTUFBTSxDQUFzQjtJQU9uQyxZQUFZLFNBQXVDLEVBQUU7UUFDbkQsTUFBTSxjQUFjLEdBQXdCO1lBQzFDLEtBQUssRUFBRSxpQkFBaUI7WUFDeEIsR0FBRyxNQUFNO1NBQ1YsQ0FBQztRQUNGLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksa0JBQUksQ0FBQztZQUNyQixNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO1NBQ2pDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyx3QkFBd0IsR0FBRyxNQUFNLENBQUM7UUFDdkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQ1AsWUFBMkIsRUFDM0IsSUFBbUIsRUFDbkIsV0FBd0IsRUFDeEIsUUFBZ0I7UUFFaEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVwRSxNQUFNLGNBQWMsR0FBOEMsRUFBRSxDQUFDO1FBQ3JFLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDekMsY0FBYyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUNyRCxDQUFDO1FBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sS0FB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aUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDO3lCQUMvQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7eUJBQ2xCLElBQUksQ0FBQyxFQUFFLENBQUM7aUJBQ1osQ0FBQztZQUNKLENBQUM7WUFDRCxPQUFPLENBQUMsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBNUhELDRCQTRIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUlkIH0gZnJvbSAnQHBhcmFsbGVsZHJpdmUvY3VpZDInO1xuaW1wb3J0IHsgUHJpc21hIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xuaW1wb3J0IEdyb3EgZnJvbSAnZ3JvcS1zZGsnO1xuaW1wb3J0IE9wZW5BSSBmcm9tICdvcGVuYWknO1xuaW1wb3J0IHsgQ2hhdENvbXBsZXRpb24gfSBmcm9tICdvcGVuYWkvcmVzb3VyY2VzL2NoYXQvY29tcGxldGlvbnMnO1xuXG5pbXBvcnQgdHlwZSB7IENoYXRDb21wbGV0aW9uQ3JlYXRlUGFyYW1zTm9uU3RyZWFtaW5nIGFzIEdyb3FDaGF0Q29tcGxldGlvblBhcmFtcyB9IGZyb20gJ2dyb3Etc2RrL3Jlc291cmNlcy9jaGF0L2NvbXBsZXRpb25zJztcbmltcG9ydCB7IEJ1ZmZlcmVkTGxtVHJhY2UsIFRyYWNlQnVmZmVyIH0gZnJvbSAnLi4vLi4vLi4vYWdlbnQvdHJhY2luZyc7XG5pbXBvcnQgeyBNT0RFTF9DT1NUUyB9IGZyb20gJy4uL2NvbmZpZy9jb3N0cyc7XG5pbXBvcnQgeyBCYXNlQ2hhdENvbXBsZXRpb25zTW9kZWwgfSBmcm9tICcuLi9jb3JlL2Jhc2VfY2hhdF9jb21wbGV0aW9uc19tb2RlbCc7XG5pbXBvcnQgeyBCYXNlTWVzc2FnZSwgU3lzdGVtTWVzc2FnZSwgVGV4dFBhcnQgfSBmcm9tICcuLi9jb3JlL21lc3NhZ2VzJztcbmltcG9ydCB7IEdyb3FDaGF0TW9kZWxQYXJhbXMsIFJ1bk91dGNvbWUgfSBmcm9tICcuLi9jb3JlL3J1bm5hYmxlcyc7XG5cbi8qKlxuICogQSBjaGF0IG1vZGVsIHRoYXQgaW50ZXJhY3RzIHdpdGggdGhlIEdyb3EgQVBJLlxuICogVGhpcyBjbGFzcyBleHRlbmRzIGBCYXNlQ2hhdENvbXBsZXRpb25zTW9kZWxgIGFuZCBpcyBjb25maWd1cmVkIGZvciBHcm9xJ3MgZW5kcG9pbnQuXG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIGNvbnN0IG1vZGVsID0gbmV3IENoYXRHcm9xKHsgbW9kZWw6ICdsbGFtYTMtNzBiLTgxOTInIH0pO1xuICogY29uc3QgcmVzdWx0ID0gYXdhaXQgbW9kZWwucnVuKFxuICogICBuZXcgU3lzdGVtTWVzc2FnZSgnWW91IGFyZSBhIGhlbHBmdWwgYXNzaXN0YW50LicpLFxuICogICBbbmV3IFVzZXJNZXNzYWdlKCdFeHBsYWluIHRoZSBpbXBvcnRhbmNlIG9mIGxvdy1sYXRlbmN5IExMTXMnKV0sXG4gKiAgICdzb21lLWdyYXBoLXJ1bi1pZCdcbiAqICk7XG4gKiBjb25zb2xlLmxvZyhyZXN1bHQuYXNzaXN0YW50LmNvbnRlbnRbMF0udGV4dCk7XG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIENoYXRHcm9xIGV4dGVuZHMgQmFzZUNoYXRDb21wbGV0aW9uc01vZGVsIHtcbiAgcHJvdGVjdGVkIGNsaWVudDogR3JvcTtcbiAgcHVibGljIHBhcmFtczogR3JvcUNoYXRNb2RlbFBhcmFtcztcblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBDaGF0R3JvcS5cbiAgICogQHBhcmFtIHBhcmFtcyAtIE9wdGlvbmFsIHBhcmFtZXRlcnMgdG8gb3ZlcnJpZGUgdGhlIG1vZGVsIGRlZmF1bHRzLlxuICAgKiBAcGFyYW0gY2xpZW50IC0gQW4gb3B0aW9uYWwgR3JvcSBjbGllbnQgaW5zdGFuY2UsIHVzZWZ1bCBmb3IgdGVzdGluZyBvciBjdXN0b20gY29uZmlndXJhdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihwYXJhbXM6IFBhcnRpYWw8R3JvcUNoYXRNb2RlbFBhcmFtcz4gPSB7fSkge1xuICAgIGNvbnN0IGNvbWJpbmVkUGFyYW1zOiBHcm9xQ2hhdE1vZGVsUGFyYW1zID0ge1xuICAgICAgbW9kZWw6ICdsbGFtYTMtNzBiLTgxOTInLFxuICAgICAgLi4ucGFyYW1zLFxuICAgIH07XG4gICAgc3VwZXIoY29tYmluZWRQYXJhbXMpO1xuICAgIHRoaXMuY2xpZW50ID0gbmV3IEdyb3Eoe1xuICAgICAgYXBpS2V5OiBwcm9jZXNzLmVudi5HUk9RX0FQSV9LRVksXG4gICAgfSk7XG4gICAgdGhpcy5zdHJ1Y3R1cmVkT3V0cHV0VG9vbE5hbWUgPSAnanNvbic7XG4gICAgdGhpcy5wYXJhbXMgPSBjb21iaW5lZFBhcmFtcztcbiAgfVxuXG4gIGFzeW5jIHJ1bihcbiAgICBzeXN0ZW1Qcm9tcHQ6IFN5c3RlbU1lc3NhZ2UsXG4gICAgbXNnczogQmFzZU1lc3NhZ2VbXSxcbiAgICB0cmFjZUJ1ZmZlcjogVHJhY2VCdWZmZXIsXG4gICAgbm9kZU5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSdW5PdXRjb21lPiB7XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5fYnVpbGRDaGF0Q29tcGxldGlvbnNQYXJhbXMoc3lzdGVtUHJvbXB0LCBtc2dzKTtcblxuICAgIGNvbnN0IHJlcXVlc3RPcHRpb25zOiB7IG1heFJldHJpZXM/OiBudW1iZXI7IHRpbWVvdXQ/OiBudW1iZXIgfSA9IHt9O1xuICAgIGlmICh0aGlzLnBhcmFtcy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlcXVlc3RPcHRpb25zLm1heFJldHJpZXMgPSB0aGlzLnBhcmFtcy5tYXhSZXRyaWVzO1xuICAgIH1cbiAgICBpZiAodGhpcy5wYXJhbXMudGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXF1ZXN0T3B0aW9ucy50aW1lb3V0ID0gdGhpcy5wYXJhbXMudGltZW91dDtcbiAgICB9XG5cbiAgICBjb25zdCBub2RlUnVuID0gdHJhY2VCdWZmZXIubm9kZVJ1bnMuZmluZCgobmUpID0+IG5lLm5vZGVOYW1lID09PSBub2RlTmFtZSAmJiAhbmUuZW5kVGltZSk7XG4gICAgaWYgKCFub2RlUnVuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIGFuIGFjdGl2ZSBub2RlIGV4ZWN1dGlvbiBmb3Igbm9kZU5hbWU6ICR7bm9kZU5hbWV9YCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IGxsbVRyYWNlOiBCdWZmZXJlZExsbVRyYWNlID0ge1xuICAgICAgaWQ6IGNyZWF0ZUlkKCksXG4gICAgICBub2RlUnVuSWQ6IG5vZGVSdW4uaWQsXG4gICAgICBtb2RlbDogdGhpcy5wYXJhbXMubW9kZWwsXG4gICAgICBpbnB1dE1lc3NhZ2VzOiBwYXJhbXMubWVzc2FnZXMgYXMgdW5rbm93biBhcyBQcmlzbWEuSnNvbkFycmF5LFxuICAgICAgcmF3UmVxdWVzdDogcGFyYW1zIGFzIHVua25vd24gYXMgUHJpc21hLkpzb25PYmplY3QsXG4gICAgICBzdGFydFRpbWUsXG4gICAgfTtcblxuICAgIGxldCByZXNwb25zZTogQ2hhdENvbXBsZXRpb247XG4gICAgdHJ5IHtcbiAgICAgIHJlc3BvbnNlID0gKGF3YWl0IHRoaXMuY2xpZW50LmNoYXQuY29tcGxldGlvbnMuY3JlYXRlKFxuICAgICAgICBwYXJhbXMgYXMgdW5rbm93biBhcyBHcm9xQ2hhdENvbXBsZXRpb25QYXJhbXMsXG4gICAgICAgIHJlcXVlc3RPcHRpb25zLFxuICAgICAgKSkgYXMgQ2hhdENvbXBsZXRpb247XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogU3RyaW5nKGVycik7XG4gICAgICBjb25zdCBzdGFjayA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLnN0YWNrIDogdW5kZWZpbmVkO1xuICAgICAgbGxtVHJhY2UuZXJyb3JUcmFjZSA9IHN0YWNrID8/IG1lc3NhZ2U7XG4gICAgICBsbG1UcmFjZS5lbmRUaW1lID0gZW5kVGltZTtcbiAgICAgIGxsbVRyYWNlLmR1cmF0aW9uTXMgPSBlbmRUaW1lLmdldFRpbWUoKSAtIHN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgICB0cmFjZUJ1ZmZlci5sbG1UcmFjZXMucHVzaChsbG1UcmFjZSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuXG4gICAgY29uc3QgeyBhc3Npc3RhbnQsIHRvb2xDYWxscyB9ID0gdGhpcy5fcHJvY2Vzc0NoYXRDb21wbGV0aW9uc1Jlc3BvbnNlKHJlc3BvbnNlKTtcblxuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgbGV0IGNvc3RVc2Q6IG51bWJlciB8IG51bGwgPSBudWxsO1xuICAgIGNvbnN0IG1vZGVsQ29zdHMgPSBNT0RFTF9DT1NUU1t0aGlzLnBhcmFtcy5tb2RlbF07XG4gICAgaWYgKG1vZGVsQ29zdHMpIHtcbiAgICAgIGNvbnN0IHByb21wdFRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy5wcm9tcHRfdG9rZW5zID8/IDA7XG4gICAgICBjb25zdCBjb21wbGV0aW9uVG9rZW5zID0gcmVzcG9uc2UudXNhZ2U/LmNvbXBsZXRpb25fdG9rZW5zID8/IDA7XG4gICAgICBjb25zdCBpbnB1dENvc3QgPSAocHJvbXB0VG9rZW5zIC8gMV8wMDBfMDAwKSAqIG1vZGVsQ29zdHMuaW5wdXQ7XG4gICAgICBjb25zdCBvdXRwdXRDb3N0ID0gKGNvbXBsZXRpb25Ub2tlbnMgLyAxXzAwMF8wMDApICogbW9kZWxDb3N0cy5vdXRwdXQ7XG4gICAgICBjb3N0VXNkID0gaW5wdXRDb3N0ICsgb3V0cHV0Q29zdDtcbiAgICB9XG5cbiAgICBsbG1UcmFjZS5yYXdSZXNwb25zZSA9IHJlc3BvbnNlIGFzIHVua25vd24gYXMgUHJpc21hLkpzb25PYmplY3Q7XG4gICAgbGxtVHJhY2Uub3V0cHV0TWVzc2FnZSA9IGFzc2lzdGFudC50b0pTT04oKSBhcyBQcmlzbWEuSnNvbk9iamVjdDtcbiAgICBsbG1UcmFjZS5wcm9tcHRUb2tlbnMgPSByZXNwb25zZS51c2FnZT8ucHJvbXB0X3Rva2VucyA/PyBudWxsO1xuICAgIGxsbVRyYWNlLmNvbXBsZXRpb25Ub2tlbnMgPSByZXNwb25zZS51c2FnZT8uY29tcGxldGlvbl90b2tlbnMgPz8gbnVsbDtcbiAgICBsbG1UcmFjZS50b3RhbFRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy50b3RhbF90b2tlbnMgPz8gbnVsbDtcbiAgICBsbG1UcmFjZS5jb3N0VXNkID0gY29zdFVzZCA/PyBudWxsO1xuICAgIGxsbVRyYWNlLmVuZFRpbWUgPSBlbmRUaW1lO1xuICAgIGxsbVRyYWNlLmR1cmF0aW9uTXMgPSBlbmRUaW1lLmdldFRpbWUoKSAtIHN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgdHJhY2VCdWZmZXIubGxtVHJhY2VzLnB1c2gobGxtVHJhY2UpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFzc2lzdGFudCxcbiAgICAgIHRvb2xDYWxscyxcbiAgICAgIHJhdzogcmVzcG9uc2UsXG4gICAgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfYnVpbGRDaGF0Q29tcGxldGlvbnNQYXJhbXMoXG4gICAgc3lzdGVtUHJvbXB0OiBTeXN0ZW1NZXNzYWdlLFxuICAgIG1zZ3M6IEJhc2VNZXNzYWdlW10sXG4gICk6IE9wZW5BSS5DaGF0LkNvbXBsZXRpb25zLkNoYXRDb21wbGV0aW9uQ3JlYXRlUGFyYW1zTm9uU3RyZWFtaW5nIHtcbiAgICBjb25zdCBwYXJhbXMgPSBzdXBlci5fYnVpbGRDaGF0Q29tcGxldGlvbnNQYXJhbXMoc3lzdGVtUHJvbXB0LCBtc2dzKTtcblxuICAgIC8vIEdyb3EgZG9lc24ndCBzdXBwb3J0IGltYWdlIGlucHV0cywgc28gd2UgbmVlZCB0byBmaWx0ZXIgdGhlbSBvdXRcbiAgICBwYXJhbXMubWVzc2FnZXMgPSBwYXJhbXMubWVzc2FnZXMubWFwKChtKSA9PiB7XG4gICAgICBpZiAobS5yb2xlID09PSAndXNlcicgJiYgQXJyYXkuaXNBcnJheShtLmNvbnRlbnQpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4ubSxcbiAgICAgICAgICBjb250ZW50OiBtLmNvbnRlbnRcbiAgICAgICAgICAgIC5maWx0ZXIoKGMpOiBjIGlzIFRleHRQYXJ0ID0+IGMudHlwZSA9PT0gJ3RleHQnKVxuICAgICAgICAgICAgLm1hcCgoYykgPT4gYy50ZXh0KVxuICAgICAgICAgICAgLmpvaW4oJycpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIG07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG59XG4iXX0=