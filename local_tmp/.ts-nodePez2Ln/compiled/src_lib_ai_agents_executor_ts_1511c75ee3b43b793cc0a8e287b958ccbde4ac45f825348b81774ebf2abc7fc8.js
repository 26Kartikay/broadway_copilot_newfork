"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.agentExecutor = agentExecutor;
const messages_1 = require("../core/messages");
const MAX_ITERATIONS = 5;
async function getFinalStructuredOutput(runner, conversation, outputSchema, traceBuffer, nodeName) {
    const lastMessage = conversation[conversation.length - 1];
    if (lastMessage instanceof messages_1.AssistantMessage) {
        const customPrompt = new messages_1.SystemMessage('Parse the user message which contains the output from a previous step into a JSON object ' +
            'that strictly adheres to the provided schema. ' +
            'Do not add any extra commentary or change any of the values.');
        const textContent = lastMessage.content
            .filter((p) => p.type === 'text')
            .map((p) => p.text)
            .join('');
        const parsingConversation = [new messages_1.UserMessage(textContent)];
        const structuredRunner = runner.withStructuredOutput(outputSchema);
        return await structuredRunner.run(customPrompt, parsingConversation, traceBuffer, nodeName);
    }
    else {
        throw new Error('Last message is not an assistant message');
    }
}
async function agentExecutor(runner, systemPrompt, history, options, traceBuffer, maxLoops = MAX_ITERATIONS) {
    const runnerWithTools = runner.bind(options.tools);
    const conversation = [...history];
    const seenToolCallIds = new Set();
    for (let i = 0; i < maxLoops; i++) {
        const { assistant, toolCalls } = await runnerWithTools.run(systemPrompt, conversation, traceBuffer, options.nodeName);
        conversation.push(assistant);
        if (toolCalls.length === 0) {
            break;
        }
        const toolResults = await Promise.all(toolCalls
            .filter((toolCall) => !seenToolCallIds.has(toolCall.id))
            .map(async (toolCall) => {
            seenToolCallIds.add(toolCall.id);
            const toolDef = options.tools.find((t) => t.name === toolCall.name);
            if (!toolDef) {
                return {
                    id: toolCall.id,
                    name: toolCall.name,
                    result: `Tool '${toolCall.name}' not found.`,
                    isError: true,
                };
            }
            try {
                const parsedArgs = toolDef.schema.parse(toolCall.arguments);
                const result = await Promise.resolve(toolDef.func(parsedArgs));
                return {
                    id: toolCall.id,
                    name: toolDef.name,
                    result,
                    isError: false,
                };
            }
            catch (error) {
                return {
                    id: toolCall.id,
                    name: toolCall.name,
                    result: `Error executing tool '${toolCall.name}': ${error instanceof Error ? error.message : String(error)}`,
                    isError: true,
                };
            }
        }));
        if (toolResults.length === 0) {
            break;
        }
        toolResults.forEach((toolResult) => {
            conversation.push(new messages_1.ToolMessage(JSON.stringify(toolResult.result, null, 2), toolResult.id, toolResult.name, toolResult.isError));
        });
    }
    return await getFinalStructuredOutput(runner, conversation, options.outputSchema, traceBuffer, options.nodeName);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9saWIvYWkvYWdlbnRzL2V4ZWN1dG9yLnRzIiwic291cmNlcyI6WyIvdXNyL3NyYy9hcHAvc3JjL2xpYi9haS9hZ2VudHMvZXhlY3V0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFpR0Esc0NBMkZDO0FBekxELCtDQU8wQjtBQUcxQixNQUFNLGNBQWMsR0FBRyxDQUFDLENBQUM7QUFZekIsS0FBSyxVQUFVLHdCQUF3QixDQUNyQyxNQUFxQixFQUNyQixZQUEyQixFQUMzQixZQUFlLEVBQ2YsV0FBd0IsRUFDeEIsUUFBZ0I7SUFFaEIsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFHMUQsSUFBSSxXQUFXLFlBQVksMkJBQWdCLEVBQUUsQ0FBQztRQUM1QyxNQUFNLFlBQVksR0FBRyxJQUFJLHdCQUFhLENBQ3BDLDJGQUEyRjtZQUN6RixnREFBZ0Q7WUFDaEQsOERBQThELENBQ2pFLENBQUM7UUFFRixNQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsT0FBTzthQUNwQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQWlCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQzthQUMvQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDbEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRVosTUFBTSxtQkFBbUIsR0FBa0IsQ0FBQyxJQUFJLHNCQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUUxRSxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNuRSxPQUFPLE1BQU0sZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxtQkFBbUIsRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDOUYsQ0FBQztTQUFNLENBQUM7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QUFFLENBQUM7WUFDN0IsTUFBTTtRQUNSLENBQUM7UUFFRCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsWUFBWSxDQUFDLElBQUksQ0FDZixJQUFJLHNCQUFXLENBQ2IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsRUFDMUMsVUFBVSxDQUFDLEVBQUUsRUFDYixVQUFVLENBQUMsSUFBSSxFQUNmLFVBQVUsQ0FBQyxPQUFPLENBQ25CLENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sTUFBTSx3QkFBd0IsQ0FDbkMsTUFBTSxFQUNOLFlBQVksRUFDWixPQUFPLENBQUMsWUFBWSxFQUNwQixXQUFXLEVBQ1gsT0FBTyxDQUFDLFFBQVEsQ0FDakIsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBab2RUeXBlIH0gZnJvbSAnem9kJztcbmltcG9ydCB7IFRyYWNlQnVmZmVyIH0gZnJvbSAnLi4vLi4vLi4vYWdlbnQvdHJhY2luZyc7XG5pbXBvcnQgeyBCYXNlQ2hhdE1vZGVsIH0gZnJvbSAnLi4vY29yZS9iYXNlX2NoYXRfbW9kZWwnO1xuaW1wb3J0IHtcbiAgQXNzaXN0YW50TWVzc2FnZSxcbiAgQmFzZU1lc3NhZ2UsXG4gIFN5c3RlbU1lc3NhZ2UsXG4gIFRleHRQYXJ0LFxuICBUb29sTWVzc2FnZSxcbiAgVXNlck1lc3NhZ2UsXG59IGZyb20gJy4uL2NvcmUvbWVzc2FnZXMnO1xuaW1wb3J0IHsgVG9vbCB9IGZyb20gJy4uL2NvcmUvdG9vbHMnO1xuXG5jb25zdCBNQVhfSVRFUkFUSU9OUyA9IDU7XG5cbi8qKlxuICogUGFyc2VzIHRoZSBmaW5hbCBhc3Npc3RhbnQgbWVzc2FnZSBpbnRvIGEgc3RydWN0dXJlZCBKU09OIG91dHB1dC5cbiAqIEl0IHRha2VzIHRoZSBsYXN0IG1lc3NhZ2UsIGlmIGl0J3MgZnJvbSB0aGUgYXNzaXN0YW50LCBhbmQgYXNrcyB0aGUgbW9kZWxcbiAqIHRvIGZvcm1hdCBpdCBpbnRvIHRoZSBkZXNpcmVkIHNjaGVtYSB3aXRoIGEgc3BlY2lmaWMsIGRpcmVjdCBwcm9tcHQuXG4gKlxuICogQHBhcmFtIHJ1bm5lciBUaGUgY2hhdCBtb2RlbCBpbnN0YW5jZS5cbiAqIEBwYXJhbSBjb252ZXJzYXRpb24gVGhlIGZ1bGwgY29udmVyc2F0aW9uIGhpc3RvcnkuXG4gKiBAcGFyYW0gb3V0cHV0U2NoZW1hIFRoZSBab2Qgc2NoZW1hIGZvciB0aGUgZmluYWwgb3V0cHV0LlxuICogQHJldHVybnMgQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gdGhlIHN0cnVjdHVyZWQgb3V0cHV0LlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRGaW5hbFN0cnVjdHVyZWRPdXRwdXQ8VCBleHRlbmRzIFpvZFR5cGU+KFxuICBydW5uZXI6IEJhc2VDaGF0TW9kZWwsXG4gIGNvbnZlcnNhdGlvbjogQmFzZU1lc3NhZ2VbXSxcbiAgb3V0cHV0U2NoZW1hOiBULFxuICB0cmFjZUJ1ZmZlcjogVHJhY2VCdWZmZXIsXG4gIG5vZGVOYW1lOiBzdHJpbmcsXG4pOiBQcm9taXNlPFRbJ19vdXRwdXQnXT4ge1xuICBjb25zdCBsYXN0TWVzc2FnZSA9IGNvbnZlcnNhdGlvbltjb252ZXJzYXRpb24ubGVuZ3RoIC0gMV07XG5cbiAgLy8gSWYgdGhlIGxhc3QgbWVzc2FnZSBpcyBhbiBhc3Npc3RhbnQncyBtZXNzYWdlLCB1c2UgaXQgZm9yIHBhcnNpbmcuXG4gIGlmIChsYXN0TWVzc2FnZSBpbnN0YW5jZW9mIEFzc2lzdGFudE1lc3NhZ2UpIHtcbiAgICBjb25zdCBjdXN0b21Qcm9tcHQgPSBuZXcgU3lzdGVtTWVzc2FnZShcbiAgICAgICdQYXJzZSB0aGUgdXNlciBtZXNzYWdlIHdoaWNoIGNvbnRhaW5zIHRoZSBvdXRwdXQgZnJvbSBhIHByZXZpb3VzIHN0ZXAgaW50byBhIEpTT04gb2JqZWN0ICcgK1xuICAgICAgICAndGhhdCBzdHJpY3RseSBhZGhlcmVzIHRvIHRoZSBwcm92aWRlZCBzY2hlbWEuICcgK1xuICAgICAgICAnRG8gbm90IGFkZCBhbnkgZXh0cmEgY29tbWVudGFyeSBvciBjaGFuZ2UgYW55IG9mIHRoZSB2YWx1ZXMuJyxcbiAgICApO1xuXG4gICAgY29uc3QgdGV4dENvbnRlbnQgPSBsYXN0TWVzc2FnZS5jb250ZW50XG4gICAgICAuZmlsdGVyKChwKTogcCBpcyBUZXh0UGFydCA9PiBwLnR5cGUgPT09ICd0ZXh0JylcbiAgICAgIC5tYXAoKHApID0+IHAudGV4dClcbiAgICAgIC5qb2luKCcnKTtcblxuICAgIGNvbnN0IHBhcnNpbmdDb252ZXJzYXRpb246IEJhc2VNZXNzYWdlW10gPSBbbmV3IFVzZXJNZXNzYWdlKHRleHRDb250ZW50KV07XG5cbiAgICBjb25zdCBzdHJ1Y3R1cmVkUnVubmVyID0gcnVubmVyLndpdGhTdHJ1Y3R1cmVkT3V0cHV0KG91dHB1dFNjaGVtYSk7XG4gICAgcmV0dXJuIGF3YWl0IHN0cnVjdHVyZWRSdW5uZXIucnVuKGN1c3RvbVByb21wdCwgcGFyc2luZ0NvbnZlcnNhdGlvbiwgdHJhY2VCdWZmZXIsIG5vZGVOYW1lKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xhc3QgbWVzc2FnZSBpcyBub3QgYW4gYXNzaXN0YW50IG1lc3NhZ2UnKTtcbiAgfVxufVxuXG4vKipcbiAqIE9yY2hlc3RyYXRlcyBhbiBhZ2VudGljIGxvb3Agb2YgbW9kZWwgY2FsbHMgYW5kIHRvb2wgZXhlY3V0aW9ucyB0byBmdWxmaWxsIGEgdXNlciByZXF1ZXN0LlxuICogVGhlIGV4ZWN1dG9yIG1hbmFnZXMgdGhlIGNvbnZlcnNhdGlvbiBoaXN0b3J5LCBjYWxscyB0b29scyB3aGVuIHJlcXVlc3RlZCBieSB0aGUgbW9kZWwsXG4gKiBhbmQgZmVlZHMgdGhlIHJlc3VsdHMgYmFjayB0byB0aGUgbW9kZWwgdW50aWwgYSBmaW5hbCBhbnN3ZXIgaXMgZ2VuZXJhdGVkLlxuICpcbiAqIEBwYXJhbSBydW5uZXIgVGhlIGNoYXQgbW9kZWwgaW5zdGFuY2UgdG8gdXNlLlxuICogQHBhcmFtIHN5c3RlbVByb21wdCBBIGd1aWRpbmcgcHJvbXB0IGZvciB0aGUgYWdlbnQncyBwZXJzb25hIGFuZCBvYmplY3RpdmUuXG4gKiBAcGFyYW0gaGlzdG9yeSBUaGUgaW5pdGlhbCBjb252ZXJzYXRpb24gaGlzdG9yeSwgdHlwaWNhbGx5IHN0YXJ0aW5nIHdpdGggYSB1c2VyIG1lc3NhZ2UuXG4gKiBAcGFyYW0gb3B0aW9ucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgbGlzdCBvZiBhdmFpbGFibGUgYHRvb2xzYCBhbmQgYSBab2QgYG91dHB1dFNjaGVtYWAuXG4gKiBAcGFyYW0gbWF4TG9vcHMgVGhlIG1heGltdW0gbnVtYmVyIG9mIHRvb2wtY2FsbCBpdGVyYXRpb25zIGJlZm9yZSBzdG9wcGluZy4gRGVmYXVsdHMgdG8gNS5cbiAqIEByZXR1cm5zIEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSBzdHJ1Y3R1cmVkIG91dHB1dC5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHlwZXNjcmlwdFxuICogaW1wb3J0IHsgeiB9IGZyb20gJ3pvZCc7XG4gKiBpbXBvcnQgeyBUb29sIH0gZnJvbSAnLi4vY29yZS90b29scyc7XG4gKiBpbXBvcnQgeyBDaGF0T3BlbkFJIH0gZnJvbSAnLi4vb3BlbmFpL2NoYXRfbW9kZWxzJztcbiAqXG4gKiBjb25zdCBtb2RlbCA9IG5ldyBDaGF0T3BlbkFJKHsgbW9kZWw6ICdncHQtNG8tbWluaScgfSk7XG4gKiBjb25zdCB3ZWF0aGVyVG9vbCA9IG5ldyBUb29sKHtcbiAqICAgbmFtZTogJ2dldF93ZWF0aGVyJyxcbiAqICAgZGVzY3JpcHRpb246ICdHZXQgd2VhdGhlciBmb3IgYSBsb2NhdGlvbicsXG4gKiAgIHNjaGVtYTogei5vYmplY3QoeyBsb2NhdGlvbjogei5zdHJpbmcoKSB9KSxcbiAqICAgZnVuYzogYXN5bmMgKHsgbG9jYXRpb24gfSkgPT4gYFRoZSB3ZWF0aGVyIGluICR7bG9jYXRpb259IGlzIHN1bm55LmAsXG4gKiB9KTtcbiAqXG4gKiBjb25zdCBvdXRwdXQgPSBhd2FpdCBhZ2VudEV4ZWN1dG9yKFxuICogICBtb2RlbCxcbiAqICAgbmV3IFN5c3RlbU1lc3NhZ2UoJ1lvdSBhcmUgYSBoZWxwZnVsIHdlYXRoZXIgYXNzaXN0YW50LicpLFxuICogICBbbmV3IFVzZXJNZXNzYWdlKCdXaGF0IGlzIHRoZSB3ZWF0aGVyIGluIE5ldyBZb3JrPycpXSxcbiAqICAge1xuICogICAgIHRvb2xzOiBbd2VhdGhlclRvb2xdLFxuICogICAgIG91dHB1dFNjaGVtYTogei5vYmplY3QoeyB3ZWF0aGVyOiB6LnN0cmluZygpIH0pLFxuICogICAgIG5vZGVOYW1lOiAnd2VhdGhlckFnZW50JyxcbiAqICAgfSxcbiAqICAgdHJhY2VCdWZmZXIsXG4gKiApO1xuICpcbiAqIC8vIG91dHB1dC53ZWF0aGVyIG1pZ2h0IGJlOiBcIlRoZSB3ZWF0aGVyIGluIE5ldyBZb3JrIGlzIHN1bm55LlwiXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFnZW50RXhlY3V0b3I8VCBleHRlbmRzIFpvZFR5cGU+KFxuICBydW5uZXI6IEJhc2VDaGF0TW9kZWwsXG4gIHN5c3RlbVByb21wdDogU3lzdGVtTWVzc2FnZSxcbiAgaGlzdG9yeTogQmFzZU1lc3NhZ2VbXSxcbiAgb3B0aW9uczoge1xuICAgIHRvb2xzOiBUb29sW107XG4gICAgb3V0cHV0U2NoZW1hOiBUO1xuICAgIG5vZGVOYW1lOiBzdHJpbmc7XG4gIH0sXG4gIHRyYWNlQnVmZmVyOiBUcmFjZUJ1ZmZlcixcbiAgbWF4TG9vcHM6IG51bWJlciA9IE1BWF9JVEVSQVRJT05TLFxuKTogUHJvbWlzZTxUWydfb3V0cHV0J10+IHtcbiAgY29uc3QgcnVubmVyV2l0aFRvb2xzID0gcnVubmVyLmJpbmQob3B0aW9ucy50b29scyk7XG5cbiAgY29uc3QgY29udmVyc2F0aW9uOiBCYXNlTWVzc2FnZVtdID0gWy4uLmhpc3RvcnldO1xuXG4gIGNvbnN0IHNlZW5Ub29sQ2FsbElkcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4TG9vcHM7IGkrKykge1xuICAgIGNvbnN0IHsgYXNzaXN0YW50LCB0b29sQ2FsbHMgfSA9IGF3YWl0IHJ1bm5lcldpdGhUb29scy5ydW4oXG4gICAgICBzeXN0ZW1Qcm9tcHQsXG4gICAgICBjb252ZXJzYXRpb24sXG4gICAgICB0cmFjZUJ1ZmZlcixcbiAgICAgIG9wdGlvbnMubm9kZU5hbWUsXG4gICAgKTtcblxuICAgIGNvbnZlcnNhdGlvbi5wdXNoKGFzc2lzdGFudCk7XG5cbiAgICBpZiAodG9vbENhbGxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3QgdG9vbFJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHRvb2xDYWxsc1xuICAgICAgICAuZmlsdGVyKCh0b29sQ2FsbCkgPT4gIXNlZW5Ub29sQ2FsbElkcy5oYXModG9vbENhbGwuaWQpKVxuICAgICAgICAubWFwKGFzeW5jICh0b29sQ2FsbCkgPT4ge1xuICAgICAgICAgIHNlZW5Ub29sQ2FsbElkcy5hZGQodG9vbENhbGwuaWQpO1xuICAgICAgICAgIGNvbnN0IHRvb2xEZWYgPSBvcHRpb25zLnRvb2xzLmZpbmQoKHQpID0+IHQubmFtZSA9PT0gdG9vbENhbGwubmFtZSk7XG4gICAgICAgICAgaWYgKCF0b29sRGVmKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBpZDogdG9vbENhbGwuaWQsXG4gICAgICAgICAgICAgIG5hbWU6IHRvb2xDYWxsLm5hbWUsXG4gICAgICAgICAgICAgIHJlc3VsdDogYFRvb2wgJyR7dG9vbENhbGwubmFtZX0nIG5vdCBmb3VuZC5gLFxuICAgICAgICAgICAgICBpc0Vycm9yOiB0cnVlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSB0b29sRGVmLnNjaGVtYS5wYXJzZSh0b29sQ2FsbC5hcmd1bWVudHMpO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKHRvb2xEZWYuZnVuYyhwYXJzZWRBcmdzKSk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICBpZDogdG9vbENhbGwuaWQsXG4gICAgICAgICAgICAgIG5hbWU6IHRvb2xEZWYubmFtZSxcbiAgICAgICAgICAgICAgcmVzdWx0LFxuICAgICAgICAgICAgICBpc0Vycm9yOiBmYWxzZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGlkOiB0b29sQ2FsbC5pZCxcbiAgICAgICAgICAgICAgbmFtZTogdG9vbENhbGwubmFtZSxcbiAgICAgICAgICAgICAgcmVzdWx0OiBgRXJyb3IgZXhlY3V0aW5nIHRvb2wgJyR7dG9vbENhbGwubmFtZX0nOiAke1xuICAgICAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKVxuICAgICAgICAgICAgICB9YCxcbiAgICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICApO1xuXG4gICAgaWYgKHRvb2xSZXN1bHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgdG9vbFJlc3VsdHMuZm9yRWFjaCgodG9vbFJlc3VsdCkgPT4ge1xuICAgICAgY29udmVyc2F0aW9uLnB1c2goXG4gICAgICAgIG5ldyBUb29sTWVzc2FnZShcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0b29sUmVzdWx0LnJlc3VsdCwgbnVsbCwgMiksXG4gICAgICAgICAgdG9vbFJlc3VsdC5pZCxcbiAgICAgICAgICB0b29sUmVzdWx0Lm5hbWUsXG4gICAgICAgICAgdG9vbFJlc3VsdC5pc0Vycm9yLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBnZXRGaW5hbFN0cnVjdHVyZWRPdXRwdXQoXG4gICAgcnVubmVyLFxuICAgIGNvbnZlcnNhdGlvbixcbiAgICBvcHRpb25zLm91dHB1dFNjaGVtYSxcbiAgICB0cmFjZUJ1ZmZlcixcbiAgICBvcHRpb25zLm5vZGVOYW1lLFxuICApO1xufVxuIl19