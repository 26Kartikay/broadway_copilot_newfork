"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendText = sendText;
exports.sendMenu = sendMenu;
exports.sendImage = sendImage;
exports.validateTwilioRequest = validateTwilioRequest;
exports.processStatusCallback = processStatusCallback;
require("dotenv/config");
const twilio_1 = __importDefault(require("twilio"));
const RequestClient_1 = __importDefault(require("twilio/lib/base/RequestClient"));
const constants_1 = require("../utils/constants");
const errors_1 = require("../utils/errors");
const logger_1 = require("../utils/logger");
const redis_1 = require("./redis");
let subscriber;
async function getSubscriber() {
    if (!subscriber || !subscriber.isOpen) {
        const client = redis_1.redis.duplicate();
        await client.connect();
        subscriber = client;
    }
    if (!subscriber) {
        throw new errors_1.InternalServerError('Failed to initialize Redis subscriber');
    }
    return subscriber;
}
let cachedClient;
function getTwilioClient() {
    if (cachedClient)
        return cachedClient;
    const accountSid = process.env.TWILIO_ACCOUNT_SID;
    const authToken = process.env.TWILIO_AUTH_TOKEN;
    if (!accountSid || !authToken)
        throw new errors_1.InternalServerError('Twilio credentials missing');
    const httpClient = new RequestClient_1.default({
        keepAlive: true,
        timeout: Number(process.env.TWILIO_HTTP_TIMEOUT_MS || 10000),
    });
    const clientOptions = {
        httpClient,
        userAgentExtensions: ['broadway-copilot'],
    };
    clientOptions.edge = 'singapore';
    cachedClient = (0, twilio_1.default)(accountSid, authToken, clientOptions);
    return cachedClient;
}
async function sendText(to, body, imageUrl) {
    const client = getTwilioClient();
    const fromNumber = process.env.TWILIO_WHATSAPP_FROM || 'whatsapp:+14155238886';
    try {
        const messageOptions = {
            body,
            from: fromNumber,
            to: `whatsapp:+${to}`,
        };
        if (imageUrl) {
            messageOptions.mediaUrl = [imageUrl];
        }
        addStatusCallback(messageOptions);
        const resp = await client.messages.create(messageOptions);
        logger_1.logger.debug({ sid: resp.sid, to }, 'Sent text message');
        await awaitStatuses(resp.sid);
    }
    catch (err) {
        handleTwilioError(err);
    }
}
async function sendMenu(to, replyText, buttons) {
    const client = getTwilioClient();
    const fromNumber = process.env.TWILIO_WHATSAPP_FROM || 'whatsapp:+14155238886';
    if (buttons.length < 2 || buttons.length > 3) {
        logger_1.logger.warn(`Invalid button count ${buttons.length}; must be 2 or 3. Falling back to text`);
        await sendText(to, replyText);
        return;
    }
    const tonalityOptions = ['Hype BFF', 'Friendly', 'Savage'];
    const styleStudioOptions = ['Style for any occasion', 'Vacation looks', 'General styling'];
    const isTonality = buttons.length === 3 && buttons.every((b) => tonalityOptions.includes(b.text.trim()));
    const isStyleStudio = buttons.length >= 2 && buttons.some((b) => styleStudioOptions.includes(b.text.trim()));
    const contentSid = isTonality
        ? constants_1.TWILIO_QUICKREPLY_TONALITY_SID
        : isStyleStudio
            ? constants_1.TWILIO_QUICKREPLY_STYLING_SID
            : buttons.length === 2
                ? constants_1.TWILIO_QUICKREPLY2_SID
                : constants_1.TWILIO_QUICKREPLY3_SID;
    const templateLocales = {
        [constants_1.TWILIO_QUICKREPLY_TONALITY_SID]: 'en',
        [constants_1.TWILIO_QUICKREPLY2_SID]: 'en',
        [constants_1.TWILIO_QUICKREPLY3_SID]: 'en',
        [constants_1.TWILIO_QUICKREPLY_STYLING_SID]: 'en',
    };
    const localeCode = templateLocales[contentSid] || 'en';
    const contentVariables = {};
    const payload = {
        contentSid,
        contentVariables: JSON.stringify(contentVariables),
        from: fromNumber,
        to: `whatsapp:+${to}`,
        language: { code: localeCode },
    };
    addStatusCallback(payload);
    try {
        const resp = await client.messages.create(payload);
        logger_1.logger.debug({ sid: resp.sid, to, buttonCount: buttons.length }, 'Sent menu message');
        await awaitStatuses(resp.sid);
    }
    catch (err) {
        handleTwilioError(err);
    }
}
async function sendImage(to, imageUrl, caption) {
    await sendText(to, caption || '', imageUrl);
    logger_1.logger.debug({ to, imageUrl }, 'Sent image message');
}
async function awaitStatuses(sid) {
    const configuredToWait = process.env.TWILIO_WAIT_FOR_STATUS === 'true';
    if (!configuredToWait)
        return;
    logger_1.logger.debug({ sid }, 'Waiting for message status updates');
    const sentTimeoutMs = Number(process.env.TWILIO_SENT_TIMEOUT_MS || 5000);
    const deliveredTimeoutMs = Number(process.env.TWILIO_DELIVERED_TIMEOUT_MS || 15000);
    const channel = `twilio:status:${sid}`;
    const seenStatusesKey = `twilio:seen:${sid}`;
    const sub = await getSubscriber();
    let resolveSent;
    let resolveDelivered;
    const sentPromise = new Promise((resolve) => {
        resolveSent = resolve;
    });
    const deliveredPromise = new Promise((resolve) => {
        resolveDelivered = resolve;
    });
    const listener = (message) => {
        if (message === 'sent') {
            resolveSent();
        }
        else if (message === 'delivered' || message === 'failed' || message === 'undelivered') {
            resolveDelivered();
        }
    };
    await sub.subscribe(channel, listener);
    const preSeenStatuses = await redis_1.redis.sMembers(seenStatusesKey);
    if (preSeenStatuses.includes('sent')) {
        resolveSent();
    }
    if (preSeenStatuses.some((s) => ['delivered', 'failed', 'undelivered'].includes(s))) {
        resolveDelivered();
    }
    const sentTimer = setTimeout(() => {
        logger_1.logger.warn({ sid, timeout: sentTimeoutMs }, 'Timed out waiting for "sent" status');
        resolveSent();
    }, sentTimeoutMs);
    await sentPromise;
    clearTimeout(sentTimer);
    logger_1.logger.debug({ sid }, 'Received "sent" status');
    const deliveredTimer = setTimeout(() => {
        logger_1.logger.warn({ sid, timeout: deliveredTimeoutMs }, 'Timed out waiting for "delivered" status');
        resolveDelivered();
    }, deliveredTimeoutMs);
    await deliveredPromise;
    clearTimeout(deliveredTimer);
    logger_1.logger.debug({ sid }, 'Received "delivered" status');
    await sub.unsubscribe(channel);
    redis_1.redis.del(seenStatusesKey);
}
function addStatusCallback(options) {
    const serverUrl = process.env.SERVER_URL?.replace(/\/$/, '') || '';
    if (serverUrl) {
        options.statusCallback = `${serverUrl}/twilio/callback/`;
    }
}
function handleTwilioError(err) {
    if (err && err.code === 20003) {
        logger_1.logger.error('Twilio auth failed (401). Verify TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN.');
        throw new errors_1.UnauthorizedError('Twilio authentication failed');
    }
    if (err && err.code === 21211) {
        logger_1.logger.error('Invalid phone number format');
        throw new errors_1.BadRequestError('Invalid phone number format');
    }
    if (err && err.code === 21610) {
        logger_1.logger.error('Message blocked by carrier');
        throw new errors_1.ServiceUnavailableError('Message delivery blocked');
    }
    logger_1.logger.error({ err }, 'Twilio API error');
    throw new errors_1.ServiceUnavailableError('Message delivery failed');
}
function validateTwilioRequest(req) {
    try {
        const signature = req.header('X-Twilio-Signature') || req.header('x-twilio-signature');
        const protoHeader = req.headers['x-forwarded-proto'] || req.protocol;
        const hostHeader = req.headers['x-forwarded-host'] || req.get('host');
        const fullUrl = `${protoHeader}://${hostHeader}${req.originalUrl}`;
        const authToken = process.env.TWILIO_AUTH_TOKEN;
        if (process.env.TWILIO_VALIDATE_WEBHOOK === 'false')
            return true;
        if (!authToken) {
            logger_1.logger.warn('Twilio auth token not configured');
            return false;
        }
        if (!signature) {
            logger_1.logger.warn('Missing Twilio signature header');
            return false;
        }
        return twilio_1.default.validateRequest(authToken, signature, fullUrl, req.body);
    }
    catch (err) {
        logger_1.logger.error({ err: err instanceof Error ? err.message : String(err) }, 'Error validating Twilio request');
        return false;
    }
}
function processStatusCallback(payload) {
    if (!payload) {
        logger_1.logger.warn('Empty callback payload received');
        return;
    }
    const sid = payload?.MessageSid || payload?.SmsSid;
    const status = payload?.MessageStatus || payload?.SmsStatus;
    if (!sid || !status) {
        logger_1.logger.warn({ payload }, 'Invalid callback payload: missing sid or status');
        return;
    }
    const statusLower = status.toLowerCase();
    const channel = `twilio:status:${sid}`;
    const seenStatusesKey = `twilio:seen:${sid}`;
    redis_1.redis.publish(channel, statusLower);
    redis_1.redis.sAdd(seenStatusesKey, statusLower);
    redis_1.redis.expire(seenStatusesKey, 300);
    switch (statusLower) {
        case 'sent':
            logger_1.logger.debug({ sid }, 'Message sent successfully');
            break;
        case 'delivered':
            logger_1.logger.info({ sid }, 'Message delivered successfully');
            break;
        case 'failed':
        case 'undelivered':
            logger_1.logger.warn({ sid, status }, 'Message delivery failed');
            break;
        case 'queued':
        case 'sending':
            break;
        default:
            logger_1.logger.warn({ sid, status: statusLower }, 'Unknown message status received');
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9saWIvdHdpbGlvLnRzIiwic291cmNlcyI6WyIvdXNyL3NyYy9hcHAvc3JjL2xpYi90d2lsaW8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFvRUEsNEJBbUJDO0FBRUQsNEJBNERDO0FBRUQsOEJBR0M7QUEyRkQsc0RBeUJDO0FBRUQsc0RBd0NDO0FBeFRELHlCQUF1QjtBQUd2QixvREFBd0M7QUFFeEMsa0ZBQTBEO0FBQzFELGtEQUs0QjtBQUM1Qiw0Q0FLeUI7QUFDekIsNENBQXlDO0FBQ3pDLG1DQUFnQztBQVdoQyxJQUFJLFVBQXVDLENBQUM7QUFFNUMsS0FBSyxVQUFVLGFBQWE7SUFDMUIsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN0QyxNQUFNLE1BQU0sR0FBRyxhQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakMsTUFBTSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDdkIsVUFBVSxHQUFHLE1BQU0sQ0FBQztJQUN0QixDQUFDO0lBRUQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2hCLE1BQU0sSUFBSSw0QkFBbUIsQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCxPQUFPLFVBQVUsQ0FBQztBQUNwQixDQUFDO0FBRUQsSUFBSSxZQUFnQyxDQUFDO0FBRXJDLFNBQVMsZUFBZTtJQUN0QixJQUFJLFlBQVk7UUFBRSxPQUFPLFlBQVksQ0FBQztJQUN0QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0lBQ2xELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUM7SUFDaEQsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFNBQVM7UUFBRSxNQUFNLElBQUksNEJBQW1CLENBQUMsNEJBQTRCLENBQUMsQ0FBQztJQUUzRixNQUFNLFVBQVUsR0FBRyxJQUFJLHVC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T0FBTyxFQUFFLEVBQUUsaURBQWlELENBQUMsQ0FBQztRQUM1RSxPQUFPO0lBQ1QsQ0FBQztJQUVELE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN6QyxNQUFNLE9BQU8sR0FBRyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7SUFDdkMsTUFBTSxlQUFlLEdBQUcsZUFBZSxHQUFHLEVBQUUsQ0FBQztJQUU3QyxhQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUVwQyxhQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6QyxhQUFLLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUVuQyxRQUFRLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLEtBQUssTUFBTTtZQUNULGVBQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSwyQkFBMkIsQ0FBQyxDQUFDO1lBQ25ELE1BQU07UUFDUixLQUFLLFdBQVc7WUFDZCxlQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsZ0NBQWdDLENBQUMsQ0FBQztZQUN2RCxNQUFNO1FBQ1IsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLGFBQWE7WUFDaEIsZUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO1lBQ3hELE1BQU07UUFDUixLQUFLLFFBQVEsQ0FBQztRQUNkLEtBQUssU0FBUztZQUNaLE1BQU07UUFDUjtZQUNFLGVBQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFLGlDQUFpQyxDQUFDLENBQUM7SUFDakYsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2RvdGVudi9jb25maWcnO1xuXG5pbXBvcnQgeyBSZXF1ZXN0IH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgdHdpbGlvLCB7IFR3aWxpbyB9IGZyb20gJ3R3aWxpbyc7XG5cbmltcG9ydCBSZXF1ZXN0Q2xpZW50IGZyb20gJ3R3aWxpby9saWIvYmFzZS9SZXF1ZXN0Q2xpZW50JztcbmltcG9ydCB7XG4gIFRXSUxJT19RVUlDS1JFUExZMl9TSUQsXG4gIFRXSUxJT19RVUlDS1JFUExZM19TSUQsXG4gIFRXSUxJT19RVUlDS1JFUExZX1NUWUxJTkdfU0lELFxuICBUV0lMSU9fUVVJQ0tSRVBMWV9UT05BTElUWV9TSUQsXG59IGZyb20gJy4uL3V0aWxzL2NvbnN0YW50cyc7XG5pbXBvcnQge1xuICBCYWRSZXF1ZXN0RXJyb3IsXG4gIEludGVybmFsU2VydmVyRXJyb3IsXG4gIFNlcnZpY2VVbmF2YWlsYWJsZUVycm9yLFxuICBVbmF1dGhvcml6ZWRFcnJvcixcbn0gZnJvbSAnLi4vdXRpbHMvZXJyb3JzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyByZWRpcyB9IGZyb20gJy4vcmVkaXMnO1xuXG5pbXBvcnQge1xuICBRdWlja1JlcGx5QnV0dG9uLFxuICBUd2lsaW9BcGlFcnJvcixcbiAgVHdpbGlvTWVzc2FnZU9wdGlvbnMsXG4gIFR3aWxpb1N0YXR1c0NhbGxiYWNrUGF5bG9hZCxcbn0gZnJvbSAnLi90d2lsaW8vdHlwZXMnO1xuXG50eXBlIFJlZGlzU3Vic2NyaWJlciA9IFJldHVyblR5cGU8dHlwZW9mIHJlZGlzLmR1cGxpY2F0ZT47XG5cbmxldCBzdWJzY3JpYmVyOiBSZWRpc1N1YnNjcmliZXIgfCB1bmRlZmluZWQ7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFN1YnNjcmliZXIoKTogUHJvbWlzZTxSZWRpc1N1YnNjcmliZXI+IHtcbiAgaWYgKCFzdWJzY3JpYmVyIHx8ICFzdWJzY3JpYmVyLmlzT3Blbikge1xuICAgIGNvbnN0IGNsaWVudCA9IHJlZGlzLmR1cGxpY2F0ZSgpO1xuICAgIGF3YWl0IGNsaWVudC5jb25uZWN0KCk7XG4gICAgc3Vic2NyaWJlciA9IGNsaWVudDtcbiAgfVxuXG4gIGlmICghc3Vic2NyaWJlcikge1xuICAgIHRocm93IG5ldyBJbnRlcm5hbFNlcnZlckVycm9yKCdGYWlsZWQgdG8gaW5pdGlhbGl6ZSBSZWRpcyBzdWJzY3JpYmVyJyk7XG4gIH1cblxuICByZXR1cm4gc3Vic2NyaWJlcjtcbn1cblxubGV0IGNhY2hlZENsaWVudDogVHdpbGlvIHwgdW5kZWZpbmVkO1xuXG5mdW5jdGlvbiBnZXRUd2lsaW9DbGllbnQoKTogVHdpbGlvIHtcbiAgaWYgKGNhY2hlZENsaWVudCkgcmV0dXJuIGNhY2hlZENsaWVudDtcbiAgY29uc3QgYWNjb3VudFNpZCA9IHByb2Nlc3MuZW52LlRXSUxJT19BQ0NPVU5UX1NJRDtcbiAgY29uc3QgYXV0aFRva2VuID0gcHJvY2Vzcy5lbnYuVFdJTElPX0FVVEhfVE9LRU47XG4gIGlmICghYWNjb3VudFNpZCB8fCAhYXV0aFRva2VuKSB0aHJvdyBuZXcgSW50ZXJuYWxTZXJ2ZXJFcnJvcignVHdpbGlvIGNyZWRlbnRpYWxzIG1pc3NpbmcnKTtcblxuICBjb25zdCBodHRwQ2xpZW50ID0gbmV3IFJlcXVlc3RDbGllbnQoe1xuICAgIGtlZXBBbGl2ZTogdHJ1ZSxcbiAgICB0aW1lb3V0OiBOdW1iZXIocHJvY2Vzcy5lbnYuVFdJTElPX0hUVFBfVElNRU9VVF9NUyB8fCAxMDAwMCksXG4gIH0pO1xuXG4gIGNvbnN0IGNsaWVudE9wdGlvbnM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge1xuICAgIGh0dHBDbGllbnQsXG4gICAgdXNlckFnZW50RXh0ZW5zaW9uczogWydicm9hZHdheS1jb3BpbG90J10sXG4gIH07XG4gIGNsaWVudE9wdGlvbnMuZWRnZSA9ICdzaW5nYXBvcmUnO1xuICBjYWNoZWRDbGllbnQgPSB0d2lsaW8oYWNjb3VudFNpZCwgYXV0aFRva2VuLCBjbGllbnRPcHRpb25zKTtcbiAgcmV0dXJuIGNhY2hlZENsaWVudDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRUZXh0KHRvOiBzdHJpbmcsIGJvZHk6IHN0cmluZywgaW1hZ2VVcmw/OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgY2xpZW50ID0gZ2V0VHdpbGlvQ2xpZW50KCk7XG4gIGNvbnN0IGZyb21OdW1iZXIgPSBwcm9jZXNzLmVudi5UV0lMSU9fV0hBVFNBUFBfRlJPTSB8fCAnd2hhdHNhcHA6KzE0MTU1MjM4ODg2JztcbiAgdHJ5IHtcbiAgICBjb25zdCBtZXNzYWdlT3B0aW9uczogVHdpbGlvTWVzc2FnZU9wdGlvbnMgPSB7XG4gICAgICBib2R5LFxuICAgICAgZnJvbTogZnJvbU51bWJlcixcbiAgICAgIHRvOiBgd2hhdHNhcHA6KyR7dG99YCxcbiAgICB9O1xuICAgIGlmIChpbWFnZVVybCkge1xuICAgICAgbWVzc2FnZU9wdGlvbnMubWVkaWFVcmwgPSBbaW1hZ2VVcmxdO1xuICAgIH1cbiAgICBhZGRTdGF0dXNDYWxsYmFjayhtZXNzYWdlT3B0aW9ucyk7XG4gICAgY29uc3QgcmVzcCA9IGF3YWl0IGNsaWVudC5tZXNzYWdlcy5jcmVhdGUobWVzc2FnZU9wdGlvbnMpO1xuICAgIGxvZ2dlci5kZWJ1Zyh7IHNpZDogcmVzcC5zaWQsIHRvIH0sICdTZW50IHRleHQgbWVzc2FnZScpO1xuICAgIGF3YWl0IGF3YWl0U3RhdHVzZXMocmVzcC5zaWQpO1xuICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICBoYW5kbGVUd2lsaW9FcnJvcihlcnIgYXMgVHdpbGlvQXBpRXJyb3IpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kTWVudShcbiAgdG86IHN0cmluZyxcbiAgcmVwbHlUZXh0OiBzdHJpbmcsXG4gIGJ1dHRvbnM6IHJlYWRvbmx5IFF1aWNrUmVwbHlCdXR0b25bXSxcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBjbGllbnQgPSBnZXRUd2lsaW9DbGllbnQoKTtcbiAgY29uc3QgZnJvbU51bWJlciA9IHByb2Nlc3MuZW52LlRXSUxJT19XSEFUU0FQUF9GUk9NIHx8ICd3aGF0c2FwcDorMTQxNTUyMzg4ODYnO1xuXG4gIGlmIChidXR0b25zLmxlbmd0aCA8IDIgfHwgYnV0dG9ucy5sZW5ndGggPiAzKSB7XG4gICAgbG9nZ2VyLndhcm4oYEludmFsaWQgYnV0dG9uIGNvdW50ICR7YnV0dG9ucy5sZW5ndGh9OyBtdXN0IGJlIDIgb3IgMy4gRmFsbGluZyBiYWNrIHRvIHRleHRgKTtcbiAgICBhd2FpdCBzZW5kVGV4dCh0bywgcmVwbHlUZXh0KTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB0b25hbGl0eU9wdGlvbnMgPSBbJ0h5cGUgQkZGJywgJ0ZyaWVuZGx5JywgJ1NhdmFnZSddO1xuICBjb25zdCBzdHlsZVN0dWRpb09wdGlvbnMgPSBbJ1N0eWxlIGZvciBhbnkgb2NjYXNpb24nLCAnVmFjYXRpb24gbG9va3MnLCAnR2VuZXJhbCBzdHlsaW5nJ107XG5cbiAgY29uc3QgaXNUb25hbGl0eSA9XG4gICAgYnV0dG9ucy5sZW5ndGggPT09IDMgJiYgYnV0dG9ucy5ldmVyeSgoYikgPT4gdG9uYWxpdHlPcHRpb25zLmluY2x1ZGVzKGIudGV4dC50cmltKCkpKTtcblxuICBjb25zdCBpc1N0eWxlU3R1ZGlvID1cbiAgICBidXR0b25zLmxlbmd0aCA+PSAyICYmIGJ1dHRvbnMuc29tZSgoYikgPT4gc3R5bGVTdHVkaW9PcHRpb25zLmluY2x1ZGVzKGIudGV4dC50cmltKCkpKTtcblxuICAvLyBVcGRhdGVkIHRlbXBsYXRlIFNJRCBzZWxlY3Rpb24gdG8gaW5jbHVkZSBTdHlsZSBTdHVkaW8gYnV0dG9uc1xuICBjb25zdCBjb250ZW50U2lkID0gaXNUb25hbGl0eVxuICAgID8gVFdJTElPX1FVSUNLUkVQTFlfVE9OQUxJVFlfU0lEXG4gICAgOiBpc1N0eWxlU3R1ZGlvXG4gICAgICA/IFRXSUxJT19RVUlDS1JFUExZX1NUWUxJTkdfU0lEXG4gICAgICA6IGJ1dHRvbnMubGVuZ3RoID09PSAyXG4gICAgICAgID8gVFdJTElPX1FVSUNLUkVQTFkyX1NJRFxuICAgICAgICA6IFRXSUxJT19RVUlDS1JFUExZM19TSUQ7XG5cbiAgY29uc3QgdGVtcGxhdGVMb2NhbGVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIFtUV0lMSU9fUVVJQ0tSRVBMWV9UT05BTElUWV9TSURdOiAnZW4nLFxuICAgIFtUV0lMSU9fUVVJQ0tSRVBMWTJfU0lEXTogJ2VuJyxcbiAgICBbVFdJTElPX1FVSUNLUkVQTFkzX1NJRF06ICdlbicsXG4gICAgW1RXSUxJT19RVUlDS1JFUExZX1NUWUxJTkdfU0lEXTogJ2VuJyxcbiAgfTtcblxuICBjb25zdCBsb2NhbGVDb2RlID0gdGVtcGxhdGVMb2NhbGVzW2NvbnRlbnRTaWRdIHx8ICdlbic7XG5cbiAgY29uc3QgY29udGVudFZhcmlhYmxlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgY29udGVudFNpZCxcbiAgICBjb250ZW50VmFyaWFibGVzOiBKU09OLnN0cmluZ2lmeShjb250ZW50VmFyaWFibGVzKSxcbiAgICBmcm9tOiBmcm9tTnVtYmVyLFxuICAgIHRvOiBgd2hhdHNhcHA6KyR7dG99YCxcbiAgICBsYW5ndWFnZTogeyBjb2RlOiBsb2NhbGVDb2RlIH0sXG4gIH0gYXMgdW5rbm93biBhcyBUd2lsaW9NZXNzYWdlT3B0aW9ucztcblxuICBhZGRTdGF0dXNDYWxsYmFjayhwYXlsb2FkKTtcblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBjbGllbnQubWVzc2FnZXMuY3JlYXRlKHBheWxvYWQpO1xuICAgIGxvZ2dlci5kZWJ1Zyh7IHNpZDogcmVzcC5zaWQsIHRvLCBidXR0b25Db3VudDogYnV0dG9ucy5sZW5ndGggfSwgJ1NlbnQgbWVudSBtZXNzYWdlJyk7XG4gICAgYXdhaXQgYXdhaXRTdGF0dXNlcyhyZXNwLnNpZCk7XG4gIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgIGhhbmRsZVR3aWxpb0Vycm9yKGVyciBhcyBUd2lsaW9BcGlFcnJvcik7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRJbWFnZSh0bzogc3RyaW5nLCBpbWFnZVVybDogc3RyaW5nLCBjYXB0aW9uPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IHNlbmRUZXh0KHRvLCBjYXB0aW9uIHx8ICcnLCBpbWFnZVVybCk7XG4gIGxvZ2dlci5kZWJ1Zyh7IHRvLCBpbWFnZVVybCB9LCAnU2VudCBpbWFnZSBtZXNzYWdlJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGF3YWl0U3RhdHVzZXMoc2lkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgY29uZmlndXJlZFRvV2FpdCA9IHByb2Nlc3MuZW52LlRXSUxJT19XQUlUX0ZPUl9TVEFUVVMgPT09ICd0cnVlJztcbiAgaWYgKCFjb25maWd1cmVkVG9XYWl0KSByZXR1cm47XG4gIGxvZ2dlci5kZWJ1Zyh7IHNpZCB9LCAnV2FpdGluZyBmb3IgbWVzc2FnZSBzdGF0dXMgdXBkYXRlcycpO1xuICBjb25zdCBzZW50VGltZW91dE1zID0gTnVtYmVyKHByb2Nlc3MuZW52LlRXSUxJT19TRU5UX1RJTUVPVVRfTVMgfHwgNTAwMCk7XG4gIGNvbnN0IGRlbGl2ZXJlZFRpbWVvdXRNcyA9IE51bWJlcihwcm9jZXNzLmVudi5UV0lMSU9fREVMSVZFUkVEX1RJTUVPVVRfTVMgfHwgMTUwMDApO1xuXG4gIGNvbnN0IGNoYW5uZWwgPSBgdHdpbGlvOnN0YXR1czoke3NpZH1gO1xuICBjb25zdCBzZWVuU3RhdHVzZXNLZXkgPSBgdHdpbGlvOnNlZW46JHtzaWR9YDtcblxuICBjb25zdCBzdWIgPSBhd2FpdCBnZXRTdWJzY3JpYmVyKCk7XG5cbiAgbGV0IHJlc29sdmVTZW50ITogKCkgPT4gdm9pZDtcbiAgbGV0IHJlc29sdmVEZWxpdmVyZWQhOiAoKSA9PiB2b2lkO1xuXG4gIGNvbnN0IHNlbnRQcm9taXNlID0gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICByZXNvbHZlU2VudCA9IHJlc29sdmU7XG4gIH0pO1xuICBjb25zdCBkZWxpdmVyZWRQcm9taXNlID0gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICByZXNvbHZlRGVsaXZlcmVkID0gcmVzb2x2ZTtcbiAgfSk7XG5cbiAgY29uc3QgbGlzdGVuZXIgPSAobWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKG1lc3NhZ2UgPT09ICdzZW50Jykge1xuICAgICAgcmVzb2x2ZVNlbnQoKTtcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UgPT09ICdkZWxpdmVyZWQnIHx8IG1lc3NhZ2UgPT09ICdmYWlsZWQnIHx8IG1lc3NhZ2UgPT09ICd1bmRlbGl2ZXJlZCcpIHtcbiAgICAgIHJlc29sdmVEZWxpdmVyZWQoKTtcbiAgICB9XG4gIH07XG5cbiAgYXdhaXQgc3ViLnN1YnNjcmliZShjaGFubmVsLCBsaXN0ZW5lcik7XG5cbiAgY29uc3QgcHJlU2VlblN0YXR1c2VzID0gYXdhaXQgcmVkaXMuc01lbWJlcnMoc2VlblN0YXR1c2VzS2V5KTtcbiAgaWYgKHByZVNlZW5TdGF0dXNlcy5pbmNsdWRlcygnc2VudCcpKSB7XG4gICAgcmVzb2x2ZVNlbnQoKTtcbiAgfVxuICBpZiAocHJlU2VlblN0YXR1c2VzLnNvbWUoKHMpID0+IFsnZGVsaXZlcmVkJywgJ2ZhaWxlZCcsICd1bmRlbGl2ZXJlZCddLmluY2x1ZGVzKHMpKSkge1xuICAgIHJlc29sdmVEZWxpdmVyZWQoKTtcbiAgfVxuXG4gIGNvbnN0IHNlbnRUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIGxvZ2dlci53YXJuKHsgc2lkLCB0aW1lb3V0OiBzZW50VGltZW91dE1zIH0sICdUaW1lZCBvdXQgd2FpdGluZyBmb3IgXCJzZW50XCIgc3RhdHVzJyk7XG4gICAgcmVzb2x2ZVNlbnQoKTtcbiAgfSwgc2VudFRpbWVvdXRNcyk7XG5cbiAgYXdhaXQgc2VudFByb21pc2U7XG4gIGNsZWFyVGltZW91dChzZW50VGltZXIpO1xuICBsb2dnZXIuZGVidWcoeyBzaWQgfSwgJ1JlY2VpdmVkIFwic2VudFwiIHN0YXR1cycpO1xuXG4gIGNvbnN0IGRlbGl2ZXJlZFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgbG9nZ2VyLndhcm4oeyBzaWQsIHRpbWVvdXQ6IGRlbGl2ZXJlZFRpbWVvdXRNcyB9LCAnVGltZWQgb3V0IHdhaXRpbmcgZm9yIFwiZGVsaXZlcmVkXCIgc3RhdHVzJyk7XG4gICAgcmVzb2x2ZURlbGl2ZXJlZCgpO1xuICB9LCBkZWxpdmVyZWRUaW1lb3V0TXMpO1xuXG4gIGF3YWl0IGRlbGl2ZXJlZFByb21pc2U7XG4gIGNsZWFyVGltZW91dChkZWxpdmVyZWRUaW1lcik7XG4gIGxvZ2dlci5kZWJ1Zyh7IHNpZCB9LCAnUmVjZWl2ZWQgXCJkZWxpdmVyZWRcIiBzdGF0dXMnKTtcblxuICBhd2FpdCBzdWIudW5zdWJzY3JpYmUoY2hhbm5lbCk7XG4gIHJlZGlzLmRlbChzZWVuU3RhdHVzZXNLZXkpO1xufVxuXG5mdW5jdGlvbiBhZGRTdGF0dXNDYWxsYmFjayhvcHRpb25zOiBUd2lsaW9NZXNzYWdlT3B0aW9ucyk6IHZvaWQge1xuICBjb25zdCBzZXJ2ZXJVcmwgPSBwcm9jZXNzLmVudi5TRVJWRVJfVVJMPy5yZXBsYWNlKC9cXC8kLywgJycpIHx8ICcnO1xuICBpZiAoc2VydmVyVXJsKSB7XG4gICAgb3B0aW9ucy5zdGF0dXNDYWxsYmFjayA9IGAke3NlcnZlclVybH0vdHdpbGlvL2NhbGxiYWNrL2A7XG4gIH1cbn1cblxuZnVuY3Rpb24gaGFuZGxlVHdpbGlvRXJyb3IoZXJyOiBUd2lsaW9BcGlFcnJvcik6IG5ldmVyIHtcbiAgaWYgKGVyciAmJiBlcnIuY29kZSA9PT0gMjAwMDMpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ1R3aWxpbyBhdXRoIGZhaWxlZCAoNDAxKS4gVmVyaWZ5IFRXSUxJT19BQ0NPVU5UX1NJRCBhbmQgVFdJTElPX0FVVEhfVE9LRU4uJyk7XG4gICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdUd2lsaW8gYXV0aGVudGljYXRpb24gZmFpbGVkJyk7XG4gIH1cblxuICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAyMTIxMSkge1xuICAgIGxvZ2dlci5lcnJvcignSW52YWxpZCBwaG9uZSBudW1iZXIgZm9ybWF0Jyk7XG4gICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignSW52YWxpZCBwaG9uZSBudW1iZXIgZm9ybWF0Jyk7XG4gIH1cblxuICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAyMTYxMCkge1xuICAgIGxvZ2dlci5lcnJvcignTWVzc2FnZSBibG9ja2VkIGJ5IGNhcnJpZXInKTtcbiAgICB0aHJvdyBuZXcgU2VydmljZVVuYXZhaWxhYmxlRXJyb3IoJ01lc3NhZ2UgZGVsaXZlcnkgYmxvY2tlZCcpO1xuICB9XG5cbiAgbG9nZ2VyLmVycm9yKHsgZXJyIH0sICdUd2lsaW8gQVBJIGVycm9yJyk7XG4gIHRocm93IG5ldyBTZXJ2aWNlVW5hdmFpbGFibGVFcnJvcignTWVzc2FnZSBkZWxpdmVyeSBmYWlsZWQnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlVHdpbGlvUmVxdWVzdChyZXE6IFJlcXVlc3QpOiBib29sZWFuIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzaWduYXR1cmUgPSByZXEuaGVhZGVyKCdYLVR3aWxpby1TaWduYXR1cmUnKSB8fCByZXEuaGVhZGVyKCd4LXR3aWxpby1zaWduYXR1cmUnKTtcbiAgICBjb25zdCBwcm90b0hlYWRlciA9IChyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtcHJvdG8nXSBhcyBzdHJpbmcpIHx8IHJlcS5wcm90b2NvbDtcbiAgICBjb25zdCBob3N0SGVhZGVyID0gKHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1ob3N0J10gYXMgc3RyaW5nKSB8fCAocmVxLmdldCgnaG9zdCcpIGFzIHN0cmluZyk7XG4gICAgY29uc3QgZnVsbFVybCA9IGAke3Byb3RvSGVhZGVyfTovLyR7aG9zdEhlYWRlcn0ke3JlcS5vcmlnaW5hbFVybH1gO1xuXG4gICAgY29uc3QgYXV0aFRva2VuID0gcHJvY2Vzcy5lbnYuVFdJTElPX0FVVEhfVE9LRU47XG4gICAgaWYgKHByb2Nlc3MuZW52LlRXSUxJT19WQUxJREFURV9XRUJIT09LID09PSAnZmFsc2UnKSByZXR1cm4gdHJ1ZTtcbiAgICBpZiAoIWF1dGhUb2tlbikge1xuICAgICAgbG9nZ2VyLndhcm4oJ1R3aWxpbyBhdXRoIHRva2VuIG5vdCBjb25maWd1cmVkJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmICghc2lnbmF0dXJlKSB7XG4gICAgICBsb2dnZXIud2FybignTWlzc2luZyBUd2lsaW8gc2lnbmF0dXJlIGhlYWRlcicpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHdpbGlvLnZhbGlkYXRlUmVxdWVzdChhdXRoVG9rZW4sIHNpZ25hdHVyZSwgZnVsbFVybCwgcmVxLmJvZHkpO1xuICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICBsb2dnZXIuZXJyb3IoXG4gICAgICB7IGVycjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6IFN0cmluZyhlcnIpIH0sXG4gICAgICAnRXJyb3IgdmFsaWRhdGluZyBUd2lsaW8gcmVxdWVzdCcsXG4gICAgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NTdGF0dXNDYWxsYmFjayhwYXlsb2FkOiBUd2lsaW9TdGF0dXNDYWxsYmFja1BheWxvYWQpOiB2b2lkIHtcbiAgaWYgKCFwYXlsb2FkKSB7XG4gICAgbG9nZ2VyLndhcm4oJ0VtcHR5IGNhbGxiYWNrIHBheWxvYWQgcmVjZWl2ZWQnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBzaWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHBheWxvYWQ/Lk1lc3NhZ2VTaWQgfHwgcGF5bG9hZD8uU21zU2lkO1xuICBjb25zdCBzdGF0dXM6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHBheWxvYWQ/Lk1lc3NhZ2VTdGF0dXMgfHwgcGF5bG9hZD8uU21zU3RhdHVzO1xuXG4gIGlmICghc2lkIHx8ICFzdGF0dXMpIHtcbiAgICBsb2dnZXIud2Fybih7IHBheWxvYWQgfSwgJ0ludmFsaWQgY2FsbGJhY2sgcGF5bG9hZDogbWlzc2luZyBzaWQgb3Igc3RhdHVzJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qgc3RhdHVzTG93ZXIgPSBzdGF0dXMudG9Mb3dlckNhc2UoKTtcbiAgY29uc3QgY2hhbm5lbCA9IGB0d2lsaW86c3RhdHVzOiR7c2lkfWA7XG4gIGNvbnN0IHNlZW5TdGF0dXNlc0tleSA9IGB0d2lsaW86c2Vlbjoke3NpZH1gO1xuXG4gIHJlZGlzLnB1Ymxpc2goY2hhbm5lbCwgc3RhdHVzTG93ZXIpO1xuXG4gIHJlZGlzLnNBZGQoc2VlblN0YXR1c2VzS2V5LCBzdGF0dXNMb3dlcik7XG4gIHJlZGlzLmV4cGlyZShzZWVuU3RhdHVzZXNLZXksIDMwMCk7IC8vIDUgbWludXRlcyBUVExcblxuICBzd2l0Y2ggKHN0YXR1c0xvd2VyKSB7XG4gICAgY2FzZSAnc2VudCc6XG4gICAgICBsb2dnZXIuZGVidWcoeyBzaWQgfSwgJ01lc3NhZ2Ugc2VudCBzdWNjZXNzZnVsbHknKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2RlbGl2ZXJlZCc6XG4gICAgICBsb2dnZXIuaW5mbyh7IHNpZCB9LCAnTWVzc2FnZSBkZWxpdmVyZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdmYWlsZWQnOlxuICAgIGNhc2UgJ3VuZGVsaXZlcmVkJzpcbiAgICAgIGxvZ2dlci53YXJuKHsgc2lkLCBzdGF0dXMgfSwgJ01lc3NhZ2UgZGVsaXZlcnkgZmFpbGVkJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdxdWV1ZWQnOlxuICAgIGNhc2UgJ3NlbmRpbmcnOlxuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIGxvZ2dlci53YXJuKHsgc2lkLCBzdGF0dXM6IHN0YXR1c0xvd2VyIH0sICdVbmtub3duIG1lc3NhZ2Ugc3RhdHVzIHJlY2VpdmVkJyk7XG4gIH1cbn1cbiJdfQ==