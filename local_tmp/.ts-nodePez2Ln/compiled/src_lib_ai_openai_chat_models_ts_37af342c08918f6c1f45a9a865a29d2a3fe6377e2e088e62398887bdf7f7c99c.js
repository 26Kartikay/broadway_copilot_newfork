"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChatOpenAI = void 0;
const cuid2_1 = require("@paralleldrive/cuid2");
const openai_1 = __importDefault(require("openai"));
const zod_1 = __importDefault(require("zod"));
const costs_1 = require("../config/costs");
const base_chat_completions_model_1 = require("../core/base_chat_completions_model");
const messages_1 = require("../core/messages");
const tools_1 = require("../core/tools");
class ChatOpenAI extends base_chat_completions_model_1.BaseChatCompletionsModel {
    client;
    params;
    constructor(params = {}) {
        const combinedParams = {
            model: 'gpt-4.1',
            useResponsesApi: false,
            ...params,
        };
        super(combinedParams);
        this.client = new openai_1.default();
        this.params = combinedParams;
    }
    async run(systemPrompt, msgs, traceBuffer, nodeName) {
        if (this.params.useResponsesApi) {
            return this._runResponses(systemPrompt, msgs, traceBuffer, nodeName);
        }
        return this._runChatCompletions(systemPrompt, msgs, traceBuffer, nodeName);
    }
    async _runResponses(systemPrompt, msgs, traceBuffer, nodeName) {
        const params = this._buildResponsesParams(systemPrompt, msgs);
        const nodeRun = traceBuffer.nodeRuns.find((ne) => ne.nodeName === nodeName && !ne.endTime);
        if (!nodeRun) {
            throw new Error(`Could not find an active node execution for nodeName: ${nodeName}`);
        }
        const startTime = new Date();
        const llmTrace = {
            id: (0, cuid2_1.createId)(),
            nodeRunId: nodeRun.id,
            model: this.params.model,
            inputMessages: params.input,
            rawRequest: params,
            startTime,
        };
        let response;
        try {
            response = await this.client.responses.create(params);
        }
        catch (err) {
            const endTime = new Date();
            const message = err instanceof Error ? err.message : String(err);
            const stack = err instanceof Error ? err.stack : undefined;
            llmTrace.errorTrace = stack ?? message;
            llmTrace.endTime = endTime;
            llmTrace.durationMs = endTime.getTime() - startTime.getTime();
            traceBuffer.llmTraces.push(llmTrace);
            throw err;
        }
        const { assistantContent, toolCalls, rawToolCalls } = this._processResponsesResponse(response);
        const assistant = new messages_1.AssistantMessage(assistantContent);
        assistant.meta = { raw: response };
        if (toolCalls.length > 0) {
            assistant.meta.tool_calls = toolCalls;
        }
        if (rawToolCalls.length > 0) {
            assistant.meta.raw_tool_calls = rawToolCalls;
        }
        const endTime = new Date();
        llmTrace.rawResponse = response;
        llmTrace.outputMessage = assistant.toJSON();
        llmTrace.promptTokens = response.usage?.total_tokens ?? null;
        llmTrace.completionTokens = 0;
        llmTrace.totalTokens = response.usage?.total_tokens ?? null;
        llmTrace.endTime = endTime;
        llmTrace.durationMs = endTime.getTime() - startTime.getTime();
        traceBuffer.llmTraces.push(llmTrace);
        return {
            assistant,
            toolCalls,
            raw: response,
        };
    }
    async _runChatCompletions(systemPrompt, msgs, traceBuffer, nodeName) {
        const params = this._buildChatCompletionsParams(systemPrompt, msgs);
        const nodeRun = traceBuffer.nodeRuns.find((ne) => ne.nodeName === nodeName && !ne.endTime);
        if (!nodeRun) {
            throw new Error(`Could not find an active node execution for nodeName: ${nodeName}`);
        }
        const startTime = new Date();
        const llmTrace = {
            id: (0, cuid2_1.createId)(),
            nodeRunId: nodeRun.id,
            model: this.params.model,
            inputMessages: params.messages,
            rawRequest: params,
            startTime,
        };
        let response;
        try {
            response = await this.client.chat.completions.create(params);
        }
        catch (err) {
            const endTime = new Date();
            const message = err instanceof Error ? err.message : String(err);
            const stack = err instanceof Error ? err.stack : undefined;
            llmTrace.errorTrace = stack ?? message;
            llmTrace.endTime = endTime;
            llmTrace.durationMs = endTime.getTime() - startTime.getTime();
            traceBuffer.llmTraces.push(llmTrace);
            throw err;
        }
        const { assistant, toolCalls } = this._processChatCompletionsResponse(response);
        const endTime = new Date();
        let costUsd = null;
        const modelCosts = costs_1.MODEL_COSTS[this.params.model];
        if (modelCosts) {
            const promptTokens = response.usage?.prompt_tokens ?? 0;
            const completionTokens = response.usage?.completion_tokens ?? 0;
            const inputCost = (promptTokens / 1_000_000) * modelCosts.input;
            const outputCost = (completionTokens / 1_000_000) * modelCosts.output;
            costUsd = inputCost + outputCost;
        }
        llmTrace.rawResponse = response;
        llmTrace.outputMessage = assistant.toJSON();
        llmTrace.promptTokens = response.usage?.prompt_tokens ?? null;
        llmTrace.completionTokens = response.usage?.completion_tokens ?? null;
        llmTrace.totalTokens = response.usage?.total_tokens ?? null;
        llmTrace.costUsd = costUsd ?? null;
        llmTrace.endTime = endTime;
        llmTrace.durationMs = endTime.getTime() - startTime.getTime();
        traceBuffer.llmTraces.push(llmTrace);
        return {
            assistant,
            toolCalls,
            raw: response,
        };
    }
    _buildResponsesParams(systemPrompt, msgs) {
        const instructions = systemPrompt.content
            .filter((p) => p.type === 'text')
            .map((p) => p.text)
            .join('');
        const input = msgs.flatMap((m) => {
            if (m.role === 'tool') {
                return {
                    type: 'function_call_output',
                    call_id: m.tool_call_id,
                    output: m.content
                        .filter((p) => p.type === 'text')
                        .map((p) => p.text)
                        .join(''),
                };
            }
            if (m.role === 'assistant') {
                const items = [];
                const textContent = m.content
                    .filter((p) => p.type === 'text')
                    .map((p) => p.text)
                    .join('')
                    .trim();
                if (textContent) {
                    items.push({
                        role: 'assistant',
                        content: textContent,
                    });
                }
                const rawToolCalls = m.meta?.raw_tool_calls;
                if (rawToolCalls?.length) {
                    items.push(...rawToolCalls);
                }
                return items;
            }
            return {
                role: 'user',
                content: m.content.map((c) => {
                    if (c.type === 'text') {
                        return { type: 'input_text', text: c.text };
                    }
                    return {
                        type: 'input_image',
                        image_url: c.image_url.url,
                        detail: c.image_url.detail ?? 'auto',
                    };
                }),
            };
        });
        const tools = this.boundTools.map(tools_1.toOpenAIToolSpec);
        const params = {
            model: this.params.model,
            input,
            stream: false,
        };
        if (this.params.temperature !== undefined) {
            params.temperature = this.params.temperature;
        }
        if (this.params.maxTokens !== undefined) {
            params.max_output_tokens = this.params.maxTokens;
        }
        if (this.params.topP !== undefined) {
            params.top_p = this.params.topP;
        }
        if (instructions) {
            params.instructions = instructions;
        }
        if (this.params.reasoning) {
            params.reasoning = this.params.reasoning;
        }
        if (tools.length > 0) {
            params.tools = tools;
            params.tool_choice = 'auto';
        }
        if (this.structuredOutputSchema) {
            const toolName = this.structuredOutputToolName;
            const tool = {
                type: 'function',
                name: toolName,
                description: 'Structured output formatter',
                parameters: zod_1.default.toJSONSchema(this.structuredOutputSchema),
                strict: true,
            };
            params.tools = [...(params.tools ?? []), tool];
            params.tool_choice = {
                type: 'function',
                name: toolName,
            };
        }
        return params;
    }
    _buildChatCompletionsParams(systemPrompt, msgs) {
        const params = super._buildChatCompletionsParams(systemPrompt, msgs);
        if (this.params.responseFormat) {
            params.response_format = this.params.responseFormat;
        }
        return params;
    }
    _processResponsesResponse(response) {
        const assistantContent = response.output_text ?? '';
        const output = response.output ?? [];
        const rawToolCalls = output.filter((item) => item?.type === 'function_call');
        const toolCalls = rawToolCalls.map((item) => {
            try {
                return {
                    id: item.call_id,
                    name: item.name,
                    arguments: item.arguments ? JSON.parse(item.arguments) : {},
                };
            }
            catch (e) {
                throw new Error(`Failed to parse arguments for ${item.name}: ${e}`);
            }
        });
        return {
            assistantContent,
            toolCalls,
            rawToolCalls,
        };
    }
}
exports.ChatOpenAI = ChatOpenAI;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3Vzci9zcmMvYXBwL3NyYy9saWIvYWkvb3BlbmFpL2NoYXRfbW9kZWxzLnRzIiwic291cmNlcyI6WyIvdXNyL3NyYy9hcHAvc3JjL2xpYi9haS9vcGVuYWkvY2hhdF9tb2RlbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0RBQWdEO0FBQ2hELG9EQUE0QjtBQVM1Qiw4Q0FBb0I7QUFJcEIsMkNBQThDO0FBQzlDLHFGQUErRTtBQUMvRSwrQ0FBMEY7QUFFMUYseUNBQTJEO0FBaUIzRCxNQUFhLFVBQVcsU0FBUSxzREFBd0I7SUFDNUMsTUFBTSxDQUFTO0lBQ2xCLE1BQU0sQ0FBd0I7SUFPckMsWUFBWSxTQUF5QyxFQUFFO1FBQ3JELE1BQU0sY0FBYyxHQUEwQjtZQUM1QyxLQUFLLEVBQUUsU0FBUztZQUNoQixlQUFlLEVBQUUsS0FBSztZQUN0QixHQUFHLE1BQU07U0FDVixDQUFDO1FBQ0YsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxnQkFBTSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQ1AsWUFBMkIsRUFDM0IsSUFBbUIsRUFDbkIsV0FBd0IsRUFDeEIsUUFBZ0I7UUFFaEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ2hDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2RSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhLENBQ3pCLFlBQTJCLEVBQzNCLElBQW1CLEVBQ25CLFdBQXdCLEVBQ3hCLFFBQWdC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QyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7aUJBQzVELENBQUM7WUFDSixDQUFDO1lBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDWCxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEUsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTztZQUNMLGdCQUFnQjtZQUNoQixTQUFTO1lBQ1QsWUFBWTtTQUNiLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1VEQsZ0NBNFRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlSWQgfSBmcm9tICdAcGFyYWxsZWxkcml2ZS9jdWlkMic7XG5pbXBvcnQgT3BlbkFJIGZyb20gJ29wZW5haSc7XG5pbXBvcnQgdHlwZSB7XG4gIEZ1bmN0aW9uVG9vbCxcbiAgUmVzcG9uc2UsXG4gIFJlc3BvbnNlQ3JlYXRlUGFyYW1zTm9uU3RyZWFtaW5nLFxuICBSZXNwb25zZUZ1bmN0aW9uVG9vbENhbGwsXG4gIFJlc3BvbnNlSW5wdXRJdGVtLFxuICBSZXNwb25zZU91dHB1dEl0ZW0sXG59IGZyb20gJ29wZW5haS9yZXNvdXJjZXMvcmVzcG9uc2VzL3Jlc3BvbnNlcyc7XG5pbXBvcnQgeiBmcm9tICd6b2QnO1xuXG5pbXBvcnQgeyBQcmlzbWEgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgeyBCdWZmZXJlZExsbVRyYWNlLCBUcmFjZUJ1ZmZlciB9IGZyb20gJy4uLy4uLy4uL2FnZW50L3RyYWNpbmcnO1xuaW1wb3J0IHsgTU9ERUxfQ09TVFMgfSBmcm9tICcuLi9jb25maWcvY29zdHMnO1xuaW1wb3J0IHsgQmFzZUNoYXRDb21wbGV0aW9uc01vZGVsIH0gZnJvbSAnLi4vY29yZS9iYXNlX2NoYXRfY29tcGxldGlvbnNfbW9kZWwnO1xuaW1wb3J0IHsgQXNzaXN0YW50TWVzc2FnZSwgQmFzZU1lc3NhZ2UsIFN5c3RlbU1lc3NhZ2UsIFRleHRQYXJ0IH0gZnJvbSAnLi4vY29yZS9tZXNzYWdlcyc7XG5pbXBvcnQgeyBPcGVuQUlDaGF0TW9kZWxQYXJhbXMsIFJ1bk91dGNvbWUgfSBmcm9tICcuLi9jb3JlL3J1bm5hYmxlcyc7XG5pbXBvcnQgeyBUb29sQ2FsbCwgdG9PcGVuQUlUb29sU3BlYyB9IGZyb20gJy4uL2NvcmUvdG9vbHMnO1xuXG4vKipcbiAqIEEgY2hhdCBtb2RlbCB0aGF0IGludGVyYWN0cyB3aXRoIHRoZSBPcGVuQUkgQVBJLlxuICogVGhpcyBjbGFzcyBleHRlbmRzIGBCYXNlQ2hhdENvbXBsZXRpb25zTW9kZWxgIGFuZCBpcyBjb25maWd1cmVkIGZvciB0aGUgT3BlbkFJIGVuZHBvaW50LlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0eXBlc2NyaXB0XG4gKiBjb25zdCBtb2RlbCA9IG5ldyBDaGF0T3BlbkFJKHsgbW9kZWw6ICdncHQtNG8tbWluaScgfSk7XG4gKiBjb25zdCByZXN1bHQgPSBhd2FpdCBtb2RlbC5ydW4oXG4gKiAgIG5ldyBTeXN0ZW1NZXNzYWdlKCdZb3UgYXJlIGEgaGVscGZ1bCBhc3Npc3RhbnQuJyksXG4gKiAgIFtuZXcgVXNlck1lc3NhZ2UoJ1doYXQgaXMgdGhlIGNhcGl0YWwgb2YgRnJhbmNlPycpXSxcbiAqICAgJ3NvbWUtZ3JhcGgtcnVuLWlkJ1xuICogKTtcbiAqIGNvbnNvbGUubG9nKHJlc3VsdC5hc3Npc3RhbnQuY29udGVudFswXS50ZXh0KTtcbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgQ2hhdE9wZW5BSSBleHRlbmRzIEJhc2VDaGF0Q29tcGxldGlvbnNNb2RlbCB7XG4gIHByb3RlY3RlZCBjbGllbnQ6IE9wZW5BSTtcbiAgcHVibGljIHBhcmFtczogT3BlbkFJQ2hhdE1vZGVsUGFyYW1zO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIENoYXRPcGVuQUkuXG4gICAqIEBwYXJhbSBwYXJhbXMgLSBPcHRpb25hbCBwYXJhbWV0ZXJzIHRvIG92ZXJyaWRlIHRoZSBtb2RlbCBkZWZhdWx0cy5cbiAgICogQHBhcmFtIGNsaWVudCAtIEFuIG9wdGlvbmFsIE9wZW5BSSBjbGllbnQgaW5zdGFuY2UsIHVzZWZ1bCBmb3IgdGVzdGluZyBvciBjdXN0b20gY29uZmlndXJhdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihwYXJhbXM6IFBhcnRpYWw8T3BlbkFJQ2hhdE1vZGVsUGFyYW1zPiA9IHt9KSB7XG4gICAgY29uc3QgY29tYmluZWRQYXJhbXM6IE9wZW5BSUNoYXRNb2RlbFBhcmFtcyA9IHtcbiAgICAgIG1vZGVsOiAnZ3B0LTQuMScsXG4gICAgICB1c2VSZXNwb25zZXNBcGk6IGZhbHNlLFxuICAgICAgLi4ucGFyYW1zLFxuICAgIH07XG4gICAgc3VwZXIoY29tYmluZWRQYXJhbXMpO1xuICAgIHRoaXMuY2xpZW50ID0gbmV3IE9wZW5BSSgpO1xuICAgIHRoaXMucGFyYW1zID0gY29tYmluZWRQYXJhbXM7XG4gIH1cblxuICBhc3luYyBydW4oXG4gICAgc3lzdGVtUHJvbXB0OiBTeXN0ZW1NZXNzYWdlLFxuICAgIG1zZ3M6IEJhc2VNZXNzYWdlW10sXG4gICAgdHJhY2VCdWZmZXI6IFRyYWNlQnVmZmVyLFxuICAgIG5vZGVOYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UnVuT3V0Y29tZT4ge1xuICAgIGlmICh0aGlzLnBhcmFtcy51c2VSZXNwb25zZXNBcGkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9ydW5SZXNwb25zZXMoc3lzdGVtUHJvbXB0LCBtc2dzLCB0cmFjZUJ1ZmZlciwgbm9kZU5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcnVuQ2hhdENvbXBsZXRpb25zKHN5c3RlbVByb21wdCwgbXNncywgdHJhY2VCdWZmZXIsIG5vZGVOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX3J1blJlc3BvbnNlcyhcbiAgICBzeXN0ZW1Qcm9tcHQ6IFN5c3RlbU1lc3NhZ2UsXG4gICAgbXNnczogQmFzZU1lc3NhZ2VbXSxcbiAgICB0cmFjZUJ1ZmZlcjogVHJhY2VCdWZmZXIsXG4gICAgbm9kZU5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSdW5PdXRjb21lPiB7XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5fYnVpbGRSZXNwb25zZXNQYXJhbXMoc3lzdGVtUHJvbXB0LCBtc2dzKTtcblxuICAgIGNvbnN0IG5vZGVSdW4gPSB0cmFjZUJ1ZmZlci5ub2RlUnVucy5maW5kKChuZSkgPT4gbmUubm9kZU5hbWUgPT09IG5vZGVOYW1lICYmICFuZS5lbmRUaW1lKTtcbiAgICBpZiAoIW5vZGVSdW4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgYW4gYWN0aXZlIG5vZGUgZXhlY3V0aW9uIGZvciBub2RlTmFtZTogJHtub2RlTmFtZX1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgY29uc3QgbGxtVHJhY2U6IEJ1ZmZlcmVkTGxtVHJhY2UgPSB7XG4gICAgICBpZDogY3JlYXRlSWQoKSxcbiAgICAgIG5vZGVSdW5JZDogbm9kZVJ1bi5pZCxcbiAgICAgIG1vZGVsOiB0aGlzLnBhcmFtcy5tb2RlbCxcbiAgICAgIGlucHV0TWVzc2FnZXM6IHBhcmFtcy5pbnB1dCBhcyB1bmtub3duIGFzIFByaXNtYS5Kc29uQXJyYXksXG4gICAgICByYXdSZXF1ZXN0OiBwYXJhbXMgYXMgdW5rbm93biBhcyBQcmlzbWEuSnNvbk9iamVjdCxcbiAgICAgIHN0YXJ0VGltZSxcbiAgICB9O1xuXG4gICAgbGV0IHJlc3BvbnNlOiBSZXNwb25zZTtcbiAgICB0cnkge1xuICAgICAgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXNwb25zZXMuY3JlYXRlKHBhcmFtcyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyci5tZXNzYWdlIDogU3RyaW5nKGVycik7XG4gICAgICBjb25zdCBzdGFjayA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLnN0YWNrIDogdW5kZWZpbmVkO1xuICAgICAgbGxtVHJhY2UuZXJyb3JUcmFjZSA9IHN0YWNrID8/IG1lc3NhZ2U7XG4gICAgICBsbG1UcmFjZS5lbmRUaW1lID0gZW5kVGltZTtcbiAgICAgIGxsbVRyYWNlLmR1cmF0aW9uTXMgPSBlbmRUaW1lLmdldFRpbWUoKSAtIHN0YXJ0VGltZS5nZXRUaW1lKCk7XG4gICAgICB0cmFjZUJ1ZmZlci5sbG1UcmFjZXMucHVzaChsbG1UcmFjZSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuXG4gICAgY29uc3QgeyBhc3Npc3RhbnRDb250ZW50LCB0b29sQ2FsbHMsIHJhd1Rvb2xDYWxscyB9ID0gdGhpcy5fcHJvY2Vzc1Jlc3BvbnNlc1Jlc3BvbnNlKHJlc3BvbnNlKTtcblxuICAgIGNvbnN0IGFzc2lzdGFudCA9IG5ldyBBc3Npc3RhbnRNZXNzYWdlKGFzc2lzdGFudENvbnRlbnQpO1xuICAgIGFzc2lzdGFudC5tZXRhID0geyByYXc6IHJlc3BvbnNlIH07XG4gICAgaWYgKHRvb2xDYWxscy5sZW5ndGggPiAwKSB7XG4gICAgICBhc3Npc3RhbnQubWV0YS50b29sX2NhbGxzID0gdG9vbENhbGxzO1xuICAgIH1cbiAgICBpZiAocmF3VG9vbENhbGxzLmxlbmd0aCA+IDApIHtcbiAgICAgIGFzc2lzdGFudC5tZXRhLnJhd190b29sX2NhbGxzID0gcmF3VG9vbENhbGxzO1xuICAgIH1cblxuICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIGxsbVRyYWNlLnJhd1Jlc3BvbnNlID0gcmVzcG9uc2UgYXMgdW5rbm93biBhcyBQcmlzbWEuSnNvbk9iamVjdDtcbiAgICBsbG1UcmFjZS5vdXRwdXRNZXNzYWdlID0gYXNzaXN0YW50LnRvSlNPTigpIGFzIFByaXNtYS5Kc29uT2JqZWN0O1xuICAgIGxsbVRyYWNlLnByb21wdFRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy50b3RhbF90b2tlbnMgPz8gbnVsbDtcbiAgICBsbG1UcmFjZS5jb21wbGV0aW9uVG9rZW5zID0gMDtcbiAgICBsbG1UcmFjZS50b3RhbFRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy50b3RhbF90b2tlbnMgPz8gbnVsbDtcbiAgICBsbG1UcmFjZS5lbmRUaW1lID0gZW5kVGltZTtcbiAgICBsbG1UcmFjZS5kdXJhdGlvbk1zID0gZW5kVGltZS5nZXRUaW1lKCkgLSBzdGFydFRpbWUuZ2V0VGltZSgpO1xuICAgIHRyYWNlQnVmZmVyLmxsbVRyYWNlcy5wdXNoKGxsbVRyYWNlKTtcblxuICAgIHJldHVybiB7XG4gICAgICBhc3Npc3RhbnQsXG4gICAgICB0b29sQ2FsbHMsXG4gICAgICByYXc6IHJlc3BvbnNlLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIF9ydW5DaGF0Q29tcGxldGlvbnMoXG4gICAgc3lzdGVtUHJvbXB0OiBTeXN0ZW1NZXNzYWdlLFxuICAgIG1zZ3M6IEJhc2VNZXNzYWdlW10sXG4gICAgdHJhY2VCdWZmZXI6IFRyYWNlQnVmZmVyLFxuICAgIG5vZGVOYW1lOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UnVuT3V0Y29tZT4ge1xuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuX2J1aWxkQ2hhdENvbXBsZXRpb25zUGFyYW1zKHN5c3RlbVByb21wdCwgbXNncyk7XG5cbiAgICBjb25zdCBub2RlUnVuID0gdHJhY2VCdWZmZXIubm9kZVJ1bnMuZmluZCgobmUpID0+IG5lLm5vZGVOYW1lID09PSBub2RlTmFtZSAmJiAhbmUuZW5kVGltZSk7XG4gICAgaWYgKCFub2RlUnVuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIGFuIGFjdGl2ZSBub2RlIGV4ZWN1dGlvbiBmb3Igbm9kZU5hbWU6ICR7bm9kZU5hbWV9YCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKTtcblxuICAgIGNvbnN0IGxsbVRyYWNlOiBCdWZmZXJlZExsbVRyYWNlID0ge1xuICAgICAgaWQ6IGNyZWF0ZUlkKCksXG4gICAgICBub2RlUnVuSWQ6IG5vZGVSdW4uaWQsXG4gICAgICBtb2RlbDogdGhpcy5wYXJhbXMubW9kZWwsXG4gICAgICBpbnB1dE1lc3NhZ2VzOiBwYXJhbXMubWVzc2FnZXMgYXMgdW5rbm93biBhcyBQcmlzbWEuSnNvbkFycmF5LFxuICAgICAgcmF3UmVxdWVzdDogcGFyYW1zIGFzIHVua25vd24gYXMgUHJpc21hLkpzb25PYmplY3QsXG4gICAgICBzdGFydFRpbWUsXG4gICAgfTtcblxuICAgIGxldCByZXNwb25zZTogT3BlbkFJLkNoYXQuQ29tcGxldGlvbnMuQ2hhdENvbXBsZXRpb247XG4gICAgdHJ5IHtcbiAgICAgIHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUocGFyYW1zKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyLm1lc3NhZ2UgOiBTdHJpbmcoZXJyKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIuc3RhY2sgOiB1bmRlZmluZWQ7XG4gICAgICBsbG1UcmFjZS5lcnJvclRyYWNlID0gc3RhY2sgPz8gbWVzc2FnZTtcbiAgICAgIGxsbVRyYWNlLmVuZFRpbWUgPSBlbmRUaW1lO1xuICAgICAgbGxtVHJhY2UuZHVyYXRpb25NcyA9IGVuZFRpbWUuZ2V0VGltZSgpIC0gc3RhcnRUaW1lLmdldFRpbWUoKTtcbiAgICAgIHRyYWNlQnVmZmVyLmxsbVRyYWNlcy5wdXNoKGxsbVRyYWNlKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG5cbiAgICBjb25zdCB7IGFzc2lzdGFudCwgdG9vbENhbGxzIH0gPSB0aGlzLl9wcm9jZXNzQ2hhdENvbXBsZXRpb25zUmVzcG9uc2UocmVzcG9uc2UpO1xuXG4gICAgY29uc3QgZW5kVGltZSA9IG5ldyBEYXRlKCk7XG5cbiAgICBsZXQgY29zdFVzZDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3QgbW9kZWxDb3N0cyA9IE1PREVMX0NPU1RTW3RoaXMucGFyYW1zLm1vZGVsXTtcbiAgICBpZiAobW9kZWxDb3N0cykge1xuICAgICAgY29uc3QgcHJvbXB0VG9rZW5zID0gcmVzcG9uc2UudXNhZ2U/LnByb21wdF90b2tlbnMgPz8gMDtcbiAgICAgIGNvbnN0IGNvbXBsZXRpb25Ub2tlbnMgPSByZXNwb25zZS51c2FnZT8uY29tcGxldGlvbl90b2tlbnMgPz8gMDtcbiAgICAgIGNvbnN0IGlucHV0Q29zdCA9IChwcm9tcHRUb2tlbnMgLyAxXzAwMF8wMDApICogbW9kZWxDb3N0cy5pbnB1dDtcbiAgICAgIGNvbnN0IG91dHB1dENvc3QgPSAoY29tcGxldGlvblRva2VucyAvIDFfMDAwXzAwMCkgKiBtb2RlbENvc3RzLm91dHB1dDtcbiAgICAgIGNvc3RVc2QgPSBpbnB1dENvc3QgKyBvdXRwdXRDb3N0O1xuICAgIH1cblxuICAgIGxsbVRyYWNlLnJhd1Jlc3BvbnNlID0gcmVzcG9uc2UgYXMgdW5rbm93biBhcyBQcmlzbWEuSnNvbk9iamVjdDtcbiAgICBsbG1UcmFjZS5vdXRwdXRNZXNzYWdlID0gYXNzaXN0YW50LnRvSlNPTigpIGFzIFByaXNtYS5Kc29uT2JqZWN0O1xuICAgIGxsbVRyYWNlLnByb21wdFRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy5wcm9tcHRfdG9rZW5zID8/IG51bGw7XG4gICAgbGxtVHJhY2UuY29tcGxldGlvblRva2VucyA9IHJlc3BvbnNlLnVzYWdlPy5jb21wbGV0aW9uX3Rva2VucyA/PyBudWxsO1xuICAgIGxsbVRyYWNlLnRvdGFsVG9rZW5zID0gcmVzcG9uc2UudXNhZ2U/LnRvdGFsX3Rva2VucyA/PyBudWxsO1xuICAgIGxsbVRyYWNlLmNvc3RVc2QgPSBjb3N0VXNkID8/IG51bGw7XG4gICAgbGxtVHJhY2UuZW5kVGltZSA9IGVuZFRpbWU7XG4gICAgbGxtVHJhY2UuZHVyYXRpb25NcyA9IGVuZFRpbWUuZ2V0VGltZSgpIC0gc3RhcnRUaW1lLmdldFRpbWUoKTtcbiAgICB0cmFjZUJ1ZmZlci5sbG1UcmFjZXMucHVzaChsbG1UcmFjZSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXNzaXN0YW50LFxuICAgICAgdG9vbENhbGxzLFxuICAgICAgcmF3OiByZXNwb25zZSxcbiAgICB9O1xuICB9XG5cbiAgcHJvdGVjdGVkIF9idWlsZFJlc3BvbnNlc1BhcmFtcyhcbiAgICBzeXN0ZW1Qcm9tcHQ6IFN5c3RlbU1lc3NhZ2UsXG4gICAgbXNnczogQmFzZU1lc3NhZ2VbXSxcbiAgKTogUmVzcG9uc2VDcmVhdGVQYXJhbXNOb25TdHJlYW1pbmcge1xuICAgIGNvbnN0IGluc3RydWN0aW9ucyA9IHN5c3RlbVByb21wdC5jb250ZW50XG4gICAgICAuZmlsdGVyKChwKTogcCBpcyBUZXh0UGFydCA9PiBwLnR5cGUgPT09ICd0ZXh0JylcbiAgICAgIC5tYXAoKHApID0+IHAudGV4dClcbiAgICAgIC5qb2luKCcnKTtcblxuICAgIGNvbnN0IGlucHV0OiBSZXNwb25zZUlucHV0SXRlbVtdID0gbXNncy5mbGF0TWFwKChtKSA9PiB7XG4gICAgICBpZiAobS5yb2xlID09PSAndG9vbCcpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiAnZnVuY3Rpb25fY2FsbF9vdXRwdXQnLFxuICAgICAgICAgIGNhbGxfaWQ6IG0udG9vbF9jYWxsX2lkISxcbiAgICAgICAgICBvdXRwdXQ6IG0uY29udGVudFxuICAgICAgICAgICAgLmZpbHRlcigocCk6IHAgaXMgVGV4dFBhcnQgPT4gcC50eXBlID09PSAndGV4dCcpXG4gICAgICAgICAgICAubWFwKChwKSA9PiBwLnRleHQpXG4gICAgICAgICAgICAuam9pbignJyksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChtLnJvbGUgPT09ICdhc3Npc3RhbnQnKSB7XG4gICAgICAgIGNvbnN0IGl0ZW1zOiBSZXNwb25zZUlucHV0SXRlbVtdID0gW107XG4gICAgICAgIGNvbnN0IHRleHRDb250ZW50ID0gbS5jb250ZW50XG4gICAgICAgICAgLmZpbHRlcigocCk6IHAgaXMgVGV4dFBhcnQgPT4gcC50eXBlID09PSAndGV4dCcpXG4gICAgICAgICAgLm1hcCgocCkgPT4gcC50ZXh0KVxuICAgICAgICAgIC5qb2luKCcnKVxuICAgICAgICAgIC50cmltKCk7XG5cbiAgICAgICAgaWYgKHRleHRDb250ZW50KSB7XG4gICAgICAgICAgaXRlbXMucHVzaCh7XG4gICAgICAgICAgICByb2xlOiAnYXNzaXN0YW50JyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IHRleHRDb250ZW50LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmF3VG9vbENhbGxzID0gbS5tZXRhPy5yYXdfdG9vbF9jYWxscyBhcyBSZXNwb25zZUZ1bmN0aW9uVG9vbENhbGxbXSB8IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKHJhd1Rvb2xDYWxscz8ubGVuZ3RoKSB7XG4gICAgICAgICAgaXRlbXMucHVzaCguLi5yYXdUb29sQ2FsbHMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtcztcbiAgICAgIH1cblxuICAgICAgLy8gVXNlciBtZXNzYWdlc1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcm9sZTogJ3VzZXInLFxuICAgICAgICBjb250ZW50OiBtLmNvbnRlbnQubWFwKChjKSA9PiB7XG4gICAgICAgICAgaWYgKGMudHlwZSA9PT0gJ3RleHQnKSB7XG4gICAgICAgICAgICByZXR1cm4geyB0eXBlOiAnaW5wdXRfdGV4dCcgYXMgY29uc3QsIHRleHQ6IGMudGV4dCB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBJbWFnZVBhcnRcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogJ2lucHV0X2ltYWdlJyBhcyBjb25zdCxcbiAgICAgICAgICAgIGltYWdlX3VybDogYy5pbWFnZV91cmwudXJsLFxuICAgICAgICAgICAgZGV0YWlsOiBjLmltYWdlX3VybC5kZXRhaWwgPz8gJ2F1dG8nLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHRvb2xzID0gdGhpcy5ib3VuZFRvb2xzLm1hcCh0b09wZW5BSVRvb2xTcGVjKTtcblxuICAgIGNvbnN0IHBhcmFtczogUmVzcG9uc2VDcmVhdGVQYXJhbXNOb25TdHJlYW1pbmcgPSB7XG4gICAgICBtb2RlbDogdGhpcy5wYXJhbXMubW9kZWwsXG4gICAgICBpbnB1dCxcbiAgICAgIHN0cmVhbTogZmFsc2UsXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnBhcmFtcy50ZW1wZXJhdHVyZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJhbXMudGVtcGVyYXR1cmUgPSB0aGlzLnBhcmFtcy50ZW1wZXJhdHVyZTtcbiAgICB9XG4gICAgaWYgKHRoaXMucGFyYW1zLm1heFRva2VucyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJhbXMubWF4X291dHB1dF90b2tlbnMgPSB0aGlzLnBhcmFtcy5tYXhUb2tlbnM7XG4gICAgfVxuICAgIGlmICh0aGlzLnBhcmFtcy50b3BQICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHBhcmFtcy50b3BfcCA9IHRoaXMucGFyYW1zLnRvcFA7XG4gICAgfVxuICAgIGlmIChpbnN0cnVjdGlvbnMpIHtcbiAgICAgIHBhcmFtcy5pbnN0cnVjdGlvbnMgPSBpbnN0cnVjdGlvbnM7XG4gICAgfVxuICAgIGlmICh0aGlzLnBhcmFtcy5yZWFzb25pbmcpIHtcbiAgICAgIHBhcmFtcy5yZWFzb25pbmcgPSB0aGlzLnBhcmFtcy5yZWFzb25pbmc7XG4gICAgfVxuXG4gICAgaWYgKHRvb2xzLmxlbmd0aCA+IDApIHtcbiAgICAgIHBhcmFtcy50b29scyA9IHRvb2xzO1xuICAgICAgcGFyYW1zLnRvb2xfY2hvaWNlID0gJ2F1dG8nO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnN0cnVjdHVyZWRPdXRwdXRTY2hlbWEpIHtcbiAgICAgIGNvbnN0IHRvb2xOYW1lID0gdGhpcy5zdHJ1Y3R1cmVkT3V0cHV0VG9vbE5hbWU7XG4gICAgICBjb25zdCB0b29sOiBGdW5jdGlvblRvb2wgPSB7XG4gICAgICAgIHR5cGU6ICdmdW5jdGlvbicsXG4gICAgICAgIG5hbWU6IHRvb2xOYW1lLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1N0cnVjdHVyZWQgb3V0cHV0IGZvcm1hdHRlcicsXG4gICAgICAgIHBhcmFtZXRlcnM6IHoudG9KU09OU2NoZW1hKHRoaXMuc3RydWN0dXJlZE91dHB1dFNjaGVtYSkgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgICAgIHN0cmljdDogdHJ1ZSxcbiAgICAgIH07XG4gICAgICBwYXJhbXMudG9vbHMgPSBbLi4uKHBhcmFtcy50b29scyA/PyBbXSksIHRvb2xdO1xuICAgICAgcGFyYW1zLnRvb2xfY2hvaWNlID0ge1xuICAgICAgICB0eXBlOiAnZnVuY3Rpb24nLFxuICAgICAgICBuYW1lOiB0b29sTmFtZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmFtcztcbiAgfVxuXG4gIHByb3RlY3RlZCBfYnVpbGRDaGF0Q29tcGxldGlvbnNQYXJhbXMoXG4gICAgc3lzdGVtUHJvbXB0OiBTeXN0ZW1NZXNzYWdlLFxuICAgIG1zZ3M6IEJhc2VNZXNzYWdlW10sXG4gICk6IE9wZW5BSS5DaGF0LkNvbXBsZXRpb25zLkNoYXRDb21wbGV0aW9uQ3JlYXRlUGFyYW1zTm9uU3RyZWFtaW5nIHtcbiAgICBjb25zdCBwYXJhbXMgPSBzdXBlci5fYnVpbGRDaGF0Q29tcGxldGlvbnNQYXJhbXMoc3lzdGVtUHJvbXB0LCBtc2dzKTtcbiAgICBpZiAodGhpcy5wYXJhbXMucmVzcG9uc2VGb3JtYXQpIHtcbiAgICAgIHBhcmFtcy5yZXNwb25zZV9mb3JtYXQgPSB0aGlzLnBhcmFtcy5yZXNwb25zZUZvcm1hdDtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtcztcbiAgfVxuXG4gIHByb3RlY3RlZCBfcHJvY2Vzc1Jlc3BvbnNlc1Jlc3BvbnNlKHJlc3BvbnNlOiBSZXNwb25zZSk6IHtcbiAgICBhc3Npc3RhbnRDb250ZW50OiBzdHJpbmc7XG4gICAgdG9vbENhbGxzOiBUb29sQ2FsbFtdO1xuICAgIHJhd1Rvb2xDYWxsczogUmVzcG9uc2VGdW5jdGlvblRvb2xDYWxsW107XG4gIH0ge1xuICAgIGNvbnN0IGFzc2lzdGFudENvbnRlbnQgPSByZXNwb25zZS5vdXRwdXRfdGV4dCA/PyAnJztcbiAgICBjb25zdCBvdXRwdXQ6IFJlc3BvbnNlT3V0cHV0SXRlbVtdID0gcmVzcG9uc2Uub3V0cHV0ID8/IFtdO1xuXG4gICAgY29uc3QgcmF3VG9vbENhbGxzID0gb3V0cHV0LmZpbHRlcihcbiAgICAgIChpdGVtKTogaXRlbSBpcyBSZXNwb25zZUZ1bmN0aW9uVG9vbENhbGwgPT4gaXRlbT8udHlwZSA9PT0gJ2Z1bmN0aW9uX2NhbGwnLFxuICAgICk7XG5cbiAgICBjb25zdCB0b29sQ2FsbHMgPSByYXdUb29sQ2FsbHMubWFwKChpdGVtKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlkOiBpdGVtLmNhbGxfaWQsXG4gICAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICAgIGFyZ3VtZW50czogaXRlbS5hcmd1bWVudHMgPyBKU09OLnBhcnNlKGl0ZW0uYXJndW1lbnRzKSA6IHt9LFxuICAgICAgICB9O1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBwYXJzZSBhcmd1bWVudHMgZm9yICR7aXRlbS5uYW1lfTogJHtlfWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGFzc2lzdGFudENvbnRlbnQsXG4gICAgICB0b29sQ2FsbHMsXG4gICAgICByYXdUb29sQ2FsbHMsXG4gICAgfTtcbiAgfVxufVxuIl19